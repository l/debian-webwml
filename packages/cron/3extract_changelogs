#!/bin/bash
# Copyright 2003 Noel Köthe
# Copyright 2004 Martin Schulze <joey@debian.org>

. `dirname $0`/../config.sh
 
if test -z "${localdir}"; then
    echo skipping due to missing local archive
    exit 1
fi

logs=$topdir/files/logs
log=${logs}/changelogs.log

test -d $log || mkdir -p $logs

if [ -s $log ]
then
    savelog -c 14 $log > /dev/null
fi

(
date

for DEBFILE in ${localdir}/pool/*/*/*/*.dsc; do
    
    TARGET=`echo $DEBFILE|perl -pe "s,^${localdir}/(.*)/.*.dsc,\1,"`
    PACKAGE=`basename "$DEBFILE" .dsc`
    TARGETDIR=${htmldir}/changelogs/$TARGET/$PACKAGE
    
# debugging
#echo $DEBFILE
#echo $TARGET
#echo $PACKAGE
#echo $TARGETDIR
    
# If the target directory doesn't exist yet or
# if the DEBFILE is newer than the target directory,
# unpack the package
    if [ ! -d $TARGETDIR -o $DEBFILE -nt $TARGETDIR ]; then
	
	
	test -d $tmpdir || mkdir -p $tmpdir
	cd ${tmpdir}
	chmod -f -R +w ${tmpdir}/*
	rm -rf ${tmpdir}/*
	out=`dpkg-source -x $DEBFILE`
	dir=${out##* }

	if [ -f ${dir}/debian/copyright -o -f ${dir}/debian/changelog ]
	then
	    test -d $TARGETDIR || mkdir -p $TARGETDIR/

	    if [ -f ${dir}/debian/copyright ]
	    then
		mv */debian/copyright $TARGETDIR/
	    else
		echo "No copyright found in `basename $DEBFILE`"
	    fi
	    if [ -f ${dir}/debian/changelog ]
	    then
		mv */debian/changelog $TARGETDIR/
	    else
		echo "No changelog found in `basename $DEBFILE`"
	    fi

	    chmod -f 644 $TARGETDIR/*
	else
	    echo "No copyright and changelog found in `basename $DEBFILE`"
	fi
	
	chmod -f -R +w ${tmpdir}/*
	rm -rf ${tmpdir}/*
    fi
done

date
) > $log
