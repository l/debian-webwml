#! /bin/bash

. `dirname $0`/../config.sh

flatdir=${filesdir}/flat
test -d ${flatdir} || mkdir -p ${flatdir}

cd ${archivedir}

# Main Archive
#
for dist in ${dists} experimental
do
    test -d ${flatdir}/${dist} || mkdir -p ${flatdir}/${dist}
    cd us/${dist}
    foo=\$arch_${dist//-/_}
    for arch in `eval echo $foo`
    do
	for part in ${parts}
	do
	    if [ -f ${part}/binary-${arch}/Packages.gz ]
	    then
		test -d ${flatdir}/${dist}/${part} || mkdir -p ${flatdir}/${dist}/${part}
		$bindir/flatten-db \
		    --db ${part}/binary-${arch}/Packages.gz \
		    --descr ${flatdir}/${dist}/${part}/Description.tmp \
		    --sections ${flatdir}/${dist}/${part}/Section.tmp \
		    --packages ${flatdir}/${dist}/${part}/Packages-${arch}.us.db \
		    --output ${flatdir}/${dist}/${part}/Packages-${arch}.us
	    fi
       done
    done
   cd ${archivedir}
done

# non-US
#
for dist in oldstable
do
    test -d ${flatdir}/${dist} || mkdir -p ${flatdir}/${dist}
    cd non-US/${dist}
    foo=\$arch_${dist//-/_}
    for arch in `eval echo $foo`
    do
	for part in ${parts}
	do
	    if [ -f ${part}/binary-${arch}/Packages.gz ]
	    then
		test -d ${flatdir}/${dist}/${part} || mkdir -p ${flatdir}/${dist}/${part}
		$bindir/flatten-db \
		    --db ${part}/binary-${arch}/Packages.gz \
		    --descr ${flatdir}/${dist}/${part}/Description.tmp \
		    --sections ${flatdir}/${dist}/${part}/Section.tmp \
		    --packages ${flatdir}/${dist}/${part}/Packages-${arch}.non-US.db \
		    --output ${flatdir}/${dist}/${part}/Packages-${arch}.non-US
	    fi
       done
    done
   cd ${archivedir}
done

# updates
#
for dist in oldstable stable
do
    test -d ${flatdir}/${dist} || mkdir -p ${flatdir}/${dist}
    cd security/${dist}
    foo=\$arch_${dist//-/_}
    for arch in `eval echo $foo`
    do
	for part in ${parts}
	do
	    if [ -f ${part}/binary-${arch}/Packages.gz ]
	    then
		test -d ${flatdir}/${dist}/${part} || mkdir -p ${flatdir}/${dist}/${part}
		$bindir/flatten-db \
		    --db ${part}/binary-${arch}/Packages.gz \
		    --descr ${flatdir}/${dist}/${part}/Description.tmp \
		    --sections ${flatdir}/${dist}/${part}/Section.tmp \
		    --packages ${flatdir}/${dist}/${part}/Packages-${arch}.security.db \
		    --output ${flatdir}/${dist}/${part}/Packages-${arch}.security
	    fi
       done
    done
   cd ${archivedir}
done

# volatile
#
#for dist in stable testing
#do
#    test -d ${flatdir}/${dist} || mkdir -p ${flatdir}/${dist}
#    cd volatile/${dist}
#    foo=\$arch_${dist//-/_}
#    for arch in `eval echo $foo`
#    do
#	for part in ${parts}
#	do
#	    if [ -f ${part}/binary-${arch}/Packages.gz ]
#	    then
#		test -d ${flatdir}/${dist}/${part} || mkdir -p ${flatdir}/${dist}/${part}
#		$bindir/flatten-db \
#		    --db ${part}/binary-${arch}/Packages.gz \
#		    --descr ${flatdir}/${dist}/${part}/Description.tmp \
#		    --sections ${flatdir}/${dist}/${part}/Section.tmp \
#		    --output ${flatdir}/${dist}/${part}/Packages-${arch}.volatile
#	    fi
#       done
#    done
#   cd ${archivedir}
#done


# debian-installer
#
for dist in stable testing unstable
do
    test -d ${flatdir}/${dist} || mkdir -p ${flatdir}/${dist}
    cd us/${dist}
    foo=\$arch_${dist//-/_}
    for arch in `eval echo $foo`
    do
      if [ -f main/debian-installer/binary-${arch}/Packages.gz ]
	  then
	  test -d ${flatdir}/${dist}/main || mkdir -p ${flatdir}/${dist}/main
	  $bindir/flatten-db \
	      --db main/debian-installer/binary-${arch}/Packages.gz \
	      --descr ${flatdir}/${dist}/main/Description.tmp \
	      --sections ${flatdir}/${dist}/main/Section.tmp \
	      --packages ${flatdir}/${dist}/${part}/Packages-${arch}.installer.db \
	      --output ${flatdir}/${dist}/main/Packages-${arch}.installer
      fi
    done
   cd ${archivedir}
done

for dist in ${dists} experimental
do
    for part in ${parts}
    do
      mv ${flatdir}/${dist}/${part}/Description.tmp \
	  ${flatdir}/${dist}/${part}/Description
      mv ${flatdir}/${dist}/${part}/Section.tmp \
	  ${flatdir}/${dist}/${part}/Section
    done
done
