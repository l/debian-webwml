<?
  session_start();
  session_name("GPG-Coord");
  session_unregister("s_username");
  include("gpgconfig.inc");
  include("common.inc");

?>
#use wml::gpgpage title="GPG Signing Coordination - Register"

<?

if ($email) {
     if ($passwd != $passwd2) {
         echo "Passwords do not match, please try again";
     } else {
         if (! ($db = open_db())) {
             return FALSE;
         }

         $sql = "SELECT id FROM people WHERE email = '$email'";
         if (! ($result = pg_exec($db, $sql))) {
             echo "Problem with query", pg_ErrorMessage($db), "<BR>";
             return FALSE;
         }
         if (pg_NumRows($result) > 0) {
             echo "That e-mail address is in the database already.";
             return FALSE;
         }

         if ($offer == "on") {
             $offer = "TRUE";
         } else {
             $offer = "FALSE";
         }

         $now = strftime('%Y-%m-%d');
         $sql = "INSERT INTO people (forename, surname, email, passwd, offer, last_update) VALUES ('$forename', '$surname', '$email', '$passwd', $offer, '$now')";
         if (! ($result = pg_exec($db, $sql))) {
             echo "Problem with query", pg_ErrorMessage($db), "<BR>";
             return FALSE;
         } else {
             echo "OK, you have been registered.";

             $s_username = $email;
             session_register("s_username");

             echo " Click <A href=\"gpgmain.php?\""; ?><?=SID?><?
             echo ">here</A> to add new entries.";
         }

     }
} else {
<protect>
    echo "<div align=\"center\">\n", "<FORM method=\"post\" action=\"gpgregister.php\">\n",
         "<TABLE summary=\"\">\n",
         "<TR><TD><B>Forename</B></TD><TD><INPUT name=\"forename\" type=\"text\"></TD></TR>",
         "<TR><TD><B>Surname</B></TD><TD><INPUT name=\"surname\" type=\"text\"></TD></TR>",
         "<TR><TD><B>E-mail:</B></TD><TD>",
         "<INPUT name=\"email\" type=\"text\"></TD></TR>",
         "<TR><TD><B>Password:</B></TD><TD> <INPUT name=\"passwd\" type=\"password\"></TD> (Note that password are stored and transmitted unencrypted.</TR>",
         "<TR><TD><B>Password (again):</B></TD><TD> <INPUT name=\"passwd2\" type=\"password\"></TD></TR>",
         "<TR><TD><B>Offer to sign key</B></TD><TD><INPUT name=\"offer\" type=\"checkbox\"></TD> (If you are a Debian developer, click here; if you are looking for a GPG signature, do not click here)</TR>",
         "<TR><TD> </TD><TD><INPUT type=\"submit\" value=\"Login\"></TD></TR>",
         "</TABLE>\n</FORM>\n</CENTER>\n";
</protect>
}

?>

