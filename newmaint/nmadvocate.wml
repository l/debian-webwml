<?
  include("config.inc");
  include("common.inc");

  function find_applicant($db, $email) {
  global $row;
  $sql = "SELECT * from applicant WHERE email='$email'";
  if (! ($query = pg_exec($db, $sql))) {
    echo "Problem with query", pg_ErrorMessage($db), "<BR>";
    return FALSE;
  }
  if ( pg_numRows($query) < 1) {
    echo "Could not find $email in the database.  You can find a full list of applicants <A href=\"nmlist.php\">here</A>.<BR>";
    return FALSE;
  }
  $row = pg_Fetch_Array($query, 0);
  return TRUE;
}
  function update_db($db, $sql) {
  if (! ($result = pg_exec($db, $sql))) {
    echo "Problem with query", pg_ErrorMessage($db), "<BR>";
    return -1;
  }
  if (($tuples = pg_CmdTuples($result)) != 1) {
    echo "Only one row should be effected but $tuple rows were<BR>\n";
  }
  return $tuples;
}
  function email_advocate($advocate, $aemail, $forename, $surname, $key) {
    $body = "Auth-Key: $key\n";
    $body .= "Applicant: $forename $surname <$aemail>\n\n";
    $body .= "Comment why you advocated this person, 5-10 lines (note: this comment might\n";
    $body .= "be cited on a public mailing list):\n";
    $body .= "\n";
    $body .= "\n";
    $body .= "This is an automated message from the Debian New Maintainer website.\n\n";
    $body .= "Someone (possibly you) from the IP address " .  getenv(REMOTE_ADDR) . "\n";
    $body .= "nominated the Debian maintainer with the login \"$advocate\" as an advocate\n";
    $body .= "for $forename $surname's application.\n\n";
    $body .= "If you want to complete the advocacy process reply to this email, answer\n";
    $body .= "the question above and GPG sign it. Please also make sure to include the\n";
    $body .= "Auth-Key (listed above) in your GPG signed reply.\n\n";
    $body .= "If you do not want to advocate this application or do not know what it\n";
    $body .= "means, just ignore this email.\n\n";

    $headers = "From: recommend@nm.debian.org\nReply-To: recommend@nm.debian.org\nX-Mailer: PHP/" . phpversion();
    mail("$advocate@debian.org", "Advocate key for $forename $surname <$aemail>", $body, $headers);
    return TRUE;
  }

?>
#use wml::nmpage title="Debian New Maintainer - Applicant Advocate"
<?
  $email = trim(strip_tags($email));
  if ( ($db = open_db())) {
  if ($what == "") { #blank
    if (find_applicant($db, $email)) {
?>
<H1>Advocate Page for applicant: <? echo $row["forename"], " ", $row["surname"], " &lt;", $row["email"], "&gt;"; ?> </H1><BR>

<P>This page is used to advocate a NM application.  When you enter in your
Debian login you will receive an email which you will have to reply and
sign.</P>

<P>Before you advocate an applicant, please read the <A HREF =
"http://www.debian.org/devel/join/nm-advocate">guidelines</A>.  Please
advocate an applicant only if you are <I>sure</I> that he or she is
prepared and capable to become a Debian Developer.</P>

<P>
<FORM method="post" action="nmadvocate.php">
<INPUT name="what" type="hidden" value="send">
<INPUT name="email" type="hidden" value="<? echo $email; ?>">
Debian login: <INPUT name="advocate" type="text" size="16"> @debian.org
<INPUT name="Email" type="submit">
</FORM>
<?
  } else { #Cannot find applicant
?>
  <P><FONT color="#ff0000"><B>Cannot find applicant <? echo $email; ?> </B></FONT>
<? } #canot find applicant
  } # blank what
  if ($what == "send") {
    $authid = "nmauth" . md5(uniqid( rand()));
    $sql = "UPDATE applicant SET advocate='$advocate', advocate_key = '$authid', advocate_date = 'now'::date WHERE email = '$email'";
    if (update_db($db, $sql)) {
      #send the email
      email_advocate($advocate, $email, $row["forename"], $row["surname"], $authid);
?>
<P>An email has been sent to your address, <? echo $advocate; ?>@debian.org.
You have to GPG sign this email and reply to it to complete the advocacy step.
<?
    } else {
      echo "<P><FONT color=\"#ff0000\"><B>Problem updating database.</B></FONT>\n";
    }
  } # send what    
  } # open_db
?>
