#use wml::debian::template title="Configurar un buildd" BARETITLE="true"
#use wml::debian::translation-check translation="1.7" maintainer="Fernando Cerezal"

<p>Aquí encontrará una página de trucos para configurar un buildd para Debian.
Este documento lo escribió Andreas Barth mientras configuraba buildds para
experimental y backports.org así que puede no ser totalmente consistente a la
configuración de Debian usada por las máquinas del desarrollador como 
autoconstructores.</p>

<p>Para buildd puede usar el alojado en db.debian.org o extraerlo 
desde las fuentes de 
<a href="http://svn.cyberhqz.com/svn/wanna-build/">wanna-build</a>. 
Si quiere usar la versión de db.debian.org añada 
<tt>deb http://db.debian.org debian-admin/</tt> a su sources.list e 
instale buildd.</p>

<p>Adicionalmente necesitará un debootstrap actual para poder configurar 
entornos enjaulados en sarge y sid. Así que puede necesitar uno portado 
para esto. Puede obtenerlo desde un repositorio de portados o sencillamente
reconstruirlo usted mismo a partir del código fuente.</p>

<p>Necesita crear los siguientes directorios (bajo
<tt>/org/buildd/</tt>):</p>
<pre>
install -d build mqueue -o buildd -g buildd
install -d chroots -m 755
install -d logs stats -o buildd -g buildd
install -d secret -o buildd -g adm -m 2770
install -d /var/debbuild/srcdep-lock -o buildd
install -d /var/lib/sbuild/srcdep-lock -o buildd
install -d chroots/sid/var/debbuild/srcdep-lock -o buildd
install -d chroots/sid/build/buildd -m 777
install -d chroots/woody-backports/var/debbuild/srcdep-lock -o buildd
install -d chroots/woody-backports/build/buildd -m 777
install -d bin -o buildd -g adm -m 775
cp /etc/passwd chroots/sid/etc/
cp /etc/passwd chroots/woody-backports/etc/
ln -s source-dependencies-unstable /etc/source-dependencies-sid-nonfree
sudo ln -s source-dependencies-stable /etc/source-dependencies-woody-backports.org
</pre>

<p>Y entonces hacer los entornos enjaulados:</p>
<pre>
sudo debootstrap --variant=buildd sid chroots/sid http://ftp.debian.org/debian
sudo ln -s /org/buildd/chroots/sid/ build/chroot-unstable
</pre>

<p>Una vez hecho esto actualice e instale los paquetes necesarios:</p>
<pre>
sudo chroot chroots/sid apt-get update
sudo chroot chroots/sid apt-get install fakeroot build-essential sudo debfoster
sudo chroot chroots/sid debfoster
</pre>

<p>también para los portados de woody:</p>
<pre>
sudo debootstrap --variant=buildd woody chroots/woody-backports http://ftp.debian.org/debian
sudo ln -s /org/buildd/chroots/woody-backports/ build/chroot-woody-backports.org
</pre>
<p>Vamos a editar
<tt>chroots/woody-backports/etc/apt/sources.list</tt></p>
<pre>
deb http://ftp.debian.org/debian woody main non-free contrib
deb-src http://ftp.debian.org/debian woody main non-free contrib
deb-src ftp://linux.mathematik.tu-darmstadt.de/pub/linux/distributions/debian-backports/debian woody all
</pre>
<p>Y vamos a actualizar e instalar cosas:</p>
<pre>
sudo chroot chroots/woody-backports apt-get update
sudo chroot chroots/woody-backports apt-get install fakeroot build-essential sudo debfoster
sudo chroot chroots/woody-backports debfoster
</pre>

<p>Vale, creemos .sbuildrc:</p>
<pre>
# Mail address where logs are sent to (mandatory, no default!)
$mailto = 'donde quiera';

# Maintainer name to use in .changes files (mandatory, no default!)
$maintainer_name='lo que debería aparecer en cambios';

#$fakeroot='/usr/bin/sudo';
$fakeroot='/usr/bin/fakeroot';

%dist_order = ( 'oldstable-security' => 0, stable => 1, 'stable-security' => 1, testing => 2, 'testing-security' => 2, unstable => 3, 'woody-backports.org' => 5, 'sarge-backports.org' => 6, experimental => 7 );
</pre>

<p>No olvide añadir al usuario buildd al archivo de configuración de sudo
de forma que pueda ejecutar herramientas sin restricción.</p>


<p>Bien, probemoslo ahora: Vayamos a ~buildd/build, y contruyamos un 
paquete:</p>
<pre>
sbuild -d unstable -v netpbm-nonfree_2:9.20-2
sbuild -d woody-backports.org -v arj_3.10.19-1.backports.org.1
</pre>

<p>Añadamos <tt>|/usr/bin/buildd-mail-wrapper</tt> a
~buildd/.forward, para que podamos responder a los correos de buildd.</p>

<p>También tiene que afinar ~buildd/buildd.conf - pero lo siento, no hay
trucos para eso, ya que depende de su wanna-build.</p>

<p>Puede obtener más información sobre los detalles de los estados de buildd
<a href="wanna-build-states">aquí</a>.
Debería responder a los correos de buildd o con el archivo changes firmado,
o con "give-back", "retry", "dep-wait", o "failed", o "dep-wait 
&lt;dependencias&gt;" o "failed\n&lt;porqué falló&gt;".</p>

<p>Puede usar las siguientes tareas como tareas del cron:</p>
<pre>
@reboot        touch ~buildd/NO-DAEMON-PLEASE
17 * * * * /usr/bin/buildd-watcher
47 * * * * /usr/bin/buildd-uploader
</pre>
