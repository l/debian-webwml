#use wml::debian::template title="Configurar un servidor push"
#use wml::debian::translation-check translation="1.17"
#use wml::debian::toc

<p>Configurar un servidor push consiste en dos tareas básicas: configurar
el acceso rsync (el normal, para replicación <q>pull</q>) y configurar los
mecanismos de activación por ssh (para hacer <q>push</q> a la replicación pull).</p>

<p><small>(Para más información sobre lo que es un servidor push, lea
<a href="push_mirroring">la explicación de la replicación push</a>.)</small></p>

<toc-display />

<toc-add-entry name="rsync">Configurando rsync</toc-add-entry>

<p>Instale <code>rsync</code> 2.1.1 o superior. Si su sitio está ejecutando
Debian, sólo instale el último paquete de
<a href="http://packages.debian.org/stable/net/rsync">rsync</a>.</p>

<p>Cree el archivo <code>rsyncd.conf</code> y ponga algo similar a esto
en él:</p>

<pre>
uid = nobody
gid = nogroup
max connections = 25
socket options = SO_KEEPALIVE

[debian]
  path = /svr/debian/mirror
  comment = Archivo FTP de Debian (~250 GB)
  auth users = authorized_account1,authorized_account2,authorized_accountN
  read only = true
  secrets file = /etc/rsyncd/debian.secrets
</pre>

<p>Añada una entrada para cada sitio del que esté haciendo push en el archivo
<code>/etc/rsyncd/debian.secrets</code>:</p>

<pre>
authorized_account1:una_contraseña
authorized_account2:otra_contraseña
authorized_accountN:contraseña
</pre>

<p>Ahora ha dado acceso a los sitios de réplica de flujo de bajada al archivo
de su máquina.</p>

<p>Probablemente quiere iniciar el demonio rsync desde inetd. Para hacer esto,
tiene que añadir el servicio en el archivo <code>/etc/services</code> (si no
está ya allí), algo así como:</p>

<pre>
rsync           873/tcp
</pre>

<p>Para activar el demonio desde inetd, añada lo siguiente a su archivo
<code>/etc/inetd.conf</code>:</p>

<pre>
rsync      stream      tcp         nowait      root /usr/bin/rsync rsyncd --daemon
</pre>

<p>
(Recuerde enviar a inetd una señal HUP para decirle que vuelva a leer su
archivo de configuración tras modificar el archivo.)
</p>

<toc-add-entry name="sshtrigger">Configurando el mecanismo de disparo de ssh</toc-add-entry>

<p>Cree una nueva clave ssh para la cuenta que va a usar réplica de Debian.
Asegúrese de que no sobreescribe su clave original ssh usando la opción -f,
por ejemplo:</p>

<pre>
ssh-keygen -f ~/.ssh/identidad.misitio
</pre>

<p>Asegúrese de que la nueva clave pública (~/.ssh/identidad.misitio.pub)
contiene esto al inicio:</p>

<pre>
no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty,command="~/sync &amp;"
</pre>

<p>Necesita configurar un script que contacte con los sitios de réplica
de flujo de bajada. Cree un archivo llamado <code>signal</code> que
contenga esto:</p>

<protect>
<pre>
#!/bin/sh

# This script is called to signal the remote host that it is time to
# mirror the archive.

echo Signalling $1
ssh -o"BatchMode yes" -o"user $2" "$1" -i $HOME/.ssh/identity.mysite sleep 1
</pre>
</protect>

<p>Este script entrará a una máquina remota usando la clave ssh especial que
creó antes, proporcionada para que cada operador de réplica la añada a su
propio ~/.ssh/authorized_keys (reemplazando también <q>sync</q> por <q>anonftpsync</q> o como se llame su script para iniciar la replicación). El script por sí mismo no hará nada útil remotamente, la única orden que se ejecutará es la que se ha especificado en la configuración de la clave.</p>

<p>Realmente, para señalizar a las réplicas, necesita añadir las líneas
<code>./signal &lt;sitio&gt; &lt;usuario&gt;</code> tras la ejecución de rsync.
Así, en cuanto su sitio haya terminado de replicarse del sitio fuente, 
empezará a lanzar la replicación de los que repliquen de usted.
</p>

<p>Puede emplazar estas órdenes o al final de su script <code>anonftpsync</code> o, si lo cree más conveniente, en otro script y ejecutar este desde <code>anonftpsync</code>, por ejemplo:</p>

<protect>
<pre>
#!/bin/sh

# Este script es llamado por websync para señalizar las réplicas de bajada.

./signal some.other.site archvsync
./signal and.another.site othersiteaccount
</pre>
</protect>

<p>Entonces, tan pronto como su sitio haya finalizado de replicar desde el
sitio del flujo de subida, iniciará el proceso de push a aquellos flujos
de bajada que tenga.

<p>Si tiene algún problema con esto,
<a href="mailto:mirrors@debian.org">\ póngase en contacto con nosotros</a>.</p>
