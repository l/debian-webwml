#use wml::debian::template title="Configurar un servidor push"
#use wml::debian::translation-check translation="1.12"

<p>Configurar un servidor push consiste en dos tareas básicas: configurar
el acceso rsync (el normal, para replicación "pull") y configurar los
mecanismos de disparo ssh (para hacer "push" a la replicación pull).

<p><small>(Para más información sobre lo que es un servidor push, lea
<a href="push_mirroring">la explicación de la replicación push</a>.)</small>

<h2>Configurando rsync</h2>

<p>Instale <code>rsync</code> 2.1.1 o superior. Si su sitio está ejecutando
Debian, sólo instale el último paquete de
<a href="http://packages.debian.org/stable/net/rsync">rsync</a>.

<p>Cree el archivo <code>rsyncd.conf</code> y ponga algo similar a esto
en él:

<pre>
uid = nobody
gid = nogroup
max connections = 25
syslog facility = daemon
socket options = SO_KEEPALIVE

[debian]
  path = /org/ftp.debian.org/ftp
  comment = Archivo FTP de Debian (~24 GB)
  auth users = authorized_account1,authorized_account2,authorized_accountN
  read only = true
  secrets file = /etc/rsyncd/debian.secrets
[debian-web]
  path = /org/www.debian.org/debian.org
  comment = Sitio Web de Debian (~400 MB)
  auth users = authorized_account1,authorized_account2,authorized_accountN
  read only = true
  secrets file = /etc/rsyncd/debian.secrets
</pre>

Añada una entrada para cada sitio del que esté haciendo push en el archivo
<code>/etc/rsyncd/debian.secrets</code>:

<pre>
authorized_account1:una_contraseña
authorized_account2:otra_contraseña
authorized_accountN:contraseña
</pre>

<p>Ahora ha dado acceso a los sitios de réplica de flujo de bajada al archivo
de su máquina.

<p>Probablemente quiere iniciar el demonio rsync desde inetd. Para hacer esto,
tiene que añadir el servicio en el archivo <code>/etc/services</code> (si no
está ya allí), algo así como:

<pre>
rsync           873/tcp
</pre>

Para activar el demonio desde inetd, añada lo siguiente a su archivo
<code>/etc/inetd.conf</code>:

<pre>
rsync      stream      tcp         nowait      root /usr/bin/rsync rsyncd --daemon
</pre>

(Recuerde enviar a inetd una señal HUP para decirle que vuelva a leer su
archivo de configuración tras modificar el archivo.)

<h2>Configurando el mecanismo de disparo de ssh</h2>

<p>Cree una nueva clave ssh para la cuenta que va a usar réplica deDebian.
Asegúrese de que no sobreescribe su clave original ssh usando la opción -f,
por ejemplo:

<pre>
ssh-keygen -f ~/.ssh/identidad.misitio
</pre>

<p>Asegúrese de que la nueva clave pública (~/.ssh/identidad.misitio.pub)
contiene esto al inicio:

<pre>
no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty,command="~/websync &amp;"
</pre>

<p>(reemplace "websync" con "anonftpsync", o "anonftpsync-non-US", o cualquiera
que sea el comando que inicie la llmada a la replicación)

<p>Necesita configurar un script que contacte con los sitios de réplica
de flujo de bajada. Cree un archivo llamado <code>signal</code> que
contenga esto:

<protect>
<pre>
#!/bin/sh

# This script is called to signal the remote host that it is time to
# mirror the archive.

echo Signalling $1
ssh -o"BatchMode yes" -o"user $2" "$1" -i $HOME/.ssh/identity.mysite sleep 1
</pre>
</protect>

<p>Este script entrará a una máquina remota usando la clave ssh especial que
creó arriba. El script no hará nada útil remotamente, el comando ~/websync
(o ~/anonftpsync, o ~/ftpsunc-non-US) se ejecutará desde la clave.

<p>Actualmente, para señalizar a las réplicas, necesita añadir las líneas
<code>./signal &lt;sitio&gt; &lt;usuario&gt;</code> al final de cada script
<code>websync</code>, o si es más conveniente para usted, en un script nuevo,
y luego lanzando ese script desde <code>websync</code>.

<p>Este script nuevo, <code>runmirrors</code>, debería contener algo parecido
a esto:

<protect>
<pre>
#!/bin/sh

# Este script es llamado por websync para señalizar las réplicas de bajada.

./signal some.other.site archvsync
./signal and.another.site othersiteaccount
</pre>
</protect>

<p>Entonces, tan pronto como su sitio haya finalizado de replicar desde el
sitio del flujo de subida, iniciará el proceso de push a aquellos flujos
de bajada que tenga.

<p>Si tiene algún problema con esto,
<a href="mailto:mirrors@debian.org">póngase en contacto con nosotros</a>.
