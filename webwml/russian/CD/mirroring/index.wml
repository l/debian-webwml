#use wml::debian::cdimage title="Как организовать зеркало компакт-дисков Debian" BARETITLE=true
#use wml::debian::toc
#use wml::debian::translation-check translation="1.7"

<p>Чтобы держать зеркало образов CD Debian, вам нужна машина под
управлением Linux или другого клона Unix с постоянным надёжным
подключением к Интернет.</p>

<p>Зеркала, содержащие компакт-диски, обычно хранят шаблоны jigdo.
Некоторые также хранят предварительно собранные полные образы. Шаблоны
обычно обновляются с помощью rsync с <a
href="../jigdo-cd/#which">одного из официальных расположений</a>.
Полные образы обновляются с помощью <kbd>jigdo-mirror</kbd>.</p>

<toc-display/>

<hr>

<toc-add-entry name="httpftp">Почему <strong>не подходят</strong> FTP и HTTP</toc-add-entry>

<p>Вам <em>не следует</em> использовать FTP или HTTP для загрузки образов.
При использовании этих методов очень велика вероятность ошибки из-за
нетипично большого размера файлов.</p>

<p>Более того, если образы изменяются очень незначительно (как в случае
подвыпусков), все данные, тем не менее, загружаются заново. Это создаёт
большую нагрузку на наши компьютеры и сетевые соединения.</p>

<toc-add-entry name="download">Загрузка с помощью rsync</toc-add-entry>

<p>По отмеченным выше причинам мы используем программу <a
href="http://rsync.samba.org/"><tt>rsync</tt></a>, которая, в сущности,
производит удалённое двоичное "наложение заплат". С помощью <tt>rsync</tt>
подвыпуски обновляются очень эффективно, поскольку по сети передаются только
изменения. Неизменные фрагменты копируются из старого образа.</p>

<p>Для сайтов, владельцы которых хотят зеркалировать только образы дисков
Debian (но не остальную часть Debian), и не имеют близлежащего/быстрого
зеркала Debian (<kbd>debian/</kbd>), мы предлагаем использовать
<kbd>rsync</kbd> как ежедневную задачу cron.</p>

<p>Вы можете загружать образы с любого из сайтов <a href="rsync-mirrors">списка
зеркал</a>.</p>

<p>Используйте параметры <strong><kbd>--times --links --hard-links
--block-size=8192</kbd></strong>. При этом будут сохранены время
последнего изменения, символические и жёсткие связи, и будут использоваться
блоки размером 8192 байта (наиболее эффективные для образов CD). Если
время последнего изменения и размер те же самые, <kbd>rsync</kbd>
не будет трогать файл вообще, так что <tt>--times</tt> действительно
надо использовать всегда.</p>

<toc-add-entry name="jigdomirror">Создание образов с помощью jigdo-mirror</toc-add-entry>

<p>Многие люди сопровождают "обычные" зеркала Debian (<kbd>debian/</kbd>),
или просто имеют хорошую связь с таким зеркалом. Это означает, что у них
уже есть файлы .deb, содержащиеся на образах CD. Очевидный вопрос: почему
мы не можем использовать те же самые файлы на образах CD?</p>

<p><kbd>jigdo-mirror</kbd>&nbsp;&mdash; это программа, позволяющая
генерировать образы компакт-дисков Debian, используя файлы "нормального"
зеркала и несколько дополнительных файлов шаблонов jigdo.</p>

<p>Имейте в виду, что программа <kbd>jigdo-mirror</kbd> включена в
jigdo 0.6.8, но эта версия не входит в Debian 3.0 ("woody"). Это означает,
что вы должны загрузить её отдельно. Проблем с использованием новой версии
под "woody" не возникает.</p>

<p>Для начала, вам понадобятся файлы шаблонов jigdo. Их можно загрузить
с большей части официальных сайтов, но два основных их расположения, это:</p>

<ul compact>
  <li><kbd>rsync us.cdimage.debian.org::jigdo-area/</kbd> (зеркало в США)
  <li><kbd>rsync non-us.cdimage.debian.org::jigdo-area/</kbd> (европейское зеркало)
</ul>

<p>Загрузите файлы из подкаталога
&lt;<var>version</var>&gt;/jigdo/&lt;<var>архитектура</var>&gt;
для каждой архитектуры, для которой вы хотите собрать образы.</p>

<p>Создайте файл <kbd>~/.jigdo-mirror</kbd> для конфигурирования программы.
Вот пример:</p>

<pre>
jigdoDir="/where/you/keep/mirrors/debian-cd/current/jigdo"
imageDir="/where/you/keep/mirrors/debian-cd/current/images"
tmpDir="/where/you/keep/mirrors/debian-cd/current/images"
debianMirror="file:/where/you/keep/mirrors/debian"
nonusMirror="file:/where/you/keep/mirrors/debian-non-US"
include='i386/|sparc/|powerpc/|source/'; exclude='-1\.'
</pre>

<p>Переменные <i>include</i> и <i>exclude</i> содержат список
архитектур, для которых вы хотите создать образы (регулярные выражения).
Более подробную информацию см. на странице руководства <kbd>jigdo-mirror</kbd>
или в исходном коде (это скрипт оболочки с обширными комментариями).</p>

<p>После конфигурирования просто запустите <kbd>jigdo-mirror</kbd> и
она сделает всё самостоятельно. Программа выводит на экран большое
количество информации и, вероятно, её работа займёт некоторое время.
Поэтому мы предлагаем вам принять меры (запустить с экрана, но
перенаправить вывод в файл и т.д.).</p>

<toc-add-entry name="pik">Создание образов с помощью инструментария создания псевдообразов и debcdmirror</toc-add-entry>

<p><tt>rsync</tt> сам по себе лишь загружает выпуски как полностью новые,
поскольку эти образы виртуально не содержать неизменных частей. Тем не
менее, с помощью инструментария для создания псевдообразов (pseudo image kit,
PIK) мы можем создать псевдообразы компакт-дисков из данных, уже
доступных на ближайшем ftp-зеркале Debian&nbsp;&mdash; может быть,
на вашем собственном локальном жёстком диске. Затем <tt>rsync</tt>
может превратить эти псевдообразы в официальные образы дисков. Даже
для большинства подвыпусков это более эффективно, чем наложение "заплат"
на старые образы.</p>

<p><strong>Информация в этом разделе может быть устаревшей! Рекомендуется
либо использовать просто rsync, либо опробовать jigdo-mirror.</strong></p>

<p>PIK создан, главным образом, для загрузки лишь одного или небольшого
числа образов, что делают большинство людей. Помимо него существует
скрипт <tt>debcdmirror</tt>, который делает создание зеркал
<em>действительно</em> простым, поскольку автоматически использует PIK
и <tt>rsync</tt> для поддержания зеркала в актуальном состоянии, вплоть
до автоматической проверки контрольных сумм MD5 каждого загруженного
образа. С помощью <tt>debcdmirror</tt> вы также можете указать, что
именно вы хотите зеркалировать.</p>

<p>Ручное использование PIK (может быть, вместе с <tt>rsync</tt>
для обновления подвыпусков) требует большой работы и вызывает много
проблем, поэтому мы не рекомендуем так делать.

<p>Вместо этого вам следует использовать скрипт <tt>debcdmirror</tt>
(который использует "внутри" PIK и <tt>rsync</tt>) в качестве
ежедневной задачи cron).</p>

<p>Последние версии
<a href="http://cdimage.debian.org/~costar/pseudo-image-kit/">инструментария
для создания псевдообразов</a> и скрипта
<a href="http://cdimage.debian.org/~costar/debcdmirror/"><tt>debcdmirror</tt></a>
доступны на домашней странице их автора. Прочесть более полную информацию
можно в файлах README обоих пакетов.</p>

<p><strong>Примечания:</strong>

<p>При использовании скрипта <tt>debcdmirror</tt> вы можете выбрать
зеркало <tt>rsync</tt>, предоставляющее файл "<tt>ls-lR</tt>". Адреса
находятся в <a href="rsync-mirrors">списке зеркал rsync</a>.</p>

<p>Если у вас нет локального <a href="$(HOME)/mirror/">"обычного"
ftp-зеркала Debian</a>, посмотрите <a href="$(HOME)/mirror/list">список
зеркал</a>.</p>

<p><tt>debcdmirror</tt> требует <tt>bash</tt> версии 2 или более поздней.
Для любой современной системы Debian это не проблема. Если это необходимо,
вы можете установить её в каталог, отличный от положения по умолчанию,
но затем обязательно удостоверьтесь в том, что изменили путь к <tt>bash</tt>
в первой строке скрипта.</p>

<toc-add-entry name="test">Тестовые образы</toc-add-entry>

<p>Каталоги "<tt><i>codename</i>_test</tt>" содержат образы, жёстко
связанные с образами в каталогах по версиям (например, <tt>2.2_r4</tt>).
Название каталога по версии изменяется при появлении нового (под)выпуска,
но имена в каталогах "<tt>test</tt>" остаются теми же самыми.</p>

<p>Таким образом, при использовании только <tt>rsync</tt> единственным
способом правильного обновления подвыпусков является зеркалирование как,
каталогов по версиям, так и подходящих каталогов "<tt>test</tt>",
<em>и</em> использование параметра <tt>--hard-links</tt> rsync.
[Вам <em>не следует</em> включать каталоги "<tt>test</tt>" в список
каталогов <tt>debcdmirror</tt>, потому что <tt>debcdmirror</tt>
работает по-другому, более эффективно.]</p>

<toc-add-entry name="ls-lR">Файлы ls-lR</toc-add-entry>

<p>Файл <tt>ls-lR</tt> описывает структуру каталогов зеркала, на котором
он находится. <strong>Не зеркалируйте</strong> файл <tt>ls-lR</tt>,
вместо этого либо создайте собственный (с помощью "<tt>Makels-lR</tt>",
ежечасно через <tt>cron</tt>) или просто не создавайте этот файл вообще.
[<tt>debcdmirror</tt> создаст локальный <tt>ls-lR</tt> автоматически
после создания зеркала.]</p>

<toc-add-entry name="serve">Предоставление файлов</toc-add-entry>

<p>После того, как вы создали образы CD, которые вы хотите хранить на
зеркале (наиболее популярны i386 и исходные тексты), вам следует
запустить сервер <tt>rsync</tt>. Это не слишком загружает машину и
будет создавать гораздо меньший сетевой трафик, чем ftp/http-серверы.</p>

<p>Инструкции по настройке находятся в файле README PIK. Вкратце,
добавьте в конфигурацию <i>inetd</i> <kbd>rsync --daemon</kbd> и
настройте <kbd>rsyncd.conf</kbd> по вашему усмотрению. Мы рекомендуем
ограничить доступ небольшим количеством соединений с одного ip-адреса
и удвоенным числом соединений всего, по большей мере.</p>

# TODO: include more stuff here rather than depending on pik, with examples

<toc-add-entry name="register">Регистрация зеркала в наших списках</toc-add-entry>

<p>Чтобы сделать ваше зеркало полезным широкой аудитории, вы можете
зарегистрировать его в нашем списке зеркал, 
<a href="../http-ftp/">этом</a> или <a href="rsync-mirrors">этом</a>.
Тем не менее, поскольку полные образы очень велики, это может привести
к трафику в несколько гигабайтов в день.</p>

<p>Вы можете зарегистрировать ваше зеркало либо заполнив
<a href="$(HOME)/mirror/submit">форму информации о зеркале</a>
(имейте в виду, что поля CDImage-* очень важны), либо отправив
сообщение по адресу
<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;debian-cd&#64;lists.debian.org">\
debian-cd&#64;lists.debian.org</a>.</p>

<p>Мы будем рады появлению любых новых зеркал образов CD. Заранее благодарим вас!</p>
