#use wml::debian::template title="Настройка зеркала архивов Debian"
#use wml::debian::toc
#use wml::debian::translation-check translation="1.64"
#include "$(ENGLISHDIR)/releases/sid/archive.data"

<toc-display />

<toc-add-entry name="whether">Зеркалировать или нет?</toc-add-entry>

<p>Хотя мы высоко ценим все новые зеркала, каждый будущий держатель зеркала
должен быть уверен, что он может ответить на следующие вопросы, перед тем как
начнёт создавать собственное зеркало:</p>

<ul>
  <li>Нужно ли зеркало в моей местности? Возможно, недалеко уже есть
      зеркало.</li>
  <li>Есть ли у меня ресурсы для содержания зеркала? Зеркала занимают
      значительное дисковое пространство и полосу пропускания,
      зеркало должно оправдывать свою цену.</li>
  <li>Является ли зеркало правильным выбором? Иногда люди ошибочно создают
      зеркало, тогда как они на самом деле хотели запустить кеширующий прокси.</li>
# such as <a href="http://packages.debian.org/apt-proxy">apt-proxy</a>
# not sure if we want to plug just apt-proxy as soon as this -joy, 2007-11-08
</ul>

<toc-add-entry name="what">Что зеркалировать</toc-add-entry>

<p><a href="./">Главная страница зеркала</a> перечисляет архивы, доступные для
зеркалирования.</p>

<ul>
<li>
Пользователи будут искать архив debian/ для установки Debian через сеть,
для создания дисков (с помощью jigdo), и для обновления уже установленных систем.</li>

<li>
debian-cd/&nbsp;&mdash; это архив, который не одинаков для разных серверов зеркал.
На некоторых сайтах он содержит шаблоны jigdo для создания образов дисков (используется
совместно с файлами из debian/), на некоторых он содержит уже созданные образы дисков,
а на некоторых сайтах содержится оба варианта.
<br />
Подробную информацию о зеркалировании смотрите на странице <a href="$(HOME)/CD/mirroring/">\
зеркалирование образов дисков</a>.</li>

<li>
debian-archive/ содержит настоящий <em>архив</em> старых и вышедших из употребления
версий Debian. Главным образом он будет интересен лишь малому числу пользователей.</li>

</ul>

<p>Более точную информацию о размерах зеркала смотрите на странице <a href="size">размер
зеркала</a>.</p>

<p>Архив debian-security/ содержит обновления безопасности, выпущенные командой
безопасности Debian. Он выглядит интересным для каждого, но, в связи с тем, что обновления
безопасности случайны, для того, чтобы оно оставалось современным, достаточно лишь иногда
обновлять его зеркало (или использовать <a href="push_mirroring">проталкивающее
зеркалирование</a>), так что мы не рекомендуем его. Вместо этого Debian делает всё
возможное для поддержки высокой доступности security.debian.org.</p>

<p>Замечание: начиная с выпуска 3.1 (<em>sarge</em>) в июне 2005 года,
архив debian-non-US/ больше не используется.</p>

<toc-add-entry name="wherefrom">Откуда зеркалировать</toc-add-entry>

<p>Многие люди думают, что каноническое расположение пакетов Debian это
<code>ftp.debian.org</code>, и что будет лучше для них зеркалировать именно с этого
сайта. Это <strong>неверно</strong>.</p>

<p><code>ftp.debian.org</code> это лишь один из нескольких серверов, которые
обновляются с внутреннего сервера Debian. В данное время этот адрес находится
на единственном сервере в США, и оставлен лишь для совместимости.</p>

<p>Хорошим местом для зеркалирования являются <a href="official">официальные
зеркала</a>. Для зеркалирования можно выбрать любой сервер из <a
href="list-full">полного списка зеркал</a>, имеющий метки
'<kbd>Type: Push-Primary</kbd>' или '<kbd>Type: Push-Secondary</kbd>'.
Используйте тот из них, который по сетевым меркам и географически ближе к вам.</p>

<p>Нет никакой разницы между разными <em>Push-Primary</em> серверами зеркал,
так как в зеркалировании участвуют все они. С другой стороны, если множество людей
использует ftp.debian.org (а, к несчастью, так оно и есть), это излишне тратит
пожертвованную полосу пропускания.</p>

<p>Администраторы зеркал в США должны зеркалировать с ftp.us.debian.org
(официальный адрес зеркала в США, который является Push-Primary зеркалом).
Но в связи с тем, что этот адрес также является псевдонимом для нескольких
машин, то обычно лучше определить, какой из них лучший и зеркалировать именно
с него.
<br />
<small>Хорошим побочным эффектом этого является избежание риска ошибок при
совершении двухфазного rsync (различные фазы могут окончится на разных
машинах с некоторым временным окном, когда они имеют различные данные, что
вызывает состояние гонки (race condition)). Плохим побочным эффектом этого
является концентрация на единственном сайте, производительность которого
может варьироваться, но это в данное время вообще присуще нашей сети
зеркал.</small></p>

<toc-add-entry name="how">Как зеркалировать</toc-add-entry>

<p>Рекомендуемый метод зеркалирования&nbsp;&mdash; так называемый
<a href="anonftpsync">anonftpsync</a> скрипт.</p>

<p>Протокол зеркалирования, который мы рекомендуем:
<a href="http://packages.debian.org/stable/net/rsync">rsync</a>.</p>

<p>Не зеркалируйте Debian с помощью <kbd>wget</kbd> и других инструментов
для ftp. Они вроде бы хорошо работают, но есть некоторые спорные моменты
(они не могут определять жёсткие ссылки, ими тяжелее делать частичные
зеркала и т.д.).</p>

<h3>Настройка rsync</h3>

<p>Мы рекомендуем использовать <a href="anonftpsync">этот скрипт</a> для
зеркалирования архива. Следуйте направлениям в скрипте для настройки
зеркалирования.</p>

<p>Есть несколько советов для тех, кто предпочитает другие методы:</p>

<ul>
  <li>Запускайте rsync с, как минимум, следующими опциями: <kbd>--recursive --times
      --links --hard-links --delete</kbd>.</li>

  <li>Избегайте зеркалирования индексных файлов (Packages, Sources, и т.п.) до
      того как все новые файлы данных (.deb, .orig.tar.gz, и т.п.) не будут
      на месте.  Используйте две стадии rsync&nbsp;&mdash; в первой скачивайте
      файлы данных, исключая индексные файлы, а затем всё остальное.
      <br/>
      Пропустить в первой стадии файлов Packages*, Sources* и Release* можно
      используя опцию <kbd>--exclude</kbd> или скачивая только поддиректорию
      pool/.
      Смотрите, например, <a href="anonftpsync">наш скрипт</a>.</li>

  <li>Если у вас достаточно дискового пространства, используйте также опцию
      <kbd>--delete-after</kbd>, для избежания некоторых временных проблем обновления.</li>

  <li>Если у вас недостаточно дискового пространства для зеркалирования всего, используйте
      опцию <kbd>--exclude</kbd> для исключения от зеркалирования частей архива.
      Обычно туда можно включить различные архитектуры, которые вам не желательны, так как
      они занимают много места.
      Смотрите <a href="#partial">секцию о частичном зеркалировании</a>.</li>

  <li>После того, как rsync завершит зеркалирование, добавьте файл с именем вашего сервера
      с отметкой времени в поддиректорию <code>project/trace/</code> зеркала Debian.
      Это предполагает запуск
      <kbd>date -u &gt; .../debian/project/trace/<var>ваш.сервер</var></kbd>
      после того, как ежедневный rsync завершён.</li>

  <li>Мы строго советуем не исключать <tt>project/</tt>, <tt>doc/</tt>
      и другие поддиректории. Обычно они невелики в размерах, но всё же полезны пользователям.
      Особенно очень помогает <tt>project/trace</tt>, если имеются какие-либо проблемы с
      зеркалом.</li>
  <li>Обычно вышестоящие серверы rsync позволяют анонимный доступ.
      Если они требуют идентификацию, установите имя пользователя и пароли
      в вашем скрипте, либо через переменную среды RSYNC_PASSWORD, либо
      с помощью опции <kbd>--password-file</kbd>.</li>
</ul>

<toc-add-entry name="partial">Частичное зеркалирование</toc-add-entry>

<p>Посмотрев на уже <a href="size">большой размер архива Debian</a>, некоторые
люди предпочитают зеркалировать только те его части, которые им нужны. Если вы хотите
исключить что-то, вы должны исключать архитектуры.</p>

<p>С <a href="anonftpsync">anonftpsync</a> это может быть сделано редактированием
переменной ARCH_EXCLUDE.</p>

<p>Мы строго советуем не исключать <tt>project/</tt>, <tt>doc/</tt>
и другие поддиректории. Обычно они невелики в размерах, но всё же полезны пользователям.
Особенно очень помогает <tt>project/trace</tt>, если имеются какие-либо проблемы с
зеркалом.
</p>

<p>Можно использовать другие, специально написанные скрипты, но обычно в этом нет
необходимости и не рекомендуется для официальных зеркал.
Например, этот набор опций исключит <em>все</em> архитектуры:
<br />
<: 
print "<code>--exclude binary-$_/ --exclude *_$_.deb --exclude *_$_.udeb --exclude installer-$_/ --exclude Contents-$_*</code><br>\n"
  foreach (sort keys %arches);
:>

<toc-add-entry name="when">Когда зеркалировать</toc-add-entry>

<p>Главный архив обновляется дважды в день.
Зеркала обычно начинают обновляться около 9:00 и 21:00 (оба времени по UTC),
но это не фиксированное время, и вы не должны опираться на эти времена при
зеркалировании.</p>

<p>Мы рекомендуем зеркалировать один раз ежедневно. Зеркалирование более двух
раз в сутки бесполезно и может привести к тому, что вас заблокируют &mdash;
никогда этого не делайте.</p>

<p>Ваше зеркало должно обновляться спустя несколько часов после начала
обновления главного зеркала.
Вы должны проверить, оставил ли сайт, с которого вы зеркалируете, файл с
отметкой времени в его поддиректории <kbd>project/trace/</kbd>. Файл с отметкой
времени будет назван как сайт, и он будет содержать полное время последнего обновления
его зеркала. Добавьте пару часов к этому времени (для уверенности) и затем зеркалируйте.</p>

<p>Самый лёгкий путь автоматически ежедневно запускать зеркалирование, это использовать cron.
Детали смотрите в <kbd>man crontab</kbd>.</p>

<p>Учтите, что если ваш сайт настроен на работу с проталкивающим механизмом, вам нет
необходимости беспокоиться обо всём этом.</p>

<h3>Проталкивающее зеркалирование</h3>

<p><q>Проталкивающее</q> зеркалирование&nbsp;&mdash; это форма зеркалирования, которую мы
для уменьшения времени, занимаемого на изменения в архиве достигли зеркал.
Сервер зеркала использует триггер SSH, чтобы сказать клиентскому зеркалу обновить себя.
<q>Проталкивание</q> обычно ограничено безопасным триггером, которому не нужно
переменных данных, так что процесс зеркалирования&nbsp;&mdash; это простое
<q>вытягивание</q>, как с помощью задачи cron.</p>

<p>Проталкивающее зеркалирование необходимо для сохранения синхронизации множества
серверов (серверов с DNS системой имён, подобных <tt>ftp.us.debian.org</tt>),
и мы обычно используем его для наших первых и вторых скрепляющих зеркал. Для <q>нормальных</q>
зеркал этот метод требует множество усилий для настройки, которые на самом деле не
оправдываются по сравнению с хорошо отлаженной работой cron.</p>

<p>Более подробное описание того, как это работает, почему оно безопасно и как
настроить проталкивающее зеркалирование, смотрите в <a href="push_mirroring">полном
разъяснении</a>.</p>

<toc-add-entry name="settings">Рекомендуемые добавочные установки</toc-add-entry>

<p>Если вы собираетесь сделать зеркало Debian доступным через HTTP, добавьте следующие
настройки в вашу конфигурацию Apache (конечно, подразумевается, что вы будете использовать
Apache), в пределах блока
<code>&lt;Directory <var>/path/to/your/debian/mirror</var>&gt;</code>,
Где <var>/path/to/your/debian/mirror</var> должно быть актуальным именем
директории, где вы храните зеркало:</p>

<pre>
   Options +Indexes +SymlinksIfOwnerMatch
   IndexOptions NameWidth=* +SuppressDescription
</pre>

<p>Это включит индексирование директорий и даст уверенность, что будет работать
следование символьным ссылкам. Имена файлов в директории индексов не будут обрезаться, и
а описания, обычно несуществующие, показываться не будут.</p>

<p>Кроме того, для Apache 1.3.x должна быть добавлена следующую опцию:</p>

<pre>
   DirectoryIndex .
</pre>

<p>Не добавляйте эту опцию для Apache 2.x.</p>

<toc-add-entry name="submit">Как добавить зеркало в список зеркал</toc-add-entry>

<p>Как только зеркало настроено, оно должно быть <a
href="submit">зарегистрировано в Debian</a> для добавления его в <a
href="list">список зеркал</a>. Для подачи заявки используется <a
href="submit">простая веб-форма</a>.</p>

<p>Вопросы и о проблемах можно писать на <email mirrors@debian.org>.</p>
