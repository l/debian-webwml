#use wml::debian::template title="Konfiguracja serwera push"
#use wml::debian::toc
#use wml::debian::translation-check translation="1.17"

<p>Konfigurowanie serwera w metodzie push sk³ada siê z dwóch
podstawowych kroków: skonfigurowania dostêpu przez rsync (jak dla normalnego
tworzenia serwera lustrzanego, typu <q>pull</q>) oraz skonfigurowania
mechanizmu <q>spustowego</q> ssh (aby umo¿liwiæ inicjowanie tworzenia
serwera lustrzanego metod± push).</p>

<p><small>(Aby uzyskaæ wiêcej informacji na temat serwerów
push przeczytaj
<a href="push_mirroring">wyja¶nienie tworzenia serwerów lustrzanych
metod± push</a>.)</small></p>

<toc-display />

<toc-add-entry name="rsync">Konfiguracja rsync</toc-add-entry>

<p>Zainstaluj <code>rsync</code> 2.1.1 lub nowszy. Je¶li Twój serwer
u¿ywa systemu Debian, po prostu zainstaluj najnowsz± wersjê pakietu
<a href="http://packages.debian.org/stable/net/rsync">rsync</a>.</p>

<p>Utwórz plik <code>rsyncd.conf</code> i wpisz do niego tak± (lub
zbli¿on±) zawarto¶æ:</p>

<pre>
uid = nobody
gid = nogroup
max connections = 25
socket options = SO_KEEPALIVE

[debian]
  path = /srv/debian/mirror
  comment = The Debian Archive (~250 GB)
  auth users = authorized_account1,authorized_account2,authorized_accountN
  read only = true
  secrets file = /etc/rsyncd/debian.secrets
</pre>

<p>Dodaj wpis dla ka¿dego serwera, z którym siê ³±czysz metod± push w
pliku <code>/etc/rsyncd/debian.secrets</code>:</p>

<pre>
authorized_account1:a_password
authorized_account2:another_password
authorized_accountN:password
</pre>

<p>W ten sposób da³e¶ serwerom podrzêdnym dostêp do swojego komputera.</p>

<p>Prawdopodobnie bêdziesz chcia³ uruchamiaæ demona rsync z inetd. Aby
to osi±gnaæ, musisz dodaæ us³ugê rsync do pliku
<code>/etc/services</code> (je¶li jeszcze jej tam nie ma) w nastêpuj±cy
sposób:</p>

<pre>
rsync           873/tcp
</pre>

<p>
Aby uaktywniæ demona przez inetd, dodaj nastêpuj±cy wpis do pliku
<code>/etc/inetd.conf</code>:</p>

<pre>
rsync      stream      tcp         nowait      root /usr/bin/rsync rsyncd --daemon
</pre>

<p>
(Pamiêtaj, aby wys³aæ sygna³ HUP do inetd, aby poinformowaæ go, ¿eby
odczyta³ ponownie swój plik konfiguracyjny po jego modyfikacji.)
</p>

<toc-add-entry name="sshtrigger">Konfiguracja mechanizmu <q>spustowego</q>
ssh</toc-add-entry>

<p>Utwórz nowy klucz ssh dla konta, którego u¿ywasz do tworzenia obrazu
lustrzanego Debiana. Upewnij siê, ¿e nie nadpiszesz swojego poprzedniego
klucza ssh poprzez dodanie opcji -f, na przyk³ad:</p>

<pre>
ssh-keygen -f ~/.ssh/identity.mysite
</pre>

<p>Upewnij siê, ¿e nowy klucz publiczny (~/.ssh/identity.mysite.pub)
zawiera na pocz±tku taki wpis:</p>

<pre>
no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty,command="~/sync &amp;"
</pre>

<p>Musisz utworzyæ skrypt, który bêdzie siê kontaktowa³ z serwerami
podrzêdnymi. Utwórz plik o nazwie <code>signal</code> i nastêpuj±cej
zawarto¶ci:</p>

<protect>
<pre>
#!/bin/sh

# Ten skrypt jest wywo³ywany, aby poinformowaæ zdalny komputer, ¿e
# nadszed³ czas na zsynchronizowanie archiwum.

echo Signalling $1
ssh -o"BatchMode yes" -o"user $2" "$1" -i $HOME/.ssh/identity.mysite sleep 1
</pre>
</protect>

<p>Skrypt ten zaloguje siê na zdalnym komputerze u¿ywaj±c
specjalnego klucza ssh, który utworzy³e¶ powy¿ej, przy za³o¿eniu, ¿e ka¿dy
administrator mirrora podrzêdnego doda ten klucz do pliku
~/.ssh/authorized_keys (zamieniaj±c <q>sync</q> na <q>anonftpsync</q> lub
co¶ innego, co powoduje rozpoczêcie procesu synchronizacji).
Sam skrypt nie robi niczego u¿ytecznego na zdalnym komputerze, zostanie
uruchomione polecenie wyspecyfikowane w kluczu.</p>

<p>Aby zawiadomiæ serwery lustrzane, musisz dodaæ liniê <code>./signal
&lt;site&gt; &lt;username&gt;</code> po zakoñczeniu procesu synchronizacji
Twojego serwera. Tak wiêc, kiedy tylko zakoñczy siê synchronizacja z
serwerm nadrzêdnym, rozpoczyna siê synchronizacja serwerów zale¿nych
od Twojego.
</p>

<p>Mo¿esz umie¶ciæ te polecenia albo na koñcu skryptu <code>anonftpsync</code>
albo, je¶li to Ci bardziej odpowiada, w nowym skrypcie, wywo³ywanym
przez <code>anonftpsync</code>, na przyk³ad:
</p>

<protect>
<pre>
#!/bin/sh

# Ten skrypt jest wywo³ywany, aby powiadomiæ podrzêdne
# serwery lustrzane.

./signal some.other.site archvsync
./signal and.another.site othersiteaccount
</pre>
</protect>

<p>Je¶li bêdziesz mia³ z tym jakiekolwiek problemy, <a
href="mailto:mirrors@debian.org">skontaktuj siê z nami</a>.</p>
