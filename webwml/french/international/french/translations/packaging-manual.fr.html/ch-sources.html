<html><head>
<title>Le manuel de programmation de dpkg - Les paquets sources</title>
<link rev=made href="mailto:cure@cnam.fr">
</head><body>
<h1>
Le manuel de programmation de dpkg - chapitre 3<br>
Les paquets sources
</h1>

Dans la distribution Debian, les paquets binaires sont générés à partir des
sources Debian, qui sont dans un format spécial pour faciliter la construction
automatique des binaires.<P>

Il y avait une version précédente d'un format source Debian qui est obsolète.
Les instructions pour convertir les vieux paquets sont données dans le manuel
des principes Debian.<P>
<hr>
<h2><A name="s-sources-1">
3.1 Les outils pour manipuler les paquets sources
</A></h2>

De nombreux outils sont fournis pour manipuler les paquets sources.
Ils emballent et déballent les sources et aident à la construction
des paquets binaires et à gérer la distribution des nouvelles versions.<P>

Le manuel présente une introduction et un exemple d'utilisation courante
de ces outils, pour avoir de plus amples informations sur leurs options
et leurs opérations, voir <code>dpkg-source(1)</code>.<P>

Le paquet <kbd>hello</kbd> est un exemple de construction de paquet source Debian et
de mise en oeuvre des utilitaires qui y sont impliqués.<P>
<hr>
<h3><A name="s-sources-1-1">
3.1.1 <code>dpkg-source</code> - création et extraction des paquets sources Debian
</A></h3>

Ce programme est fréquemment utilisé sur la ligne de commande, et est 
aussi appelé à partir des scripts de construction automatique de paquet
indépendant, tel que <kbd>dpkg-buildpackage</kbd>.<P>

Pour extraire un paquet, on utilise:

<pre>    dpkg-source -x ../chemin/du/fichier.dsc</pre>

Avec le fichier <code>.tar.gz</code> et le fichier <code>.diff.gz</code>
(si c'est utile) dans le même répertoire. Il extrait un paquet <em>package-version</em>
et s'il est présent un paquet <em>package-version</em><code>.orig</code> dans le
même répertoire.<P>

Pour créer une paquet, on utilise:

<pre>    dpkg-source -b package-version</pre>

Ceci créera les fichiers <code>.dsc</code>, <code>.tar.gz</code> et <code>.diff.gz</code>
(si c'est utile) dans le répertoire courant. <kbd>dpkg-source</kbd> n'efface pas 
l'arborescence des sources. Ceci doit être fait séparément, si nécessaire.<P>

Voir aussi <A href="#s-sources-3">Les paquets sources comme archives, section 3.3</A>.<P>
<hr>
<h3><A name="s-sources-1-2">
3.1.2 <code>dpkg-buildpackage</code> - script général de contrôle de construction
de paquet
</A></h3>

<kbd>dpkg-buidpackage</kbd> est un script qui fait appel à <kbd>dpkg-source</kbd>
avec les règles du fichier <code>debian/rules</code> : <code>clean</code>, <code>build</code>,
et <code>binary</code> et les programmes <kbd>dpkg-genchanges</kbd> et <kbd>pgp</kbd>
pour construire une distribution signée de paquets source et binaire.<P>

Il est généralement utilisé sur la ligne de commande, à la racine du répertoire
source à créer ou à détruire. Il peut être invoqué sans arguments.
Les arguments utiles sont:

<dl>
<dt> -uc, -us <dd>Signifie, ne pas crypter, avec PGP, respectivement le fichier <code>.change</code>
et le fichier paquet source <code>.dsc</code>.
<p><dt> -ppgp-command<dd>Invoque la commande <em>pgp-command</em>
au lieu de chercher <kbd>pgp</kbd> dans la variable <code>PATH</code>.
<em>pgp-command</em> doit avoir le même comportement que <kbd>pgp</kbd>.
<p><dt> -rroot-command<dd>Quand les privilèges de root sont nécessaires, invoque
la commande <em>root-command</em>. <em>root-command</em> doit invoquer
son premier argument comme une commande, dans le <code>PATH</code> si nécessaire,
et passer son second argument et les autres à la commande appelée.
Si aucune <em>root-command</em> n'est fournie alors <kbd>dpkg-buildpackage</kbd>
ne fera aucune action pour obtenir les privilèges root, afin que pour
démarrer la plupart des paquets root soit nécessaire.
<p><dt> -b, -B<dd>Deux types de binaire: construit et charger, voir
<code>dpkg-source(1)</code>).
<p></dl>


<hr>
<h3><A name="s-sources-1-3">
3.1.3 <code>dpkg-gencontrol</code> - génère les fichiers de contrôle
des paquets binaires
</A></h3>

Ce programme est habituellement appelé à partir du fichier <code>debian/rules</code>
(voir <A href="#s-sources-2">L'arbre source débianisé, section 3.2</A>) depuis la racine de l'arborescence
source.<P>

Ceci est généralement fait juste avant que les fichiers et les répertoires,
dans le répertoire temporaire où le paquet est en train de se construire, ont
établi leurs permissions et leurs propriétaires et avant la construction du paquet par
<kbd>dpkg-deb</kbd>
<A href="footnotes.html#4" name="fr4">[4]</A>.<P>

<code>dpkg-gencontrol</code> doit être appelé après que tous les fichiers du
paquet aient été mis en place dans le répertoire temporaire de construction,
afin que le calcul de la taille du paquet installé soit correct.<P>

Il est aussi nécessaire pour <kbd>dpkg-gencontrol</kbd> d'être exécuté après
<kbd>dpkg-shlibdeps</kbd> afin que les variables de substitutions, créées par
<kbd>dpkg-shlibdeps</kbd> dans le fichier <code>debian/substvars</code>, soient
disponibles.<P>

Pour un paquet qui génère seulement un paquet binaire, et qui est construit
dans le répertoire <code>debian/tmp</code> par rapport à la racine du paquet
source, il suffit d'appeler:

<pre>   dpkg-gencontrol</pre>

Les sources qui construisent plusieurs binaires utiliseront:

<pre>   dpkg-gencontrol -Pdebian/tmp-pkg -ppackage</pre>

L'argument <code>P</code> indique à <kbd>dpkg-gencontrol</kbd> que le paquet est
en train de se construire dans un répertoire différent que celui par défaut
et <code>-p</code> indique quel fichier de contrôle de paquet doit être généré.<P>

<kbd>dpkg-gencontrol</kbd> ajoute aussi des informations à la liste des fichiers
du répertoire <code>debian/file</code> pour un futur appel à <code>dpkg-genchanges</code>.<P>

<hr>
<h3><A name="s-sources-1-4">
3.1.4 <code>dpkg-shlibdeps</code> - calcule les dépendances des librairies partagées
</A></h3>

Ce programme est habituellement appelé à partir du fichier <code>debian/rules</code>,
juste avant
<kbd>dpkg-gencontrol</kbd> (voir <A href="#s-sources-2">L'arbre source débianisé, section 3.2</A>), à la racine
de l'arborescence source.<P>

Les arguments sont des exécutables
<A href="footnotes.html#5" name="fr5">[5]</A>
<A href="footnotes.html#6" name="fr6">[6]</A>
pour lesquels les dépendances
des librairies partagées devraient être incluses dans le fichier de contrôle de paquet.<P>

Si certains exécutables librairies partagées doivent seulement justifier d'un
<code>Recommends</code> ou d'un <code>Suggests</code>, ou si certains demandent un
<code>Pre-Depends</code>, ceci peut être réaliser en utilisant l'option
<code>-d</code><em>dependency-field</em> avant ces exécutables
(chaque option <code>-d</code> prends effet jusqu'au prochain <code>-d</code>).<P>

<kbd>dpkg-shlibdeps</kbd> ne modifie pas directement le fichier de contrôle.
Par défaut, il ajoute au fichier <code>debian/substvars</code> des variables comme
<code>shlibs:Depends</code>. Ces variables doivent être référencées dans le champ dépendance
dans la section appropriée des paquets binaires du fichier de contrôle source.<P>

Par exemple, le paquet <kbd>procps</kbd> génère deux types de binaires, des binaires
simples comme <kbd>ps</kbd> qui requièrent une pré-dépendance, et des binaires utilisant
<kbd>ncurses</kbd> comme <kbd>top</kbd> qui nécessitent seulement une recommandation.
Cela peut être indiqué dans le fichier <code>debian/rules</code> par:

<pre>      dpkg-shlibdeps -dPre-Depends ps -dRecommends top</pre>

Et ensuite dans le fichier principal de contrôle <code>debian/control</code>:

<pre>      ...
      Package: procps
      Pre-Depends: ${shlibs:Pre-Depends}
      Recommends: ${shlibs:Recommends}
      ...</pre>

Les sources qui produisent plusieurs paquets binaires avec des exigences différentes de
dépendance de librairie partagée peuvent utiliser l'option <code>-p</code><em>varnameprefix</em>
pour écraser le préfixe <code>shlib:</code> par défaut (un appel à <kbd>dpkg-shlibdeps</kbd>
par réglage de cette option). Elles peuvent ainsi produire plusieurs ensembles de variables de dépendance,
chacune de la forme <em>varnameprefix:dependencyfield</em>, qui peuvent être référencées
dans les parties appropriées des fichiers de contrôle des paquets binaires.<P>

<hr>
<h3><A name="s-sources-1-5">
3.1.5 <code>dpkg-distaddfile</code> - ajoute un fichier à <code>debian/files</code>
</A></h3>

Certains chargements de paquets nécessitent d'inclure des fichiers en plus des fichiers
des paquets sources et binaires.<P>

<kbd>dpkg-distaddfile</kbd> ajoute une ligne au fichier <code>debian/files</code> afin
qu'il soit inclus dans le fichier <code>.changes</code> lorsque <kbd>dpkg-genchanges</kbd> sera lancé.<P>

Il est habituellement invoqué à partir de la cible <code>binary</code> du fichier <code>debian/rules</code>:

<pre>     dpkg-distaddfile filename section priority</pre>

L'argument nom du fichier <em>filename</em> est relatif au répertoire où <kbd>dpkg-genchanges</kbd>
s'attend à le trouver, généralement au dessus de la racine de l'arborescence source.
La règle de <code>debian/rules</code> devrait placer ce fichier juste avant ou juste après
l'appel à <kbd>dpkg-distaddfile</kbd>.<P>

Les arguments <em>section</em> et <em>priority</em> sont placés sans modification dans le fichier
résultat <code>.changes</code>. Voir <A href="ch-controles.html#s-controles-2-9">Section et Priority, subsection 4.2.9</A>.<P>

<hr>
<h3><A name="s-sources-1-6">
3.1.6 <code>dpkg-genchanges</code> - génère un fichier de contrôle de chargement <code>.changes</code>
</A></h3>

Ce programme est généralement appelé par des scripts de construction automatique de paquet indépendant
tels que <kbd>dpkg-buildpackage</kbd> mais peut être aussi appelé sur la ligne de commande.<P>

Il est habituellement exécuté à la racine du répertoire de l'arbre source construit,
et quand il est invoqué sans arguments, il écrira directement un fichier <code>.changes</code> basé
sur les informations des fichiers de contrôle et de changement des paquets sources, et des paquets
sources et binaires qui ont dû être construit.<P>

<hr>
<h3><A name="s-sources-1-7">
3.1.7 <code>dpkg-parsechangelog</code> -
 produit une représentation analysée d'un fichier <code>changelog</code>
</A></h3>
Ce programme est utilisé en interne par <kbd>dpkg-source</kbd> et autres.
Il peut être aussi occasionnellement utilisé dans <code>debian/rules</code> et autre part.
Il analyse un fichier <em>changelog</em>, par défaut <code>debian/changelog</code>,
et affiche sur la sortie standard une représentation formatée de fichier de contrôle 
des informations contenues.<P>

<hr>
<h2><A name="s-sources-2">
3.2 L'arbre source débianisé
</A></h2>

La structure de l'archive source, décrit ci-dessous, a été conçu pour permettre à un
arbre source débianisé, avec les informations de contrôle associées, d'être dupliqué et
facilement transporté. L'arbre source débianisé est une version du programme original
avec certains fichiers ajoutés pour le processus de débianisation, ainsi que n'importe
quels changements nécessaires réalisés sur les codes sources et scripts d'installation.<P>

Les fichiers supplémentaires crées pour la Debian sont dans le répertoire <code>debian</code>
à la racine de l'arbre source débianisé. Ils sont décrits ci-dessous.<P>

<hr>
<h3><A name="s-sources-2-1">
3.2.1 <code>debian/rule</code> - le script principal de construction
</A></h3>

Ce fichier est un <em>makefile</em> exécutable, qui contient les règles spécifiques
au paquet pour compiler et construire les binaires des paquets sources.<P>

Il doit commencer par une ligne:

<pre>    #!/usr/bin/make -f</pre>

afin de pouvoir être appelé directement sans faire <kbd>make</kbd>.<P>

Les règles nécessaires sont:

<dl>
<dt> build<dd>Configuration non interactive et compilation du paquet. Si un paquet
a une routine de configuration préalable interactive, alors le paquet source débianisé
devra être construit après cette opération afin qu'il puisse fonctionner sans réexécuter
cette configuration.<P>

Pour certains paquets, notamment ceux où le même arbre source est compilé de différentes
façons pour obtenir deux paquets binaires, la règle <code>build</code> n'a aucun sens.
Pour ces paquets, il est bon de prévoir deux règles ou plus (<code>build-a</code> et
<code>build-b</code> ou autre) pour chaque manière de construire le paquet et une règle
<code>build</code> qui ne produit rien. La règle <code>binary</code> s'occupera de
construire le paquet pour chaque cas possible et de créer le paquet binaire de chacun d'eux.<P>

La règle <code>build</code> ne doit pas effectuer d'actions qui exigent les privilèges de root.<P>

La règle <code>build</code> peut avoir besoin d'exécuter d'abord la 
règle <code>clean</code>. Voir ci-dessous.<P>

Quand un paquet possède une routine de configuration qui prend du temps, ou quand
le <em>makefile</em> est pauvrement conçu, ou quand <code>build</code> a besoin d'exécuter
<code>clean</code> d'abord, il est alors intéressant d'exécuter <kbd>touch build</kbd>
quand le processus <code>build</code> est terminé. Cela assurera que si <code>build</code>
de <code>debian/rules</code> est exécuté à nouveau, il ne reconstruira pas le programme complet.<P>

<p><dt> binary, binary-arch, binary-indep<dd>La règle <code>binary</code> devrait être tout ce qui est nécessaire pour l'utilisateur
pour construire le paquet binaire.
Elle est découpée en deux parties: <code>binary-arch</code> construit les fichiers de
sortie des paquets qui sont spécifiques à une architecture particulière, et
<code>binary-indep</code> construit les fichiers que ne le sont pas.<P>

<code>binary</code> devrait être généralement une règle, avec aucune commande,
qui dépend simplement de <code>binary-arch</code> et <code>binary-indep</code>.<P>

Les deux règles de <code>binary</code> (<code>binary-arch</code> et <code>binary-indep</code>)
devrait dépendre de la règle <code>build</code>, ci-dessus, afin que le paquet soit
construit si ce n'est pas déjà le cas. Il doit ensuite créer les paquets binaires
pertinents en utilisant <kbd>dpkg-gencontrol</kbd> pour créer leurs fichiers de
contrôle et <kbd>dpkg-build</kbd> pour les binaires,  et les placer le répertoire
parent du répertoire racine.<P>

Si une des deux règles n'a pas de commandes (ce sera toujours le cas, si le source
génère seulement un paquet binaire dépendant de l'architecture ou non), elle doit
tout de même exister.<P>

<A href="ch-binaires.html">Les paquets binaires, chapter 2</A> décrivent comment construire les paquets binaires.<P>

La règle <code>binary</code> doit être invoquée avec le privilège root.<P>

<p><dt> clean<dd>Procède au nettoyage des effets obtenus par les règles
<code>build</code> et <code>binary</code>, sauf pour les fichiers de sortie du
répertoire parent crées par la règle <code>binary</code>.<P>

Si le fichier <code>build</code> est mis à jour par <kbd>touch</kbd> à la fin
de la règle <code>build</code>, comme suggéré ci-dessus, c'est la première chose
qui doit être effacée par la règle <code>clean</code>, afin que si on exécute de
nouveau <code>build</code> après une interruption, <code>clean</code> ne pense
pas que tout est déjà fait.<P>

La règle <code>clean</code> doit être invoquée sous root, si <code>binary</code>
a été invoqué depuis le dernier <code>clean</code>, ou si <code>build</code>
a été invoqué sous root (étant donné que <code>build</code> peu créer des
répertoires par exemple).<P>

<p><dt> get-orig-source (optionnel)<dd>Cette règle va chercher la version la
plus récente du paquet original à partir d'un site d'archive autorisé
(par FTP ou WWW, par exemple), s'occupe des réarrangements nécessaires pour le
rendre dans un format de fichier archive source original décrit ci-dessus, et 
le laisse dans le répertoire courant.<P>

Cette règle peut être invoquée dans n'importe quelle répertoire et doit s'occuper
de nettoyer ses fichiers temporaires. Elle est optionnelle, mais la fournir, si
c'est possible, est une bonne idée.<P>
<p></dl>



Les règles <code>build</code>, <code>binary</code> et <code>clean</code> doivent
être invoquées dans le répertoire courant du répertoire racine du paquet.<P>
Des règles supplémentaires peuvent exister dans <code>debian/rules</code>, soit
comme des interfaces publiées ou non documentées ou pour l'utilisation interne du paquet.<P>

<hr>
<h3><A name="s-sources-2-2">
3.2.2 <code>debian/control</code>
</A></h3>

Ce fichier contient les détails indépendants des versions des paquets sources
et des paquets binaires qu'il crée.<P>

C'est une série d'ensemble de champ de contrôle, chacun syntaxiquement similaire
à un fichier de contrôle de paquet binaire. Les ensembles sont séparés par
une ou plusieurs lignes vides. Le premier ensemble contient en général les
informations sur le paquet source; chaque ensemble suivant décrit un paquet
binaire que l'arbre source construit.<P>

la syntaxe et la sémantique des champs sont décrites ci-dessous dans
<A href="ch-controles.html">Les fichiers de contrôle et leurs champs, chapter 4</A>.<P>

Les champs généraux (indépendant des paquets binaires) sont:

<dl>
<dt> Source<dd>Obligatoire
<p><dt> Maintainer<dd><p><dt> Section and Priority<dd>(classification, obligatoire)
<p><dt> Standards-Version<dd><p></dl>


Les champs pour les paquets binaires sont:

<dl>
<dt> Package<dd>Obligatoire
<p><dt> Architecture<dd>Obligatoire
<p><dt> Description<dd><p><dt> Section and Priority<dd>(classification)
<p><dt> Essential<dd><p><dt> Depends et autres<dd>(relations entres paquets)
<p></dl>



Ces champs sont utilisés par <kbd>dpkg-gencontrol</kbd> pour générer
les fichiers de contrôle pour les paquets binaires (voir ci-dessus),
par <kbd>dpkg-genchanges</kbd> pour générer le fichier <code>.changes</code>
qui accompagne le chargement et par <kbd>dpkg-source</kbd> quand
il crée le fichier de contrôle source <code>.dsc</code> comme une partie
de l'archive source.<P>

Les champs peuvent contenir des références aux variables, leurs valeurs
seront substituées par <kbd>dpkg-gencontrol</kbd>, <kbd>dpkg-genchanges</kbd>
ou <kbd>dpkg-source</kbd> quand ils génèrent leurs fichiers de sortie.
Voir <A href="#s-sources-2-3"><code>debian/substvars</code> et substitutions de variables, subsection 3.2.3</A> pour détails.<P>

<hr>
<h4><A name="s-sources-2-2-1">
3.2.2.1 Les champs définis par l'utilisateur
</A></h4>

Des champs utilisateurs supplémentaires peuvent être ajoutés au fichier
de contrôle du paquet source. Ces champs seront ignorés, ne seront pas
copiés dans les fichiers de contrôle des paquets sources ou binaires
(par exemple) ou dans les fichiers de contrôle de chargement.<P>

Si tu souhaites ajouter des champs supplémentaires non supportés à
ces fichiers de sortie, tu dois utiliser le mécanisme décrit ci-dessous.<P>

Les champs du fichier principal d'information de contrôle de source
avec des noms commençant par X, suivis par une ou plusieurs lettres
<code>BCS</code> et un tiret -, seront copiés vers les fichiers de sortie.
Seule la partie du nom du champ qui se trouve après le tiret sera
utilisée dans le fichier de sortie.
Si la lettre B est utilisée, le champ apparaîtra dans les fichiers
de contrôle des paquets binaires, si c'est la lettre S, dans les fichiers
de contrôle de paquet source, et si c'est la lettre C, dans les fichiers
de contrôle de chargement (<code>.changes</code>).<P>

Par exemple, le fichier principal d'information de contrôle source
contient le champ suivant:

<pre>   XBS-Comment: I stand between the candle and the star.</pre>

alors les fichiers de contrôle des paquets sources et binaires contiendront
le champ:

<pre>   Comment: I stand between the candle and the star.</pre>

<hr>
<h4><A name="s-sources-2-2-2">
3.2.2.2 <code>debian/changelog</code>
</A></h4>

Ce fichier enregistre les changements des parties spécifiques Debian
d'un paquet
<A href="footnotes.html#7" name="fr7">[7]</A>.<P>

Il a un format spécial qui permet aux outils de construction de paquets
de découvrir quelle version du paquet est en train de se construire
et de trouver d'autres informations spécifiques à la version.<P>

Le format est une série d'entrée comme ça:

<pre>   package (version) distributions(s); urgency=urgency
         * détails des modifications
            plus de détails
         * encore plus de détails

     -- nom du mainteneur et adresse email  date</pre>

<em>package</em> et <em>version</em> sont le nom du paquet source
et le numéro de version.<P>

<em>distribution(s)</em> listent les distributions où cette version
devrait être installée quand elle est chargée. C'est copié du champ
<code>Distributions</code> dans le fichier <code>.changes</code>.
Voir <A href="ch-controles.html#s-controles-2-14">Distribution, subsection 4.2.14</A>.<P>

<em>urgency</em> est la valeur pour le champ <code>Urgency</code>
dans le fichier <code>.changes</code> pour le chargement.
Voir <A href="ch-controles.html#s-controles-2-15">Urgency, subsection 4.2.15</A>.
Il n'est pas possible de spécifier une
<em>urgency</em> contenant des virgules; les virgules sont utilisées
pour séparer les couples (mot clé=valeur) dans le format du fichier
d'enregistrement de <code>dpkg</code> (bien qu'il n'y ait pour
l'instant seulement un mot clé utile: <code>urgency</code>).<P>

Les détails des modifications peuvent être, en fait, n'importe quelles
séries de ligne commençant au moins par deux espaces, mais
par convention, chaque modification commence par une étoile * et un espace,
les lignes de continuation sont indentées pour les amener en
face du texte de la ligne précédente. Les lignes vides peuvent
être utilisées pour séparer les groupes de modifications, si désiré.<P>

Le nom du mainteneur et son adresse email ne sont pas nécessairement
les mêmes que ceux du mainteneur habituel du paquet. Ils doivent
correspondre à la personne qui s'est occupée ce cette version.
Les informations seront copiées dans le fichiers <code>.changes</code>,
et plus tard, utilisées pour envoyer un acquittement quand
le chargement sera installé.<P>

La date doit être dans le format RFC822
<A href="footnotes.html#8" name="fr8">[8]</A>;
elle doit inclure le nom du fuseau horaire (timezone) spécifié
numériquement, et en option le nom du fuseau ou son abréviation.<P>

La première ligne 'titre' avec le nom du paquet doit commencer
sur la marge de gauche, la ligne de 'fin' avec les détails sur
le mainteneur et la date, doit être précédée par exactement
un espace. Les détails du mainteneur et la date doivent être
séparés exactement par deux espaces.<P>

Un mode Emacs pour éditer ce format est disponible:
<code>debian-changelog-mode</code>. Tu peux sélectionner ce
mode automatiquement quand tu édites un fichier <code>changelog</code>
Debian en ajoutant une clause de variables locales à la
fin du fichier <kbd>changelog</kbd>.<P>

<hr>
<h4><A name="s-sources-2-2-3">
3.2.2.3 Définition de formats alternatifs pour le fichier
<code>changelog</code>
</A></h4>

Il est possible d'utiliser un format différent de celui proposé,
en fournissant un analyseur avec le format que tu veux utiliser.<P>

De façon à ce que <kbd>dpkg-parsechangelog</kbd> exécute ton
parseur (analyseur), tu dois inclure une ligne à l'intérieur
des 40 dernières lignes de ton fichier s'apparentant à
l'expression régulière Perl: 

<pre>    \schangelog-format:\s+([0-9a-z)+\W</pre>

La partie entre parenthèses doit être le nom du format,
par exemple:

<pre>    @@@ changelog-format: joebloggs @@@</pre>

Les noms de format de fichier <kbd>changelog</kbd> sont
des chaînes alphanumériques non vides.<P>

Si une telle ligne existe, alors <kbd>dpkg-parsechangelog</kbd>
cherchera l'analyseur dans:

<pre>    /usr/lib/dpkg/parsechangelog/nom-format ou
    /usr/local/lib/dpkg/parsechangelog/nom-format</pre>

Une erreur est renvoyée si le fichier n'est pas trouvé ou
s'il n'est pas exécutable. Le format <kbd>changelog</kbd>
par défaut est <code>dpkg</code> et un analyseur est fourni
avec le paquet <code>dpkg</code>.<P>

L'analyseur sera invoqué avec le fichier <kbd>changelog</kbd>
ouvert sur l'entrée standard au début. Il doit lire le fichier
(ou le parcourir avec seek) pour trouver l'information et retourner
cette information analysée sur la sortie standard sous la forme
d'une série de champ de contrôle dans le format standard.
Par défaut, il devrait retourner seulement les informations les
plus récentes du fichier <kbd>changelog</kbd>; il doit accepter
l'option <code>-v</code><em>version</em> pour retourner les
informations de changement de toutes les versions présentes
strictement supérieures <em>version</em> et rendre une erreur pour
une version non présente dans le fichier <kbd>changelog</kbd>.<P>

Les champs sont:

<dl>
<dt> Source<dd><p><dt> Version<dd>Obligatoire
<p><dt> Distributions<dd>Obligatoire
<p><dt> Urgency<dd>Obligatoire
<p><dt> Maintener<dd>Obligatoire
<p><dt> Date<dd><p><dt> Changes<dd>Obligatoire
<p></dl>



Si plusieurs versions sont retournées (à cause de l'utilisation
de l'option <code>-v</code>), la valeur <code>urgency</code> doit
être la plus grande listée au début de n'importe quelle version
requise suivie par les commentaires concaténés (séparés par un espace)
de toutes les versions requises, les champs: le mainteneur,
la version, la distribution et la date proviennent toujours de la
version la plus récente .<P>

Pour le format du champ <code>Changes</code> voir <A href="ch-controles.html#s-controles-2-18">Changes, subsection 4.2.18</A>.<P>

Si le format du fichier <code>changelog</code> qui est en train d'être analysé,
laisse toujours ou presque toujours une ligne vide entre les notes de
modifications individuelles, ces lignes vides peuvent être supprimées,
pour rendre le résultat de sortie plus compact.<P>

Si le format de <kbd>changelog</kbd> ne contient pas de date ou
d'information sur le nom du paquet, ces informations doivent être omises
en sortie. L'analyseur ne doit pas essayer de les synthétiser ou de les
trouver à partir d'autres sources. Si le fichier <kbd>changelog</kbd> n'a
pas le format attendu, l'analyseur doit se terminer avec un statut
différent de zéro, plutôt que d'essayer de se débrouiller tant bien que mal
et générer des sorties incorrectes.<P>

L'analyseur du fichier <kbd>changelog</kbd> ne doit pas du tout interagir
avec l'utilisateur.<P>

<hr>
<h3><A name="s-sources-2-3">
3.2.3 <code>debian/substvars</code> et substitutions de variables
</A></h3>

Quand <kbd>dpkg-gencontrol</kbd>, <kbd>dpkg-genchanges</kbd> et
<kbd>dpkg-source</kbd> génèrent des fichiers de contrôle, ils font de la substitution
de variable sur leurs sorties juste avant de les écrire. Les
substitutions de variable ont la forme <code>${</code><em>nom-variable</em><code>}</code>.
Le fichier optionnel <code>debian/substvars</code>
contient les substitutions de variable à utiliser. Les variables peuvent
être aussi positionnées directement à partir de <code>debian/rules</code> en
utilisant l'option <code>-v</code> par les commandes de paquetage source et
certaines variables prédéfinies sont disponibles.<P>

Ceci est habituellement généré et modifié dynamiquement par les règles
de <code>debian/rules</code>, dans ce cas, il doit être enlevé par la règle
<code>clean</code>.<P>

Voir <code>dpkg-source(1)</code> pour plus de détails sur les
substitutions de variables source, incluant aussi le format de
<code>debian/substvars</code>.<P>

<hr>
<h3><A name="s-sources-2-4">
3.2.4 <code>debian/files</code>
</A></h3>

Ce fichier n'est pas un fichier permanent de l'arbre source, il est
utilisé pendant la construction des paquets pour enregistrer quels
fichiers sont en train d'être générés. <kbd>dpkg-genchanges</kbd>
l'utilise quand il génère un fichier <code>.changes</code>.<P>

Ce fichier ne doit pas exister dans un paquet source expédié, et il doit être effacé
par la règle <code>clean</code> (ainsi que n'importe quels fichiers 
de sauvegarde ou temporaire tel que <code>files.new</code>
<A href="footnotes.html#9" name="fr9">[9]</A>).
Il peut aussi être sage, pour assurer un nouveau départ, de l'enlever ou
de le vider au début de la règle <code>binary</code>.<P>

<kbd>dpkg-gencontrol</kbd> ajoute une entrée à ce fichier, pour le fichier
<code>.deb</code> qui sera crée par <kbd>dpkg-deb</kbd> à partir du fichier de
contrôle qu'il génère, ainsi pour la plupart des paquets, il n'y a qu'à
effacer ce fichier dans la règle <code>clean</code>.<P>

Si un chargement de paquet inclut des fichiers à côté des paquets
sources et binaires dont les fichiers de contrôle ont été crée par
<kbd>dpkg-gencontrol</kbd>, alors ils doivent être placés dans le
répertoire parent du répertoire racine du paquet et <kbd>dpkg-distaddfile</kbd>
doit être appelé pour ajouter ces fichiers à la liste
<code>debian/files</code>.<P>

<hr>
<h3><A name="s-sources-2-5">
3.2.5 <code>debian/tmp</code>
</A></h3>

C'est l'emplacement temporaire, pour la construction des paquets
binaires pour la règle <code>binary</code>. Le répertoire <code>tmp</code> sert
de racine à l'arbre du système de fichier qui est en train de se
construire (par exemple en utilisant la règle d'installation du
<kbd>Makefile</kbd> du paquet original et en le redirigeant dans
<code>tmp</code>), et il contient aussi le sous-répertoire <code>DEBIAN</code>.
Voir <A href="ch-binaires.html#s-binaires-1">Création des paquets binaires - dpkg-deb, section 2.1</A>.<P>

Si plusieurs paquets binaires sont générés à partir du même arbre
source, il est habituel d'utiliser plusieurs répertoires
<code>debian/tmp-truc</code>, par exemple <code>tmp-a</code>
ou <code>tmp-doc</code>.<P>

Quelque soit les répertoires <code>tmp</code> crées et utilisés par
<code>binary</code>, la règle <code>clean</code> doit bien sûr les effacer.<P>

<hr>
<h2><A name="s-sources-3">
3.3 Les paquets sources comme archives
</A></h2>

Sur les sites FTP, les paquets sources contiennent trois fichiers qui ont
des liens. Tu dois avoir les bonnes versions pour les trois pour pouvoir
les utiliser.<P>

<dl>
<dt> fichier de contrôle source Debian - <code>.dsc</code><dd>Ce fichier contient une série de champs, identifiés et séparés comme les
champs dans le fichier de contrôle d'un paquet binaire. Les champs sont
listés ci-dessous; leur syntaxe est décrite ci-dessus dans
<A href="ch-controles.html">Les fichiers de contrôle et leurs champs, chapter 4</A>.

  <dl compact>
<dt> Source
  <dd>
  <dt> Version
  <dd>
  <dt> Maintener
  <dd>
  <dt> Binary
  <dd>
  <dt> Architecture
  <dd>
  <dt> Standards-Version
  <dd>
  <dt> Files 
  <dd>
  </dl>


Le fichier de contrôle du paquet source est généré par <kbd>dpkg-source</kbd>
quand il crée l'archive source, à partir des autres fichiers
dans le paquet source, décrit ci-dessus. Quand on le déballe, il est
vérifié par rapport aux autres fichiers et répertoires dans les autres
parties du paquet source, comme décrit ci-dessous.
<dt> archive du source original - <em>paquet-version-originale</em><code>.orig.tar.gz</code><dd>C'est un fichier <kbd>tar</kbd> compressé (avec <kbd>gzip -9</kbd>)
contenant le code source de l'auteur original du programme. Le fichier
<kbd>tar</kbd> est déballé dans un répertoire <em>paquet-version-
originale</em><code>.orig</code>. Il ne contient aucun fichier en dehors de
ses sous-répertoires.<P>
<dt> fichier <code>diff</code> de Débianisation -
<em>paquet-révision-version-originale</em><code>.diff.gz</code><dd>C'est un fichier <code>diff</code> unifié (<kbd>diff -u</kbd>) donnant les
changements requis pour modifier le source original en source Debian.
Ces changements peuvent inclure seulement une édition ou une création de
fichier tout bonnement. Les permissions des fichiers, les cibles des
liens symboliques et les caractéristiques des fichiers spéciaux ou
&quot;pipes&quot; ne peuvent pas être changés et aucun fichier ne doit être
enlevé ou renommé.<P>

Tous les répertoires dans le fichier <code>diff</code> doivent exister, sauf
le sous-répertoire <code>debian</code> à la racine de l'arbre source, qui
sera crée par <kbd>dpkg-source</kbd>, si nécessaire, lors de
l'extraction.<P>

Le programme <kbd>dpkg-source</kbd> rendra automatiquement exécutable le
fichier <code>debian/rules</code> (voir ci-dessous).<P>
</dl>



S'il n'y a pas de code source original, par exemple, si le paquet a été
spécialement préparé pour la Debian ou si le mainteneur Debian est le
même que le mainteneur original, le format est alors légèrement
différent: il n'y pas de fichier <code>diff</code> et le fichier
<kbd>tar</kbd> est nommé <em>paquet-version</em><code>.tar.gz</code> et
contient un répertoire <em>paquet-version</em>.<P>

<hr>
<h2><A name="s-sources-4">
3.4 Extraire un paquet source Debian sans <kbd>dpkg-source</kbd>
</A></h2>

<kbd>dpkg-source -x</kbd> est la manière recommandée pour extraire un
paquet source Debian. Cependant, si le programme n'est pas disponible,
il est possible d'extraire une archive source Debian comme suit:

<ol>
<li>Détarer le fichier <kbd>tar</kbd>, pour créer un répertoire
<code>.orig</code>.
<p><li>Renommer le répertoire <code>.orig</code> en <em>paquet-version</em>.
<p><li>Créer le sous-répertoire Debian à la racine de l'arbre source.
<p><li>Appliquer le fichier <code>diff</code> en utilisant <kbd>patch -p0</kbd>.
<p><li>Détarer le fichier <kbd>tar</kbd> de nouveau, si tu veux une copie du
code source original à côté de la version débianisée.
<p></ol>


Il n'est pas possible de générer une archive source Debian valide sans
utiliser <kbd>dpkg-source</kbd>. En particulier, essayer d'utiliser
<kbd>diff</kbd> directement pour générer le fichier <code>.diff.gz</code> ne
fonctionnera pas.<P>

<hr>
<h3><A name="s-sources-4-1">
3.4.1 Restrictions sur les objets dans les paquets sources
</A></h3>

Le paquet source ne doit contenir de liens physiques
<A href="footnotes.html#10" name="fr10">[10]</A>
<A href="footnotes.html#11" name="fr11">[11]</A>
, de fichiers spéciaux de périphériques, de sockets ou de fichiers
&quot;setuid&quot; ou &quot;setgid&quot;
<A href="footnotes.html#12" name="fr12">[12]</A>.<P>

Les outils de paquetage source gèrent les modifications entre les
fichiers sources originaux et ceux débianisés en utilisant <kbd>diff</kbd>
et <kbd>patch</kbd>. Modifier l'arbre source original inclus dans
<code>.orig.tar.gz</code> en un source débianisé ne doit pas impliquer de
changements qui ne peuvent pas être maintenus par ces outils. Les
changements problématiques qui provoquent une erreur de la part de
<kbd>dpkg-source</kbd> pour construire le paquet source sont:

<ul compact>
<li>Ajouter ou enlever des liens symboliques, des sockets ou des &quot;pipes&quot;,
<li>Changer les cibles des liens symboliques,
<li>Créer des répertoires autre que <code>debian</code>,
<li>Changer le contenu des fichiers binaires.
</ul>



Les modifications qui afficheront un avertissement de la part de
<kbd>dpkg-source</kbd> sont:

<ul compact>
<li>Enlever des fichiers, des répertoires ou des liens
<A href="footnotes.html#13" name="fr13">[13]</A>,
<li>Les fichiers textes modifiés où ils manquent le retour chariot final
(aussi bien dans l'arbre source original que celui modifié).
</ul>



Les changements qui ne sont pas représentés, et qui ne sont pas détectés
par <kbd>dpkg-source</kbd> sont:

<ul compact>
<li>Changer les permissions des fichiers (autres que
<code>debian/rules</code>) et des répertoires.
</ul>



Le répertoire Debian <code>debian/rules</code> est manipulé spécialement par
<kbd>dpkg-source</kbd>. Avant d'appliquer les changements, il créera le
répertoire <code>debian</code>, après quoi il rendra exécutable le fichier
<code>debian/rules</code>.<P>


<hr>
Le manuel de programmation de dpkg
- <A href="index.html#copyright">Copyright ©1996 Ian Jackson
Copyright ©1997 David Curé et Christian Jacolot pour
           la version française.</A>
<br>
<A href="index.html#toc">Table des matières</A>; <A href="index.html#abstract">résumé</A>; <A href="ch-controles.html">suivant</A>; <A href="ch-binaires.html">précédent</A>.
<br>
<address>20 décembre 1997<br>
D. Cure <A href="mailto:cure@cnam.fr">cure@cnam.fr</A><br>
C. Jacolot <A href="mailto:jacolot@ubolib.univ-brest.fr">jacolot@ubolib.univ-brest.fr</A></address>
</body></html>