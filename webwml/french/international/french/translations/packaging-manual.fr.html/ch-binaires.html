<html><head>
<title>Le manuel de programmation de dpkg - Les paquets binaires</title>
<link rev=made href="mailto:cure@cnam.fr">
</head><body>
<h1>
Le manuel de programmation de dpkg - chapitre 2<br>
Les paquets binaires
</h1>
Un paquet binaire a deux sections principales. La première partie consiste
en divers fichiers d'information de contrôle et des scripts utilisés
par dpkg lors de l'installation et de la désinstallation. Voir
<A href="#s-binaires-2">Les fichiers d'information de contrôle de paquet, section 2.2</A>.
<P>
La deuxième partie est une archive contenant les fichiers et les 
répertoires à installer.
<P>
Dans le futur, les paquets binaires pourront contenir d'autres composants,
comme des sommes de contrôles ou des signatures numériques. Le format
de l'archive est décrit en entier dans la page du manuel <code>deb(5)</code>.
<hr>
<h2><A name="s-binaires-1">
2.1 Création des paquets binaires - dpkg-deb
</A></h2>
Toutes les manipulations de paquets binaires se font avec <kbd>dpkg-deb</kbd>; c'est
le seul programme qui connaisse le format. (<kbd>dpkg-deb</kbd> sera exécuté
par l'appel de <kbd>dpkg</kbd>, si <kbd>dpkg</kbd> reconnaît que les paramètres
 qui lui sont passés sont pour <kbd>dpkg-deb</kbd> et l'exécutera avec les 
mêmes paramètres).
<P>
De manière à créer un paquet binaire, tu dois créer une arborescence qui
contient tous les fichiers et répertoires que tu veux retrouver dans les
données du système de fichier du paquet. Dans les paquets Debian format
source, ce répertoire est habituellement <code>debian/tmp</code>, par rapport à la
racine de l'arborescence du paquet source.<P>

Ils doivent avoir l'emplacement (par rapport à la racine de
l'arborescence que tu construis), le propriétaire et les permissions que
tu veux leur assigner sur le système quand ils sont installés.<P>

Dans la version courante de <code>dpkg</code>, l'uid (ou nom de l'utilisateur)
et le gid (ou le nom du groupe) pour les utilisateurs et les groupes
utilisés doivent être les mêmes sur le système où le paquet est
construit et sur le système où il sera installé.<P>

Tu dois ajouter un répertoire spécial à la racine de cette mini
arborescence que tu as créée: <code>DEBIAN</code>. Il doit contenir les
fichiers de contrôle d'information, notamment le fichier de contrôle des
paquets binaires (voir <A href="#s-binaires-3">Le fichier principal d'information de contrôle: control, section 2.3</A>).<P>

Le répertoire <code>DEBIAN</code> n'apparaîtra pas dans l'archive du système
de fichiers du paquet, et ainsi ne sera pas crée quand le paquet sera
installé.<P>

Quand tu prépares, tu dois appeler:
<pre>dpkg --build directory</pre>

Cette commande construit le paquet dans <em>directory</em><code>.deb</code>
(<code>dpkg</code> sait que <code>--built</code> est une option de <code>dpkg-deb</code>,
donc il appelle <code>dpkg-deb</code> avec les mêmes arguments pour construire
le paquet.)<P>

Voir les pages de manuel <code>dpkg-deb(8)</code>
sur les détails pour savoir comment examiner le contenu de ce fichier
fraîchement créé.<P>

Tu trouveras les sorties des commandes suivantes intéressantes:
<pre>dpkg-deb --info nomdefichier.deb
dpkg-deb --contents nomdefichier.deb
dpkg --contents nomdefichier.deb</pre>

Pour voir le fichier copyright d'un paquet, tu peux utiliser la
commande:
<pre>dpkg --fsys-tarfile nomdufichier.deb | tar xof
usr/doc/\*copyright | less</pre>


<hr>
<h2><A name="s-binaires-2">
2.2 Les fichiers d'information de contrôle de paquet
</A></h2>

La partie d'information de contrôle d'un paquet binaire est une
collection de fichiers avec des noms connus de <code>dpkg</code>.
Il traitera le contenu de ces fichiers d'une manière spéciale -
certains d'entre eux contiennent des informations utilisées par
<code>dpkg</code> quand il installe ou enlève le paquet; les autres sont des
script que le mainteneur du paquet veut que <code>dpkg</code> exécute.<P>

Il est possible de mettre d'autres fichiers dans la zone de contrôle du
paquet, mais ce n'est pas généralement une bonne idée (de toute façon
ils seront ignorés).<P>

Voici une liste brève de fichiers d'information de contrôle utilisés par
<code>dpkg</code> et un résumé de ce qu'ils fonts.

<dl>
<dt><code>control</code><dd>C'est le fichier clé de description utilisé par <code>dpkg</code>. Il
spécifie le nom et la version du paquet, donne sa description pour les
utilisateur, établit les relations avec les autres paquets, etc.
Voir <A href="#s-binaires-3">Le fichier principal d'information de contrôle: control, section 2.3</A>.<P>
Il est habituellement généré automatiquement à partir des informations
du paquet source par le programme <code>dpkg-gencontrol</code> et avec l'aide
de <code>dpkg-shlibdeps</code>.  Voir <A href="ch-sources.html#s-sources-1">Les outils pour manipuler les paquets sources, section 3.1</A>.
<p><dt><code>postinst, preinst, postrm, prerm</code><dd>Ce sont des fichiers exécutables (habituellement des scripts) que
<code>dpkg</code> démarre pendant l'installation, la mise à jour ou
l'effacement des paquets. Ils permettent au paquet de traiter les choses
qui lui sont particulières ou qui nécessitent un traitement plus
compliqué que celui fourni par <code>dpkg</code>. Les détails de quand et
comment ils sont appelés, sont indiqués dans les scripts de maintenance
des paquets et la procédure d'installation voir <A href="ch-maintenance.html">Script de maintenance de paquet et procédure d'installation, chapter 6</A>.<P>

Il est très important de rendre ces scripts idempotents
<A href="footnotes.html#2" name="fr2">[2]</A>.
Si une erreur survient, l'utilisateur interrompt <code>dpkg</code> ou si
d'autres problèmes se produisent, tu ne laisses pas l'utilisateur avec
un paquet inutilisable.<P>

Les scripts de maintenance sont garantis pour fonctionner avec un
terminal de contrôle et peuvent interagir avec l'utilisateur. S'ils ont
besoins de demander les mots de passe, utilise une interaction plein
écran ou quelque chose de similaire, tu dois faire cela vers et à partir
de <code>/dev/tty</code>, étant donné que <code>dpkg</code> redirigera à certains
points les entrées/sorties standards du script afin d'enregistrer la
procédure d'installation. Cependant, car ces scripts doivent être
exécutés sur la sortie standard redirigée dans un tube pour les besoins
d'enregistrement, les scripts Perl doivent être non bufférisés en sortie
en indiquant <code>$|=1</code> afin que la sortie soit imprimée immédiatement
plutôt que d'être bufférisé.<P>

Chaque script doit retourner zéro pour un succès ou autre chose que zéro
pour un échec.<P>
<p><dt><code>conffiles</code><dd>Ce fichier contient une liste de fichiers de configuration qui
doivent être manipulés automatiquement par <code>dpkg</code> 
(voir <A href="ch-conf.html">Manipulation des fichiers de configuration, chapter 9</A>).
Note que tous les fichiers de configuration ne sont pas forcément listés
ici.
<p><dt><code>shlibs</code><dd>Ce fichier contient une liste des librairies partagées fourni par
le paquet avec les détails des dépendances pour chacune. Il est utilisé
par <code>dpkg-shlibdeps</code> quand il détermine quelles dépendances sont
nécessaires dans un fichier de contrôle de paquet. Le format du fichier
<code>shlibs</code> est décrit dans <A href="ch-partages.html#s-partages-1">Le format du fichier <code>shlibs</code>, section 12.1</A>.
<p></dl>


<hr>
<h2><A name="s-binaires-3">
2.3 Le fichier principal d'information de contrôle: control
</A></h2>

Le fichier d'information de contrôle le plus important utilisé par
<code>dpkg</code> quand il installe un paquet est <code>control</code>. Il contient
toutes les statistiques vitales du paquet.<P>

Les fichiers d'information de contrôle des paquets binaires construits
à partir des sources Debian sont faits par un outil spécial <code>dpkg-
gencontrol</code> qui lit <code>debian/control</code> et <code>debian/changelog</code>
pour trouver les informations dont il a besoin.
voir <A href="ch-sources.html">Les paquets sources, chapter 3</A> pour plus de détails.<P>

Les champs dans les fichiers de contrôle des paquets binaires est:
<dl>
<dt><code>Package</code><dd>(obligatoire)
<p><dt><code>Version</code><dd>(obligatoire)
<p><dt><code>Architecture</code><dd>(obligatoire<A href="footnotes.html#3" name="fr3">[3]</A>)
<p><dt><code>Depends, Provides</code><dd>et al.
<p><dt><code>Essential</code><dd><p><dt><code>Maintener</code><dd><p><dt><code>Section, Priority</code><dd><p><dt><code>Source</code><dd><p><dt><code>Description</code><dd><p><dt><code>Installed-Size</code><dd><p></dl>


Une description de la syntaxe des fichiers de contrôle et le but de ces
champs sont disponibles dans <A href="ch-controles.html">Les fichiers de contrôle et leurs champs, chapter 4</A>.
<hr>
Le manuel de programmation de dpkg
- <A href="index.html#copyright">Copyright ©1996 Ian Jackson
Copyright ©1997 David Curé et Christian Jacolot pour
           la version française.</A>
<br>
<A href="index.html#toc">Table des matières</A>; <A href="index.html#abstract">résumé</A>; <A href="ch-sources.html">suivant</A>; <A href="ch-intro.html">précédent</A>.
<br>
<address>20 décembre 1997<br>
D. Cure <A href="mailto:cure@cnam.fr">cure@cnam.fr</A><br>
C. Jacolot <A href="mailto:jacolot@ubolib.univ-brest.fr">jacolot@ubolib.univ-brest.fr</A></address>
</body></html>