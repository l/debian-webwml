<html><head>
<title>Le manuel de programmation de dpkg - Configuration d'init
</title>
<link rev=made href="mailto:cure@cnam.fr">
</head><body>
<h1>
Le manuel de programmation de dpkg - chapitre 13<br>
Configuration d'init

</h1>
<hr>
<h2><A name="s-confinit-1">
13.1 Introduction à la structure de <code>init.d</code>
</A></h2>

Le répertoire <kbd>/etc/init.d</kbd> contient les scripts démarrés par
<kbd>init</kbd> quand l'état du niveau d'exécution est changé (voir
<code>init(8)</code>).<P>

Ces scripts sont référencés par des liens symboliques dans les
répertoires <code>/etc/rc</code><em>n</em><code>.d</code>. Quand on change le
niveau d'exécution, <kbd>init</kbd> recherche dans le répertoire 
<code>/etc/rc</code><em>n</em><code>.d</code> le script à exécuter, où
<em>n</em> est le niveau d'exécution à atteindre.<P>

Le nom des liens ont tous la forme <code>S</code><em>mmscript</em> 
ou <code>K</code><em>mmscript</em> où <em>mm</em> correspond à 2 chiffres
et <em>script</em> est le nom du script (il doit être le même que le
nom du script réel dans <code>/etc/init.d</code>). Quand <kbd>init</kbd>
change le niveau d'exécution, d'abord les cibles des liens dont les noms
commencent par <code>K</code> sont exécutées, chacune avec un seul argument
<code>stop</code>, suivi par les scripts préfixés par un <code>S</code>, chacun
avec l'argument <code>start</code>. Les liens <code>K</code> sont responsables de
l'arrêt des services et les liens <code>S</code> du démarrage des services
du nouveau niveau d'exécution.<P>

Par exemple, si nous passons du niveau 2 au niveau 3, <kbd>init</kbd>
exécutera d'abord tous les scripts préfixés par <code>K</code> qu'il trouve
dans <code>/etc/rc3.d</code> et ensuite tous les scripts préfixés par
<code>S</code>. Les liens commençant par <code>K</code> amèneront le fichier
référencé à s'exécuter avec l'argument <code>stop</code>, et les liens
<code>S</code> avec un argument <code>start</code>.<P>

Les 2 chiffres <em>mm</em> sont utilisés pour décider dans quel ordre
démarrer et arrêter les choses. Les liens exécutent leurs scripts dans
un ordre croissant. Par exemple les scripts <code>K20</code> seront exécutés
avant les scripts <code>K30</code>. Cela est utilisé quand certains services
doivent démarrer avant d'autres. Par exemple, le serveur de nom
<kbd>bind</kbd> doit être démarré avant le serveur de news <kbd>inn</kbd>
afin qu'<kbd>inn</kbd> puisse positionner ses listes d'accès. Dans ce cas,
le script qui démarre <kbd>bind</kbd> doit avoir un plus petit numéro que
le script qui lance <kbd>inn</kbd> pour démarrer d'abord:

<pre>    /etc/rc2.d/S17bind
    /etc/rc2.d/S70inn</pre>

<hr>
<h2><A name="s-confinit-2">
13.2 Ecrire des scripts <code>init.d</code>
</A></h2>

Les paquets peuvent et doivent placer les scripts dans
<code>/etc/init.d</code> pour démarrer ou arrêter les services au démarrage
ou pendant un changement de niveau d'exécution. Ces scripts doivent être
nommées <code>/etc/init.d/</code><em>package</em>, et ils doivent accepter
un argument: <code>start</code> signifiant de démarrer le service, ou
<code>stop</code> pour arrêter le service. Facultativement, ils peuvent
supporter l'argument <code>reload</code> qui provoque le rechargement de la
configuration.<P>

Les scripts doivent s'assurer qu'ils se comporteront judicieusement,
s'ils sont invoqués avec l'option <code>start</code> quand le service est
déjà en action, ou <code>stop</code> s'il ne l'est pas, et qu'ils ne tuent
pas fortuitement les process des utilisateurs.<P>
 La meilleure façon de
réaliser cela est d'utiliser habituellement le programme
<kbd>start-stop-deamon</kbd>.<P>

Ces scripts ne doivent pas échouer de façon obscure quand les fichiers
de configuration persistent alors que le paquet a été enlevé, par défaut
<kbd>dpkg</kbd> laisse les fichiers de configuration dans le système après
que le paquet ait été enlevé. C'est seulement quand il est exécuté avec
l'option <code>--purge</code>, que <kbd>dpkg</kbd> enlèvera les fichiers de
configuration. Cependant, tu dois inclure une instruction de test au
début du script:

<pre>    test -f programme-exécuté-dans-le-script || exit 0</pre>

<hr>
<h2><A name="s-confinit-3">
13.3 Gestion des liens <code>rc</code><em>n</em><code>.d</code> - <code>update-rc.d</code>
</A></h2>

Un programme <kbd>update-rc.d</kbd> est fourni pour faciliter la
maintenance des paquets dans l'orchestration de la création et de la
destruction des liens symboliques de
<code>/etc/rc</code><em>n</em><code>.d</code> à partir de leurs scripts
<code>postinst</code> et <code>postrm</code>.<P>

Tu dois utiliser ce script pour réaliser les changements dans
<code>/etc/rc</code><em>n</em><code>.d</code> et jamais inclure n'importe quels liens
symboliques <code>/etc/rc</code><em>n</em><code>.d</code> dans l'archive réel.<P>

Par défaut, <kbd>update-rc.d</kbd> démarrera les services dans chacun des
niveaux d'état d'exécution multi-utilisateur (2, 3, 4, et 5) et les
arrêtent dans le niveau <kbd>halt</kbd> (0), niveau mono-utilisateur (1),
et le niveau <kbd>reboot</kbd> (6). L'administrateur système a
l'opportunité de personnaliser les niveaux d'exécution en ajoutant, en
déplaçant, ou en enlevant simplement les liens symboliques dans
<code>/etc/rc</code><em>n</em><code>.d</code>.<P>

Pour obtenir le comportement par défaut de ton paquet, mets dans ton
script <code>postinst</code>:

<pre>     update-rc.d package default &gt;/dev/null</pre>

et dans ton script <code>postrm</code>:

<pre>     if [ purge = &quot;$1&quot; ]; then
         update-rc.d package remove &gt;/dev/nul
     fi</pre>

Ceci utilisera un numéro de séquence par défaut à 20. Si on ne tient pas
compte de quand ou dans quel ordre le script est exécuté, utilise le numéro par
défaut. Sinon, tu dois demander un numéro 
au mainteneur du paquet <kbd>sysvinit</kbd>
ou dans la mailing list <code>debian-devel</code>,
ils t'aideront à en choisir un.<P>

Pour plus d'information sur l'utilisation d'<kbd>update-rc.d</kbd>,
consulte la page de manuel <code>update-rc.d(8)</code>.<P>

<hr>
<h2><A name="s-confinit-4">
13.4 Initialisation du démarrage - <code>rc.boot</code>
</A></h2>

Il y a un autre répertoire <code>/etc/rc.boot</code> qui contient les
scripts qui sont exécutés une fois par démarrage. Ce dispositif est
fournie pour l'initialisation de matériels périphériques,
nettoyage de fichiers, et ainsi de suite.<P>

Par exemple, le paquet <kbd>kbd</kbd> fournit un script pour
l'initialisation de la configuration clavier, la fonte et le mode de la
console.<P>

Les fichiers dans <code>/etc/rc.boot</code> ne doivent pas être liés dans
<code>/etc/init.d</code>. Ceux sont des scripts à part entière.<P>

<code>rc.boot</code> ne doit pas être utilisé pour démarrer des processus à
but général, et activités similaires. Ceci doit être fait en utilisant
la structure <code>rc</code><em>n</em><code>.d</code>, ci-dessus, afin que les
services puissent être démarrés et arrêtés proprement quand le niveau
d'exécution change ou quand la machine doit être éteinte ou rebootée.<P>

<hr>
<h2><A name="s-confinit-5">
13.5 Remarques
</A></h2>

Ne pas inclure les liens symboliques de
<code>/etc/rc</code><em>n</em><code>.d/*</code> dans l'archive <code>.deb</code> du
système de fichier! Cela amènera des problèmes! Tu dois les créer
avec <kbd>update-rc.d</kbd>, comme ci-dessus.<P>

Ne pas include les liens symboliques de
<code>/etc/rc</code><em>n</em><code>.d/*</code>
dans la liste de fichiers de configuration de <kbd>dpkg</kbd>! Cela
provoquera des erreurs! Il faut cependant inclure les scripts
<code>/etc/init.d</code> dans les fichiers de configuration.<P>

<hr>
<h2><A name="s-confinit-6">
13.6 Exemple
</A></h2>

Le paquet DNS <kbd>bind</kbd> (serveur de nom) veut être sûr que le
serveur de nom soit démarré dans les niveaux d'exécution
multi-utilisateurs, et proprement arrêté avec le système.
Il met un script dans <code>/etc/init.d</code> nommé <kbd>bind</kbd>.
Comme indiqué ci-dessous, le script interprète l'argument
<code>reload</code>, pour envoyer le signal
<code>HUP</code> au serveur de nom (provoquant le rechargement de sa
configuration). De cette façon, l'utilisateur peut taper
<code>/etc/init.d/bind reload</code> pour recharger 
la configuration du serveur de nom.<P>

<pre>   #!/bin/sh
   # Original version par Robert Leslie &lt;rob@mars.org&gt;, edited by iwj
   test -x /usr/sbin/named || exit 0
   case &quot;$1&quot; in
     start)
       test- f /etc/named.boot -a -f /var/name/boot.options || exit 0
       start-stop-deamon --start --verbose --exec /usr/sbin/named
       ;;
     stop)
       start-stop-deamon --stop --verbose \
          --pidfile /var/run/named.pid --exec /usr/sbin/named
       ;;
     reload)
       start-stop-deamon --stop --signal 1 --verbose \
          --pidfile /var/run/named.pid --exec /usr/sbin/named
       ;;
     *)
       echo &quot;Usage: /etc/init.d/bin {start|stop|reload}&quot; &gt;&amp;2
       exit 1
       ;;
   esac
   exit 0</pre>

Un autre exemple, sur lequel les scripts de <code>/etc/init.d</code> peuvent
se baser, se trouve dans <code>/etc/init.d/skeleton</code>.<P>

Si ce paquet se contente de la configuration par défaut donné par
<kbd>update-rc.d</kbd>, c'est à dire un numéro d'ordre égal à 20 et
mise en oeuvre dans tous les niveaux d'exécution, il est possible d'écrire
dans le script <code>postinst</code>:

<pre>    update-rc.d bind default &gt;/dev/null</pre>

Et dans son script <code>postrm</code>, la suppression du lien quand le paquet
est détruit:

<pre>    if [ purge = &quot;$1&quot; ]; then
        update-rc.d acct remove &gt;/dev/null
    fi</pre>


<hr>
Le manuel de programmation de dpkg
- <A href="index.html#copyright">Copyright ©1996 Ian Jackson
Copyright ©1997 David Curé et Christian Jacolot pour
           la version française.</A>
<br>
<A href="index.html#toc">Table des matières</A>; <A href="index.html#abstract">résumé</A>; <A href="ch-intdselect.html">suivant</A>; <A href="ch-partages.html">précédent</A>.
<br>
<address>20 décembre 1997<br>
D. Cure <A href="mailto:cure@cnam.fr">cure@cnam.fr</A><br>
C. Jacolot <A href="mailto:jacolot@ubolib.univ-brest.fr">jacolot@ubolib.univ-brest.fr</A></address>
</body></html>