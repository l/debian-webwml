<html><head>
<title>Le manuel de programmation de dpkg - Déclaration des relations entre les paquets</title>
<link rev=made href="mailto:cure@cnam.fr">
</head><body>
<h1>
Le manuel de programmation de dpkg - chapitre 8<br>
Déclaration des relations entre les paquets
</h1>
Les paquets peuvent déclarer dans leur fichier de contrôle qu'ils ont
certaines relations avec d'autres paquets - par exemple, qu'ils ne
peuvent pas être installés en même temps que certains autres paquets,
et/ou qu'ils dépendent de la présence d'autres, ou qu'ils doivent
écraser les fichiers dans certains autres paquets s'ils sont présents.<P>

Ceci est effectué en utilisant les champs du fichier de contrôle
<code>Depends, Recommends, Sugggests, Conflicts, Provides</code>  et
<code>Replaces</code>.<P>
<hr>
<h2><A name="s-relation-1">
8.1 La syntaxe des champs de relations
</A></h2>

Ces champs ont tous la même syntaxe uniforme. Ce sont des listes de
noms de paquets séparées par des virgules.<P>

Dans <code>Depends, Recommends, Suggests</code> et <code>Pre-Depends</code> (les
champs qui déclarent les dépendances du paquets dans lesquelles elles
apparaissent dans d'autres paquets), ces noms de paquet peuvent aussi
être des listes de noms de paquets alternatifs, séparés par des symboles
barre verticale | (symbole du tube de communication).<P>

Tous les champs sauf <code>Provides</code> peuvent restreindre leur
application à des versions particulières de chaque paquet nommé. C'est
indiqué entre parenthèses après chaque nom individuel de paquet; les
parenthèses devraient contenir une relation de la liste ci-dessous
suivie par un numéro de version, dans le format décrit dans
<A href="ch-versions.html">Numérotation des versions, chapter 5</A>.<P>

Les relations autorisées sont <code>&lt;&lt;, &lt;=, = &gt;=</code> et <code>&gt;&gt;</code> pour
strictement avant, avant ou égal, égal, après ou égal, strictement
après, respectivement. Les formes <code>&lt;</code> et <code>&gt;</code> ont été utilisées
pour signifier avant/après ou égal, plutôt que strictement avant/après,
ainsi ils ne doivent pas apparaître dans les nouveaux paquets (bien que
<code>dpkg</code> les supporte toujours).<P>

Les espaces peuvent apparaître n'importe où dans la spécification de
version, et doivent apparaître où cela est nécessaire pour
désambiguïser; autrement ils ne sont pas significatifs. Pour
l'uniformité et dans le cas de futurs changements à <code>dpkg</code>, il est
recommandé qu'un seule espace soit utilisé après une relation de version
et avant un numéro de version; il est aussi convenu de mettre un espace
après chaque virgule, de chaque côté d'une barre verticale, et avant
chaque parenthèse ouvrante.<P>

Par exemple:
<pre>Package: metamail
Version: 2.7-3
Depends: libc5 (&gt;= 5.2.18-4), mime-support, csh | tcsh</pre><P>
<hr>
<h2><A name="s-relation-2">
8.2 Les dépendances - <code>Depends, Recommends, Suggests, Pre-
Depends</code>
</A></h2>

Ces quatre champs sont utilisés pour déclarer une dépendance d'un
paquet sur un autre. Ils apparaissent dans le fichier de contrôle
dépendant du paquet.<P>

Tous, sauf <code>Pre-Depends</code> (voir ci-dessous) prennent effet seulement
quand un paquet est configuré. Ils n'empêchent pas un paquet d'être sur
le système dans un état non configuré alors que ses dépendances sont non
satisfaites, et il est possible de remplacer un paquet dont les
dépendances sont satisfaites et qui est proprement installé par une version différente
dont les dépendances ne sont pas et ne peuvent pas être satisfaites;
quand c'est le cas, le paquet dépendant sera laissé non configuré (étant
donnée que les tentatives pour le configurer, donneront des erreurs) et
ne fonctionnera pas correctement.<P>

Pour cette raison, les paquets dans une installation sont généralement
tous installés d'abord et tous configurés ensuite; ceci donne les
dernières versions des paquets avec les dépendances sur les dernières
versions des autres paquets, l'opportunité d'avoir leurs dépendances
satisfaites.<P>

Ainsi <code>Depends</code> autorise les mainteneurs de paquets d'imposer un
ordre sur la configuration des paquets.

<dl>
<dt>Depends<dd>Ceci déclare une dépendance absolu.<P>
<kbd>dpkg</kbd> ne configurera pas les paquets dont les dépendances ne sont pas
satisfaites. S'il est demandé de faire une installation qui ne satisfait
pas les dépendances d'un paquet installé, il produira une
erreur<A href="footnotes.html#22" name="fr22">[22]</A>, à moins que
<code>--auto-deconfigure</code> ne soit spécifié, dans quel cas, ces paquets
seront déconfigurés avant la procédure d'installation.<P>

<code>dselect</code> rend difficile pour l'utilisateur la sélection des
paquets pour l'installation, l'effacement ou la mise à jour de façon à
ce que les champs <code>Depends</code> des paquets soient insatisfaits.
L'utilisateur peut écraser cela s'il veut, par exemple s'ils savent que
<code>dselect</code> a une vue périmée des relations réelles des paquets.<P>

Le champ <code>Depends</code> devrait être utilisé si le paquet d'appui est
nécessaire pour le paquet dépendant pour fournir une quantité
significative de fonctionnalités.<P>
<p><dt>Recommends<dd>ceci déclare une forte, mais pas absolue, dépendance.<P>
<code>Recommends</code> est ignoré par <code>dpkg</code>, afin que les utilisateurs
utilisant la ligne de commande (en supposant savoir ce qu'ils font) ne
soient pas gênés.<P>
Il est traité par <code>dselect</code> exactement comme <code>Depends</code>; ce qui
rend difficile pour l'utilisateur de sélectionner les choses de façon à
laisser les champs <code>Recommends</code> non satisfaits, mais ils sont
capable de le faire en étant persistent.<P>
Le champ <code>Recommends</code> devrait lister les paquets qui devraient être
liés entre eux à celui-ci pour tout sauf les installations
inhabituelles.<P>
<p><dt>Suggests<dd>C'est utilisé pour déclarer qu'un paquet peut être plus utile avec
un ou plusieurs autres. En utilisant ce champ, on indique au système de
paquet et à l'utilisateur que les paquets listés sont liés au paquet et
peuvent peut-être augmenter son utilité, mais que l'installation du
paquet sans eux est parfaitement concevable.<P>

<code>dselect</code> offrira les paquets suggérés à l'administrateur du
système quand ils sélectionnent les paquets suggérés, mais par défaut,
il n'installe pas les paquets suggérés.<P>
<p><dt>Pre-Depends<dd>Ce champ ressemble à <code>Depends</code>, sauf qu'il force aussi
<code>dpkg</code> à compléter l'installation des paquets nommés avant même de
démarrer l'installation du paquet qui déclare les pré-dépendances.<P>

<code>dselect</code> vérifie les pré-dépendances quand il fait une
installation, et essayer de trouver les paquets qui sont nécessairement
installés avant et le fait dans le bon ordre.<P>

Cependant, ce processus est lent (car il nécessite des appels répétés à
<code>dpkg</code>) et pénible (car il nécessite de deviner où se trouvent les
fichiers appropriés).<P>

Pour ces raisons, et car ce champ impose des restrictions sur l'ordre
dans lequel les paquets doivent être installés (ce qui peut-être
difficile pour des installation à partir de média différent, par
exemple). <code>Pre-Depends</code> devrait être utilisé avec modération, de
préférence seulement pour les paquets dont la mise à jour prématuré
ou l'installation pourrait entraver la capacité du système de continuer
les mises à jour en cours.<P>
Quand le paquet déclarant qu'il a été configuré, une <code>Pre-
Dependency</code> sera considérée satisfaite seulement si le paquet
dépendant a bien été configuré, juste comme ci une <code>Depends</code>
ordinaire avait été utilisé.<P>

Cependant, quand un paquet déclarant un pré-dépendance est installé, la
pré-dépendance peut être satisfaite même si le ou les paquets d'appui
sont seulement installés ou à moitié configurés, indiquant qu'ils ont
été correctement installés à un moment dans la passé (et pas effacés ou
partiellement effacés depuis). Dans ce cas, les deux versions
précédemment configurées et en cours d'installation ou à moitié
configurées doivent satisfaire n'importe quelle clause de version du
champ <code>Pre-Depends</code>.<P>
<p></dl>


Quand on sélectionne le niveau de dépendance à utiliser, tu dois
considéré l'impact des fonctionnalité du paquet d'appui sur le paquet
déclarant la dépendance. Certains paquets sont constitués de composants
de différents niveaux d'importance. De tel paquet devrait lister en
utilisant <code>Depends</code>, le ou les paquets qui sont nécessaires par les
composants les plus importants. Les autres composants exigés peuvent
être mentionnés comme Suggestions ou Recommendations, en fonction de
l'importance du composant.<P>
<hr>
<h3><A name="s-relation-2-1">
8.2.1 Les dépendances sur les librairies partagées
</A></h3>

Les champs de dépendance listés ci-dessus sont utilisés par les paquets
qui ont besoin de librairies partagées pour déclarer les dépendances sur
les paquets appropriés.<P>

Ces dépendances sont généralement déterminées automatiquement en
utilisant <code>dpkg-shlibdeps</code> et insérées dans le fichier de contrôle
du paquet en utilisant le mécanisme de substitutions de variables du
fichier de contrôle; voir  <A href="ch-sources.html#s-sources-2-3"><code>debian/substvars</code> et substitutions de variables, subsection 3.2.3</A> et 
<A href="ch-sources.html#s-sources-1">Les outils pour manipuler les paquets sources, section 3.1</A>.<P>
<hr>
<h3><A name="s-relation-2-2">
8.2.2 Déconfiguration à cause d'effacement pendant les
installations
</A></h3>

Si <code>dpkg</code> veux effacer un paquet à cause d'un conflit, comme décrit
ci-dessus, mais en violation avec une dépendance de certains autres
paquets sur le système, <code>dpkg</code> n'effacera généralement pas le
paquet en conflit et s'arrêtera sur une erreur.<P>

Cependant, si l'option <code>--auto-deconfigure (-B)</code> est utilisée,
<code>dpkg</code> déconfigurera automatiquement le paquet avec la dépendance
problématique, afin que le paquet en conflit puisse être enlevé et le
paquet à installer puisse être installé. Si <code>dpkg</code> est appelé pour
installer des paquets (plutôt que juste les dépaqueter), il essayera de
reconfigurer le paquet quand il aura dépaqueté tous ces arguments, dans
l'espoir qu'un des autres paquets qu'il installe, satisfera la
dépendance problématique.<P>

<code>dselect</code> fournit ces arguments à <code>dpkg</code> quand il l'appelle,
afin de procéder aux installations facilement.<P>
<hr>
<h2><A name="s-relation-3">
8.3 Les paquets alternatifs - <code>Conflicts</code> et
<code>Replaces</code>
</A></h2>
Quand un paquet déclare un conflit avec un autre, <code>dpkg</code> refusera
de les installer sur le système en même temps.<P>
Si un paquet est installé, les autres doivent être enlevé d'abord - si
le paquet en cours d'installation est marqué comme remplacement
(voir <A href="#s-relation-5"><code>Replaces</code> - écraser les fichiers et remplacer les
paquets, section 8.5</A>) du paquet sur le système, ou si celui du système est marqué comme
désélectionner, ou les deux paquets sont marqués <code>Essential</code>, alors
<code>dpkg</code> enlèvera automatiquement le paquet qui provoque le conflit,
autrement il arrête l'installation des nouveaux paquets par une erreur.<P>
<code>dselect</code> rend difficile la sélection des paquets en conflit, bien
que l'utilisateur puisse l'annuler s'il le veut. S'ils ne sont pas
annulés alors <code>dselect</code> sélectionnera un des paquets pour
l'effacer, et l'utilisateur doit être sûr que c'est le bon. Dans le
futur, <code>dselect</code> vérifiera la présence d'un champ <code>Replaces</code>
pour décider quel paquet doit être installé et lequel enlevé.<P>

Un paquet ne provoquera pas de conflit, simplement car ses fichiers de
configuration sont toujours installés; il doit être au moins à moitié
installé.<P>

Une exception spéciale est faite pour les paquets qui déclare un conflit
avec leur propre nom de paquet, ou avec un paquet virtuel qu'ils
fournissent (voir ci-dessous); cela n'empêche pas leurs installations,
et autorise un paquet d'être en conflit avec d'autres fournissant un
remplacement pour lui. Tu peux utiliser ce dispositif quand tu veux que
le paquet en question soit le seul paquet fournissant quelque chose.<P>
Une entrée <code>Conflicts</code> ne devrait presque jamais avoir une clause de
version 'avant'. Ceci devait empêcher <code>dpkg</code> de mettre à jour ou
d'installer le paquet qui déclare un tel conflit jusqu'à ce que la mise
à jour ou l'effacement du paquet en conflit soient résolus. Cet aspect
de l'ordre d'installation n'est pas géré par <code>dselect</code>, afin que
l'utilisation de <code>Conflicts</code> provoque des problèmes pour les mises à jour
et les installations.<P>
<hr>
<h2><A name="s-relation-4">
8.4 Les paquets virtuels - <code>Provides</code>
</A></h2>
Aussi bien que les noms de paquets concrets (réels), les champs de
relations de paquet <code>Depends, Recommends, Suggests</code> et
<code>Conflicts</code> peuvent mentionner des paquets virtuels.<P>

Un paquet virtuel est un paquet qui apparaît dans le champ
<code>Provides</code> du fichier de contrôle d'un autre paquet. L'effet est
comme ci le ou les paquets qui fournissent un nom particulier de paquet
virtuel avaient été listés par nom partout le nom du paquet virtuel
apparaît.<P>
Si il y a deux paquets, un réel et un virtuel du même nom alors la
dépendance peut être satisfaite (or le conflit provoqué par) soit par le
paquet réel ou n'importe quels paquets virtuels que la fournit.
Par exemple, nous avons:
<pre>Package: vm
Depends: emacs</pre>
Et quelqu'un d'autre met à jour un paquet xemacs, ils peuvent dire:
<pre>Package: xemacs
Provides: emacs</pre>

Et tout fonctionnera entre temps (jusqu'à ce qu'un nom de paquet
purement virtuel est décidé et les paquets <code>emacs</code> et <code>vm</code>
soient modifiés pour l'utiliser).<P>

Si une dépendance ou un conflit a un numéro de version attaché alors
seuls les paquets réels seront considérés pour voir si la relation est
satisfaite (ou la prohibition violée, pour un conflit) - on supposera
qu'un paquet réel qui fournit un paquet virtuel n'est pas la bonne
version. Ainsi, un champ <code>Provides</code> ne doit pas contenir de numéros
de version, et le numéro de version d'un paquet concret qui fournit un
paquet virtuel particulier ne le regardera pas quand on considère une
dépendance ou un conflit avec le nom du paquet virtuel.<P>
Si tu veux spécifier quel paquet d'un ensemble de paquets réels
devrait être celui satisfait par défaut une dépendance particulière sur
un paquet virtuel, tu devrais lister le paquet réel comme alternatif
avant le paquet virtuel.<P>
<hr>
<h2><A name="s-relation-5">
8.5 <code>Replaces</code> - écraser les fichiers et remplacer les
paquets
</A></h2>

Le champ <code>Replaces</code> du fichier de contrôle a deux buts qui entre en
jeu dans des situations différentes.<P>

Les paquets virtuels (voir <A href="#s-relation-4">Les paquets virtuels - <code>Provides</code>, section 8.4</A>) ne sont
pas considérés quand on regarde le champ <code>Replaces</code> - les paquets
déclarés comme étant remplacés doivent être mentionnés par leurs noms
réels.<P>
<hr>
<h3><A name="s-relation-5-1">
8.5.1 Ecraser les fichiers dans les autres paquets.
</A></h3>

Tout d'abord, comme mentionné avant, c'est généralement une erreur pour
un paquet de contenir des fichiers qui sont sur le système dans un autre
paquet, bien que couramment l'option <code>--force-overwrite</code> soit mise
par défaut, déclassant l'erreur en avertissement.<P>

Si le paquet qui écrase déclare qu'il remplace l'ancien contenant le
fichier qui doit être écrasé alors <code>dpkg</code> le traitera, et
remplacera le fichier de l'ancien paquet par le nouveau. Le fichier ne
sera plus listé comme faisant partie de l'ancien paquet.<P>

Si un paquet est complètement remplacé de cette façon, afin que
<code>dpkg</code> ne sait pas quels fichiers il contient, il est considéré
comme ayant disparu. Il sera marqué comme non sélectionné sur le système
(sélectionné pour l'effacement) et non installé. tous les détails des
conffiles notés dans le paquet seront ignorés, comme ils seront pris par
le paquet qui le remplace. Le script <code>postrm</code> du paquet sera
exécuté pour permettre au paquet de faire le nettoyage final nécessaire.
Voir <A href="ch-maintenance.html#s-maintenance-2">Résumé des façons dont les scripts de maintenance sont
appelés, section 6.2</A>.<P>

Dans le futur, <code>dpkg</code> écartera les fichiers qui écrasent ceux d'un autre
paquet qui déclare qu'il remplace celui qui est en cours d'installation
(afin de pouvoir installer une version plus ancienne d'un paquet sans
problèmes).<P>

L'usage de <code>Replaces</code> prend seulement effet quand deux paquets sont
au moins partiellement sur le système à la fois, cela peut seulement se
produire s'ils ne sont pas en conflits, ou si le conflit a été annulé.<P>
<hr>
<h3><A name="s-relation-5-2">
8.5.2 Remplacer tous les paquets, forcer leur effacement
</A></h3>
Deuxièmement, <code>Replaces</code> permet à <code>dpkg</code> et <code>dselect</code> de
résoudre quel paquet doit être enlevé quand il y a un conflit - voir
<A href="#s-relation-3">Les paquets alternatifs - <code>Conflicts</code> et
<code>Replaces</code>, section 8.3</A>. Cet usage
prend seulement effet quand deux paquets sont en conflit, afin que les
deux effets n'interfèrent pas l'un avec l'autre.<P>
<hr>
<h2><A name="s-relation-6">
8.6 Options pour satisfaire les dépendances - tri
</A></h2>

Le tri est significatif dans les champs de dépendance.<P>
Généralement, dselect suggérera à l'utilisateur qu'ils sélectionnent le
paquet avec la classe la plus 'fondamental' (il préférera les paquets de
Base plutôt que les paquets optionnels), ou le paquet qu'ils veulent le
plus sélectionner, dans un certain sens.<P>

En l'absence d'autres informations, <code>dselect</code> offrira une sélection
par défaut des premiers paquets nommés de la liste des alternatives.<P>

Cependant, il n'y a aucun moyen de spécifier l'ordre de plusieurs
paquets qui fournissent tous la même chose quand cette chose est listée
comme dépendance.<P>
Donc, une dépendance sur un paquet virtuel devrait contenir un nom de
paquet concret comme première alternative par défaut.<P>

Par exemple, considérons l'ensemble de paquets suivant:
<pre>Package: glibcdoc
Recommends: info-browser

Package: info
Provides: info-browser

Package emacs
Provides: info-browser</pre>

Si <code>emacs</code> et <code>info</code> ont tous les deux la même priorité alors
le choix <code>dselect</code> est essentiellement aléatoire. Le mieux serait:
<pre>Package: glibcdoc
Recommends: info | info-browser</pre>

afin que <code>dselect</code> sélectionne l'info-browser.<P>



<hr>
Le manuel de programmation de dpkg
- <A href="index.html#copyright">Copyright ©1996 Ian Jackson
Copyright ©1997 David Curé et Christian Jacolot pour
           la version française.</A>
<br>
<A href="index.html#toc">Table des matières</A>; <A href="index.html#abstract">résumé</A>; <A href="ch-conf.html">suivant</A>; <A href="ch-descript.html">précédent</A>.
<br>
<address>20 décembre 1997<br>
D. Cure <A href="mailto:cure@cnam.fr">cure@cnam.fr</A><br>
C. Jacolot <A href="mailto:jacolot@ubolib.univ-brest.fr">jacolot@ubolib.univ-brest.fr</A></address>
</body></html>