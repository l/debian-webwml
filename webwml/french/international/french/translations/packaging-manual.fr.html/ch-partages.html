<html><head>
<title>Le manuel de programmation de dpkg - Les librairies partagées</title>
<link rev=made href="mailto:cure@cnam.fr">
</head><body>
<h1>
Le manuel de programmation de dpkg - chapitre 12<br>
Les librairies partagées
</h1>

Les paquets contenant les librairies partagées doivent être construits
avec un peu de soin pour être sûr que les librairies partagées soient
toujours disponibles. C'est spécialement important pour les paquets dont
les librairies sont vitalement important, tel que la libc.<P>

Tout d'abord, ton paquet devrait installer les librairies partagés sous
leurs noms normaux. Par exemple, le paquet <code>libgdbm1</code> devrait
installer <code>libgdbm.so.1.7.3</code> comme
<code>/usr/lib/libgdbm.so.1.7.3</code>. Les fichiers ne devraient pas être
renommés ou liés par les scripts prerm et postrm; <code>dpkg</code> s'occupera
de renommer les choses doucement sans troubler les programmes exécutés
et essayer d'interférer avec lui mène aux problèmes.<P>

Ensuite, ton paquet doit inclure le lien symbolique que <code>ldconfig</code>
doit créer pour les librairies partagées. Par exemple, le paquet
<code>libgdbm1</code> doit inclure un lien symbolique de
<code>/usr/lib/libgdbm.so.1.7.3</code> vers <code>libgdbm.so.1.7.3</code>. Ceci est
nécessaire pour que <code>ld.so</code> trouve la librairie pendant que
<code>dpkg</code> l'installe et <code>ldconfig</code> est exécuté dans le script
<code>postinst</code>. De plus, et <em>c'est important</em>, la librairie doit
être placée avant le lien qui pointe sur elle dans le fichier
<code>.deb</code>. C'est afin que le temps que <code>dpkg</code> installe le lien
symbolique (en écrasant le lien précédent pointant sur une version plus
ancienne de la librairie), la nouvelle librairie soit déjà en place.
Pour l'instant, la seule façon d'assurer que l'ordre est respecté est
d'installer la librairie dans le répertoire <code>debian/tmp/.../lib</code>
approprié avant de créer le lien symbolique, en mettant les commandes
dans <code>debian/rules</code> dans l'ordre approprié.<P>

Troisièmement, le paquet de développement devrait contenir un lien
symbolique pour la librairie partagée sans un numéro de version. Par
exemple, le paquet <code>libgdbm1-dev</code> devrait inclure un lien
symbolique de <code>/usr/lib/libgdbm.so</code> vers <code>libgdbm.so.1.7.3</code>.
Ce lien symbolique est nécessaire pour <code>ld</code> quand il compile les
paquets, il cherchera seulement <code>libgdbm.so</code> et <code>libgdbm.a</code>
pour compiler dynamiquement ou statiquement, respectivement.<P>

Si tu fait ce qu'il y a au dessus, ton paquet n'a pas besoin d'appeler
<code>ldconfig</code> dans ses scripts de maintenance. C'est spécialement
important de ne pas appeler <code>ldconfig</code> dans les scripts postrm ou
preinst dans le cas où le paquet est mis à jour 
voir <A href="ch-maintenance.html#s-maintenance-3">Détails des phases d'installation et de mise à jour, section 6.3</A>),
étant donné que <code>ldconfig</code> verra les noms temporaires que <code>dpkg</code>
utilise pour
les fichiers pendant leur installation et fera les liens des librairies
partagées pointer sur eux, juste avant que <code>dpkg</code> continue
l'installation et enlève les liens !!!<P>
<hr>
<h2><A name="s-partages-1">
12.1 Le format du fichier <code>shlibs</code>
</A></h2>
Ce fichier est utilisé par <code>dpkg-shlibdeps</code> et est nécessaire quand
ton paquet fourni des librairies partagées.<P>

Chaque ligne est de la forme:
<pre>nom-librairie version-ou-ainsinommé dépendances ...</pre>

<em>nom-librairie</em> est le nom de la librairie partagée, par exemple
<code>libc5</code>.<P>

<em>version-ou-ainsinommé</em> est le nom de la librairie - c'est à dire
la chose qui doit coller exactement pour que la librairie soit reconnue
par <code>ld.so</code>.  Généralement, c'est le numéro majeur de la version de
la librairie.<P>

<em>dépendances</em> a la même syntaxe que le champ dépendance dans le
fichier de contrôle des paquets binaires. Il devrait donner les détails
sur quels paquets sont nécessaires pour satisfaire une construction
binaire par rapport à la version de librairie contenue dans le paquet.
Voir <A href="ch-relation.html#s-relation-1">La syntaxe des champs de relations, section 8.1</A>.<P>

Par exemple, si le paquet <code>foo</code> contient <code>libfoo.so.1.2.3</code> ou
le nom de la librairie est <code>libfoo.so.1</code>, et la première version du
paquet qui contient les numéros mineurs d'au moins <code>2.3</code> était
<em>1.2.3-1</em>, alors le <em>shlibs</em> du paquet peut dire:
<pre>libfoo 1	foo (&gt;= 1.2.3-1)</pre>

La dépendance de version spécifique est d'éviter les avertissements de
<code>ld.so</code> sur l'utilisation des anciennes librairies partagées avec
des nouveaux binaires.<P>
<hr>
<h2><A name="s-partages-2">
12.2 Davantage d'informations techniques sur <code>shlibs</code>
</A></h2>
<hr>
<h3><A name="s-partages-2-1">
12.2.1 Que sont les fichiers <code>shlibs</code>?
</A></h3>
Le fichier <code>debian/shlibs</code> fournit une façon de vérifier les
dépendances des librairies partagées des paquets binaires.
Ils sont utilisés par les mainteneurs de paquet pour rendre leur vie
plus facile.<P>
Les autres fichiers <code>shlibs</code> qui existent sur un système Debian
sont:
<ul>
<li><code>/etc/dpkg/shlibs.default</code><p><li><code>/etc/dpkg/shlibs.override</code><p><li><code>/var/lib/dpkg/info/*.shlibs</code><p><li><code>debian/shlibs.local</code><p></ul>


Ces fichiers sont utilisés par <code>dpkg-shlibdeps</code> à la création d'un
paquet binaire.<P>
<hr>
<h3><A name="s-partages-2-2">
12.2.2 Comment fonctionne <code>dpkg-shlibdeps</code>?
</A></h3>
<code>dpkg-shlibdeps</code> appelle <code>ldd</code> pour déterminer les librairies
partagées utilisées par les binaires compilés passés en paramètre sur sa
ligne de commande.<P>
Pour chaque librairie partagée, <code>dpkg-shlibdeps</code> a besoin de savoir
<ul>
<li>le paquet contenant la librairie, et<p><li>le numéro de version de la librairie.<p></ul>


Il scrute le fichiers suivants dans l'ordre:
<ol>
<li><code>debian/shlibs.local</code><p><li><code>/etc/dpkg/shlibs.override</code><p><li><code>/var/lib/dpkg/info/*.shlibs</code><p><li><code>/etc/dpkg/shlibs.default</code><p></ol>

<hr>
<h3><A name="s-partages-2-3">
12.2.3 Qui maintient les nombreux fichiers <code>shlibs</code>?
</A></h3>
<ul>
<li><code>/etc/dpkg/shlibs.default</code> - le mainteneur de dpkg<p><li><code>/var/lib/dpkg/info/</code><em>paquet</em><code>.shlibs</code> - le
mainteneur de chaque paquet<p><li><code>/etc/dpkg/shlibs.override</code> - l'administrateur système local<p><li><code>debian/shlibs.local</code> - le mainteneur du paquet<p></ul>


Le fichier <code>shlibs.default</code> est géré par <code>dpkg</code>. Les
entrées dans <code>shlibs.default</code> qui sont fournies par <code>dpkg</code>,
sont juste là pour fixer les choses le temps que les paquets de
librairie partagée ont toutes leurs fichiers <code>shlibs</code>.<P>
<hr>
<h3><A name="s-partages-2-4">
12.2.4 Comment utiliser <code>dpkg-shlibdeps</code> et les fichiers <code>shlibs</code>?
</A></h3>
<hr>
<h4><A name="s-partages-2-4-1">
12.2.4.1 Si ton paquet ne fournit pas de librairie partagée
</A></h4>
Place un appel à <code>dpkg-shlibs</code> dans ton fichier
<code>debian/rules</code>. Si ton paquet contient seulement des binaires
(aucun scripts) utilise:
<pre>dpkg-shlibdeps debian/tmp/usr/{bin,sbin}/*</pre>

Si <code>dpkg-shlibdeps</code> ne se plaint pas, c'est bon. Sinon, tu dois
créer ton propre fichier <code>debian/shlibs.local</code>.<P>
<hr>
<h4><A name="s-partages-2-4-2">
12.2.4.2 Si ton paquet fournit une librairie partagée
</A></h4>
Crée un fichier <code>debian/shlibs</code> et laisse <code>debian/rules</code>
l'installer dans la zone de contrôle:
<pre>install -m644 debian/shlibs debian/tmp/DEBIAN</pre>

Si ton paquet contient des binaires supplémentaires voir ci-dessus.<P>
<hr>
<h3><A name="s-partages-2-5">
12.2.5 Comment écrire <code>debian/shlibs.local</code>?
</A></h3>
Ce fichier sert seulement à fixer <em>temporairement</em> si tes binaires ne
dépendent pas d'une librairie qui ne fournit pas déjà son propre fichier
<code>/var/lib/dpkg/*.shlibs</code>.<P>

Supposons que tu crées un paquet binaire <code>foo</code>. Ta sortie doit
ressembler à cela pendant la construction du paquet.
<pre>$ ldd foo
libbar.so.1 =&gt; /usr/X11R6/lib/libbar.so.1.0
libc.so.5 =&gt; /lib/libc.so.5.2.18
libX11.so.6 =&gt; /usr/X11R6/lib/libX11.so.6.0</pre>

Et quand tu exécutes <code>dpkg-shlibdeps</code>
<pre>$ dpkg-shlibdeps -o foo
dpkg-shlibdeps: warning unable to find dependency information
for shared library libbar
(soname 1, path /usr/X11R6/lib/libbar.so.1.0, dependency field Depends)
shlibs:Depends=elf-x11r6lib, libc5 (&gt;= 5.2.18)</pre>

Le binaire <code>foo</code> dépend de la librairie partagée <code>libbar</code> ,
mais aucun paquet ne semblent fournir un fichier <code>*.shlibs</code> dans
<code>/var/lib/dpkg/info/</code>. Déterminons le paquet responsable:
<pre>$ dpkg -S /usr/X11R6/lib/libbar.so.1.0
bar1: /usr/X11R6/lib/libbar.so.1.0
$ dpkg -s bar1 | grep Version
Version: 1.0-1</pre>

Ce qui nous indique que le paquet <code>bar1</code>, version 1.0-1 est celui
qu'on utilise. Maintenant nous pouvons créer notre propre
<code>debian/shlibs.local</code> pour fixer temporairement, les problèmes ci-
dessus. Inclus la ligne suivante dans ton fichier
<code>debian/shlibs.local</code>.
<pre>libbar1 bar1 (&gt;= 1.0-1)</pre>

Maintenant ton paquet construit doit fonctionner. Dès que le mainteneur
de <code>libbar1</code> fournir un fichier <code>shlibs</code>, tu peux enlever ton
fichier <code>debian/shlibs.local</code>.


<hr>
Le manuel de programmation de dpkg
- <A href="index.html#copyright">Copyright ©1996 Ian Jackson
Copyright ©1997 David Curé et Christian Jacolot pour
           la version française.</A>
<br>
<A href="index.html#toc">Table des matières</A>; <A href="index.html#abstract">résumé</A>; <A href="ch-confinit.html">suivant</A>; <A href="ch-deviation.html">précédent</A>.
<br>
<address>20 décembre 1997<br>
D. Cure <A href="mailto:cure@cnam.fr">cure@cnam.fr</A><br>
C. Jacolot <A href="mailto:jacolot@ubolib.univ-brest.fr">jacolot@ubolib.univ-brest.fr</A></address>
</body></html>