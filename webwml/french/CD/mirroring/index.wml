#use wml::debian::cdimage title="Créer un miroir pour les images de cédérom de Debian" BARETITLE=true
#use wml::debian::translation-check translation="1.8" maintainer="Willy Picard"
#use wml::debian::toc

<p>Pour créer un miroir d'images de cédérom de Debian, vous avez besoin
d'une machine sous Linux ou sous un système de type Unix avec une connexion
permanente et fiable à l'Internet. Récupérer les images et les rendre
accessibles peut être fait de différentes manières, selon vos possibilités.</p>

<p>Les miroirs d'images de cédérom de Debian fournissent généralement
les fichiers pour jigdo. Certains fournissent également des images
préfabriquées complètes. Les fichiers jigdo sont habituellement mis
à jour à l'aide de rsync à partir d'<a href="../jigdo-cd/#which">un
des sites officiels</a> et les images complètes sont mises à jour
à l'aide de <kbd>jigdo-mirror</kbd>.</p>

<toc-display/>

<hr>

<toc-add-entry name="httpftp">Pourquoi FTP et HTTP <strong>ne</strong>
sont-ils <strong>pas</strong> adaptés&nbsp;?</toc-add-entry>
 
<p>Vous <em>ne</em> devez <em>pas</em> utiliser FTP ou HTTP pour récupérer
les images. Ces techniques de transfert présentent une probabilité d'échec
importante du fait de la taille énorme des fichiers.</p>

<p>De plus, si les images sont modifiées, même de manière infime
(comme c'est le cas pour les versions intermédiaires), tout le fichier
doit être téléchargé à nouveau. Il en résulte de fortes charges pour
nos ordinateurs et un gaspillage de la bande passante.</p>

<toc-add-entry name="download">Téléchargement par rsync</toc-add-entry>

<p>Pour les raisons présentées ci-dessus, nous utilisons le programme
<a href="http://rsync.samba.org/"><tt>rsync</tt></a> qui
effectue essentiellement des corrections de fichiers binaires à distance.
Avec <tt>rsync</tt>, les nouvelles versions des images sont mises
à jour de manière très efficace, seules les parties modifiées étant
envoyées par le réseau&nbsp;; les parties inchangées sont copiées à partir de
l'ancienne image.</p>

<p>Pour les sites qui souhaitent ne fournir que des images de cédérom
de Debian (et pour ces sites-là seulement) et qui n'ont pas
de miroir rapide de Debian (<kbd>debian/</kbd>) à proximité, nous
suggérons l'utilisation de <kbd>rsync</kbd> dans une tâche cron
quotidienne.</p>

<p>Tous les sites de la <a href="rsync-mirrors">liste des miroirs</a>
peuvent être utilisés comme source pour vos miroirs.

<p>Veuillez utiliser au moins les options <strong><kbd>--times
--links --hard-links --block-size=8192</kbd></strong>. Cela conservera
la date de dernière modification, les liens symboliques et un bloc
de 8192 octets (le plus adapté pour les images de cédérom) sera utilisé.
Lorsque la date de dernière modification et la taille d'un fichier
n'ont pas été modifiées, <kbd>rsync</kbd> ignore le fichier, aussi
<tt>--times</tt> est réellement nécessaire.</p>

<toc-add-entry name="jigdomirror">Fabriquer des images avec
jigdo-mirror</toc-add-entry>

<p>De nombreuses personnes tiennent à jour des miroirs
«&nbsp;classiques&nbsp;» de Debian (<kbd>debian/</kbd>) ou ont un tel
miroir à proximité. Cela signifie qu'ils ont déjà les fichiers .deb qui
sont dans les images de cédérom. La question évidente est&nbsp;: pourquoi
ne pas utiliser ces fichiers dans les images de cédérom&nbsp;?</p>

<p><kbd>jigdo-mirror</kbd> est un programme qui permet de fabriquer des
images de cédérom de Debian à l'aide des fichiers d'un miroir
«&nbsp;classique&nbsp;», ainsi que de quelques fichiers supplémentaires
à l'usage de jigdo.</p>

<p>Veuillez noter que <kbd>jigdo-mirror</kbd> est compris dans jigdo 0.6.8,
mais cette version n'est pas fournie avec Debian 3.0 («&nbsp;woody&nbsp;»).
Cela signifie que vous devez vous le procurer séparément. Il n'existe pas
actuellement de problèmes liés à l'utilisation de cette nouvelle version
sur «&nbsp;woody&nbsp;».</p>

<p>Tout d'abord, vous avez besoin des fichiers pour jigdo. Ils peuvent
être téléchargés à partir de la plupart des sites officiels mais les
deux sites principaux sont&nbsp;:</p>

<ul compact>
  <li><kbd>rsync us.cdimage.debian.org::jigdo-area/</kbd> (miroir aux USA)
  <li><kbd>rsync non-us.cdimage.debian.org::debian-jigdo/</kbd> (miroir européen)
</ul>

<p>Téléchargez les fichiers depuis le répertoire
&lt;<var>version</var>&gt;/jigdo/&lt;<var>architecture</var>&gt;
pour chaque architecture pour laquelle vous souhaitez fabriquer
les images.</p>

<p>Créez un fichier <kbd>~/.jigdo-mirror</kbd> pour configurer le programme.
Voici un exemple&nbsp;:</p>

<pre>
jigdoDir="/where/you/keep/mirrors/debian-cd/current/jigdo"
imageDir="/where/you/keep/mirrors/debian-cd/current/images"
tmpDir="/where/you/keep/mirrors/debian-cd/current/images"
debianMirror="file:/where/you/keep/mirrors/debian"
nonusMirror="file:/where/you/keep/mirrors/debian-non-US"
include='i386/|sparc/|powerpc/|source/'; exclude='-1\.'
</pre>

<p>Les variables <i>include</i> et <i>exclude</i> font référence à la liste
des architectures (sous forme d'expressions rationnelles) pour lesquelles
vous souhaitez créer des images. Pour plus d'informations, veuillez
consulter le manuel de <kbd>jigdo-mirror</kbd> ou le code source (c'est
un script shell comportant de nombreux commentaires).</p>

<p>Une fois l'étape de configuration terminée, lancez simplement
<kbd>jigdo-mirror</kbd> et il fera tout tout seul. Il affiche beaucoup
de messages et l'exécution prend un certain temps, aussi nous vous
suggérons de prendre des mesures pour le gérer (lancez le programme à l'écran,
redirigez la sortie vers un fichier, etc.).</p>

<toc-add-entry name="pik">Fabriquer des images avec le kit pour les
pseudo-images et debcdmirror</toc-add-entry>

<p><tt>rsync</tt> effectue encore un téléchargement complet des toutes 
dernières versions, étant donné que ces images ne comprennent 
théoriquement pas de parties inchangées. Cependant, avec le kit pour les 
pseudo-images, il est possible de créer des «&nbsp;pseudo&nbsp;» images 
de cédérom à partir des données déjà disponibles sur le miroir FTP de Debian 
le plus proche  - éventuellement sur votre disque dur. <tt>rsync</tt> peut alors
appliquer des rustines à ces «&nbsp;pseudo-images&nbsp;» pour les
transformer en images officielles. Et même pour les versions intermédiaires, il
semble que cette technique soit plus efficace que l'application de rustines
sur l'ancienne image.</p>

<p> <strong>Les informations de cette page sont désuètes&nbsp;! Veuillez
utiliser rsync de manière ordinaire ou essayez jigdo-mirror.</strong></p>

<p>Le kit pour les pseudo-images est conçu principalement pour ne télécharger
seulement que quelques images, ainsi que le font la plupart des gens. 
Il existe également le script <tt>debcdmirror</tt> qui rend la création
et la maintenance d'un miroir aisées, étant donné qu'il utilise de manière
automatique le kit pour les pseudo-images et <tt>rsync</tt> pour mettre
à jour votre miroir - jusqu'à vérifier automatiquement les sommes
de contrôle MD5 de chaque image téléchargée. Avec <tt>debdcmirror</tt>, vous
pouvez définir exactement ce que votre miroir doit contenir.</p>

<p>L'utilisation manuelle du kit pour les pseudo-images (avec
éventuellement <tt>rsync</tt> pour mettre à jour les nouvelles versions)
implique beaucoup de travail et de problèmes. Aussi, nous ne le
recommandons pas.</p>

<p>Au lieu de cela, vous devriez utiliser le script <tt>debcdmirror</tt> (qui
utilise «&nbsp;en interne&nbsp;» le kit pour les pseudo-images et
<tt>rsync</tt>) (tâche cron quotidienne).</p>

<p>Les dernières versions du
<a href="http://cdimage.debian.org/~costar/pseudo-image-kit/">kit pour
les pseudo-images</a> et du script
<a href="http://cdimage.debian.org/~costar/debcdmirror/"><tt>debcdmirror</tt></a>
sont disponibles sur la page principale de l'auteur. Veuillez lire
le fichier README de chaque paquet pour de plus amples informations
sur leur utilisation.</p>

<p><strong>Notes&nbsp;:</strong>

<p>Pour le script <tt>debcdmirror</tt>, vous devez choisir un miroir
<tt>rsync</tt> qui possède un fichier «&nbsp;<tt>ls-lR</tt>&nbsp;».
Les adresses sont sur la <a href="rsync-mirrors">liste des miroirs
rsync</a>.</p>

<p>Si vous n'avez pas de <a href="$(HOME)/mirror/">miroir FTP de Debian 
«&nbsp;classique&nbsp;»</a> près de chez vous, cherchez en un dans la<a
href="$(HOME)/mirror/list" >liste des miroirs</a>.</p>

<p><tt>debcdmirror</tt> nécessite <tt>bash</tt> en version 2 ou supérieure. 
Cela n'est pas un problème sur un système Debian moderne. Si
nécessaire, vous pouvez l'installer dans un répertoire autre que celui par
défaut, mais veuillez alors vous assurer que le chemin d'accès à
<tt>bash</tt> est correct dans la première ligne du script.</p>

<toc-add-entry name="test">Images de test</toc-add-entry>

<p>Les répertoires «&nbsp;<tt><i>codename</i>_test</tt>&nbsp;» contiennent
des images qui sont liées (NDT&nbsp;: «&nbsp;hard-linked&nbsp;») à celles
des répertoires versionnés (par exemple <tt>2.2_r4</tt>).
Le nom du répertoire versionné changera avec les nouvelles (sous-)versions,
mais les noms dans les répertoires «&nbsp;<tt>test</tt>&nbsp;» resteront
les mêmes.</p>

<p>Aussi, dans le cas où l'on utilise seulement <tt>rsync</tt>,
le seul moyen de mettre à jour correctement les sous-versions
est de télécharger les répertoires versionnés et «&nbsp;<tt>test</tt>&nbsp;»
correspondant <em>et</em> d'utiliser l'option <tt>--hard-links</tt>.
[Veuillez <em>ne pas</em> utiliser les répertoires «&nbsp;<tt>test</tt>&nbsp;»
avec <tt>debcdmirror</tt> car <tt>debcdmirror</tt> fonctionne différemment
et de manière plus efficace.]</p>

<toc-add-entry name="ls-lR">Fichiers ls-lR</toc-add-entry>

<p>Le fichier <tt>ls-lR</tt> décrit la structure des répertoires du miroir
dans lequel il se trouve.
Veuillez <strong>ne pas</strong> copier le fichier <tt>ls-lR</tt>&nbsp;; 
fabriquez plutôt le vôtre (avec le «&nbsp;<tt>Makels-lR</tt>&nbsp;» fourni,
toutes les heures avec <tt>cron</tt>) ou bien ne fournissez pas de fichier
<tt>ls-lR</tt>.
[<tt>debcdmirror</tt> crée un fichier <tt>ls-lR</tt> automatiquement après le
téléchargement.]</p>

<toc-add-entry name="serve">Rendre les fichiers accessibles</toc-add-entry>

<p>Une fois que vous avez obtenu les images de cédéroms que vous voulez
rendre accessibles (les cédéroms i386 et source sont les plus populaires),
vous devriez exécuter le programme <tt>rsync</tt> en tant que serveur.
Cela ne devrait pas dégrader les performances de votre machine et
générera beaucoup moins de trafic sur le réseau qu'un accès par FTP
ou HTTP.</p>

<p>Les instructions pour mettre cela en place se trouvent dans
le fichier README du kit pour les pseudo-images. En bref, veuillez
ajouter <kbd>rsync --daemon</kbd> à votre configuration de <i>inetd</i>
et modifier <kbd>rsyncd.conf</kbd> pour qu'il corresponde à vos souhaits.
Nous recommandons de limiter l'accès à un nombre restreint de connexions
par adresse IP et à un nombre de connexions total à deux chiffres au
maximum.</p>

# TODO: include more stuff here rather than depending on pik, with examples

<toc-add-entry name="register">Enregistrer le miroir sur nos listes</toc-add-entry>

<p>Afin de rendre votre miroir d'images de cédérom utilisable par un plus
grand nombre d'utilisateurs, vous pouvez l'enregistrer sur notre liste
de miroirs tels que <a href="../http-ftp/">celle-là</a> ou
<a href="rsync-mirrors">celle-là</a>. Cependant, étant donné que
les images complètes sont des fichiers de grande taille, cela peut
entraîner un trafic quotidien de plusieurs gigaoctets.</p>

<p>Vous pouvez enregistrer votre miroir soit en remplissant le
<a href="$(HOME)/mirror/submit">formulaire pour les miroirs</a>
(veuillez noter que les champs CDImage-* sont les plus importants),
soit en envoyant un courriel à
<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;debian-cd&#64;lists.debian.org">\
debian-cd&#64;lists.debian.org</a>.</p>
 
<p>Nous apprécions tous les nouveaux miroirs d'images de cédéroms.
Par avance, merci&nbsp;!</p>
