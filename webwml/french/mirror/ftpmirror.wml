#use wml::debian::template title="Mettre en place un miroir de l'archive Debian"
#use wml::debian::toc
#include "$(ENGLISHDIR)/releases/woody/release.data"

#use wml::debian::translation-check translation="1.35" maintainer="Christian Couder"


<toc-display/>

<p>Une fois qu'un miroir est mis en place, il doit être 
<a href="submit">enregistré par Debian</a>
de façon à être inclus dans la 
<a href="list">liste des miroirs</a>.
Les inscriptions peuvent être faites en utilisant notre 
<A href="submit">simple formulaire web</a>.

<p>Problèmes et questions peuvent être envoyés à 
<email mirrors@debian.org>.</p>

<toc-add-entry name="wherefrom">De quoi faire un miroir&nbsp;?</toc-add-entry>

<p>Beaucoup de gens pensent que <code>ftp.debian.org</code> est
l'emplacement canonique des paquets Debian et que faire un miroir de
ce site est ce qu'il y a de mieux. <strong>Ce n'est pas vrai</strong>.
<code>ftp.debian.org</code> est au mieux l'un des serveurs mis
à jour à partir d'un serveur Debian interne.</p>

<p>Tout serveur parmi ceux qui se trouvent dans la <a
href="list-full">liste complète des miroirs</a> portant la marque
«&nbsp;<kbd>Type: Push-Primary</kbd>&nbsp;» est un bon candidat pour
la source d'un miroir.</p>

<p>Il n'y a pas de différences significatives entre différents miroirs
serveurs <em>Push-Primary</em> comme origine du miroir. De plus, si
beaucoup de gens utilisent <code>ftp.debian.org</code> (et
malheureusement c'est le cas), cela gaspille inutilement la bande
passante que l'on nous donne.</p>

<toc-add-entry name="how">Comment faire un miroir</toc-add-entry>

<p>La méthode recommandée pour faire tourner un miroir est d'utiliser
<a
href="http://packages.debian.org/stable/net/rsync.html">rsync</a>.</p>

<p>Note&nbsp;: bien que <kbd>wget</kbd> fonctionne correctement pour faire
des miroirs de petits sites, il n'est pas aussi configurable que
rsync, donc il n'est pas recommandé pour ce travail.</p>

<h3>rsync anonyme</h3>

<p>Vous pouvez utiliser <a href="anonftpsync">ce script</a> pour faire un 
miroir de l'archive. Suivez les indications du script pour mettre en place 
le miroir.

<p>Voici des conseils pour ceux qui préfèrent d'autres façons de faire
un miroir.

<ul>

  <li>Lancez rsync avec au mois les options suivantes&nbsp;:
  <kbd>--recursive --times --links --hard-links --delete</kbd>.

  <li>Même si vous avez de la place disque supplémentaire, utilisez
  l'option <kbd>--delete-after</kbd> pour éviter des problèmes de mise
  à jour temporaire.

  <li>Si vous n'avez pas assez d'espace disque pour faire un miroir de
  toute l'archive, utilisez l'option <kbd>--exclude</kbd> pour exclure
  certaines parties de l'archive. En général on enlève certaines
  architectures qu'on ne veut pas&nbsp;; par exemple, ce qui suit
  supprimerait <em>toutes</em> les architectures&nbsp;:
      <br>
<: 
print "<code>--exclude binary-$_/ --exclude *_$_.deb</code><br>\n"
  foreach (sort keys %arches);
:>
      Voyez aussi la <a href="#partial">section concernant les miroirs
      partiels</a>.

  <li>Une fois que rsync a fini de mettre à jour le miroir, ajoutez
  un fichier «&nbsp;timestamp&nbsp;» au sous-répertoire
  <code>project/trace/</code> du miroir Debian ayant le nom de votre
  serveur. Cela signifie lancer <kbd>date -u &gt;
  .../debian/project/trace/<var>your.server</var></kbd>
  une fois que votre rsync journalier est terminé&nbsp;; et <kbd>date -u
  &gt; .../debian-non-US/project/trace/<var>your.server</var></kbd>
  une fois que le rsync journalier de non-US est terminé, si vous
  faites un miroir de debian-non-US.

</ul>

<h3>rsync avec authentification, à partir d'un miroir «&nbsp;Push&nbsp;»</h3>

<p>Les miroirs «&nbsp;Push&nbsp;» sont une forme de miroir, utilisant rsync, que nous 
avons développée afin de minimiser le temps que mettent les changements de 
l'archive pour atteindre les miroirs. Les miroirs «&nbsp;Push&nbsp;» utilisent un 
script déclencheur ssh pour indiquer au miroir client qu'il doit se mettre 
à jour. 

<p>Les miroirs «&nbsp;Push&nbsp;» sont nécessaires pour garder synchrones un
ensemble de serveurs (comme les serveurs dans des alias DNS en
<i>round-robin</i>, par exemple <tt>ftp.us.debian.org</tt>), et nous
les utilisons couramment pour nos miroirs de premier et deuxième
niveau. Pour les miroirs «&nbsp;normaux&nbsp;», cette méthode demande beaucoup
d'effort de mise en place ce qui n'est en fait pas très rentable
comparé à une tâche cron bien préparée.</p>

<p>La méthode est assez sûre car ssh est configuré pour lancer une unique 
commande. Ainsi le miroir se fait toujours par «&nbsp;Pull&nbsp;», il n'est donc 
<strong>pas</strong> possible de corrompre le contenu de l'archive 
<i>via</i> un miroir push infiltré.
Quelques administrateurs de miroirs ont montré une certaine hésitation à 
utiliser cette méthode de miroirs par crainte qu'elle n'ouvre leur machine à 
une invasion. Ce n'est absolument <strong>pas</strong> le cas.

<p>Pour une description plus détaillée de la manière dont cette méthode 
fonctionne, des raisons pour lesquelles elle est sûre et de la façon de
la mettre en place, voyez <a href="push_mirroring">les explications
complètes</a>.

<h3>FTP anonyme</h3>

<p>L'utilisation de FTP anonyme a été la méthode standard de création de
miroir pendant longtemps, mais elle a été remplacée par l'utilisation de
rsync.</p>

<p>Si pour une raison valable vous ne pouvez pas utiliser rsync, le 
programme «<a href="http://packages.debian.org/mirror">mirror</a>» peut
être utile. Gardez à l'esprit le fait qu'il dépend de fichiers résultant
de la commande «ls -lR» ce qui l'empêche de maintenir des traces miroir
appropriées dans le sous-répertoire <kbd>project/trace/</kbd> des miroirs
Debian.</p>
 
<toc-add-entry name="partial">Miroir partiel</toc-add-entry>

<p>Considérant la <a href="size">taille déjà importante de l'archive
Debian</a>, certaines personnes préfèrent ne faire un miroir que des
quelques parties dont ils ont besoin. Si vous voulez en
exclure une partie, vous devriez exclure les architectures.</p>

<p>Avec <a href="anonftpsync">anonftpsync</a>, cela peut se faire en
modifiant la variable EXCLUDE. Vous pouvez aussi utiliser les scripts
écrits spécialement pour cela, comme
<a href="http://packages.debian.org/unstable/net/debmirror.html">debmirror</a>
(par Joey Hess et Joerg Wendland). Si vous pensez que quelque chose devrait être
ajouté à ceux-ci, merci de contacter les auteurs (les informations
permettant de les contacter devraient être incluses dans les scripts
eux-mêmes).

<p>Nous conseillons fortement de ne pas exclure <tt>project/</tt>,
<tt>doc/</tt> et les autres sous-répertoires. En général ceux-ci sont
insignifiants en terme de taille mais utiles aux utilisateurs.</p>

<toc-add-entry name="when">Quand rafraîchir les miroirs&nbsp;?</toc-add-entry>

<p>L'archive principale est mise à jour toutes les 24 heures.

<p>En général les miroirs commencent à se mettre à jour à partir de
00:00 UTC, mais ce n'est pas une heure fixe. Nous recommandons de
mettre à jour votre miroir chaque jour, plusieurs heures après cette
heure&nbsp;; en fait, vous devriez regarder si le site à partir duquel vous
faites votre miroir laisse un fichier «&nbsp;time stamp&nbsp;» dans son
sous-répertoire <kbd>project/trace/</kbd>. Ce fichier aura le même nom
que le site, et il contiendra l'heure de la fin de la dernière mise à
jour du site. Ajoutez-y quelques heures (pour plus de sécurité) et
vous obtiendrez le moment auquel lancer votre processus miroir.</p>

<p>La meilleure façon de faire tourner le miroir automatiquement tous les 
jours est d'utiliser cron. Voyez <kbd>man crontab</kbd> pour plus de détails.

<p>Notez que si votre site utilise un mécanisme «&nbsp;Push&nbsp;» pour lancer
sa mise à jour, alors vous n'avez à vous soucier d'aucun de ces
problème.</p>

<toc-add-entry name="settings">Configuration supplémentaire recommandée</toc-add-entry>

<p>Si vous voulez rendre le miroir Debian disponible par HTTP, merci
de rajouter les options suivantes à votre configuration d'Apache (en
supposant bien sûr que vous utilisez Apache) dans le paragraphe
<code>&lt;Directory <var>/chemin/vers/votre/miroir/debian</var>&gt;</code>, où
<var>/chemin/vers/votre/miroir/debian/</var> doit être remplacé par le
nom du répertoire dans lequel vous gardez le miroir&nbsp;:</p>

<pre>
   Options +Indexes +FollowSymlinksIfOwnerMatch
   IndexOptions NameWidth=* +SuppressDescription
   DirectoryIndex .
</pre>

<p>Ceci met en place les index de repertoires et assure que les liens
symboliques fonctionnent. Les noms de fichier dans les index de
répertoires ne seront pas tronqués et les descriptions (qui le plus
souvent n'existent pas) n'apparaitront pas.</p>
