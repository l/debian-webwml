#use wml::debian::template title="Mettre en place un miroir FTP"
#use wml::debian::toc

#use wml::debian::translation-check translation="1.25" maintainer="Christian Couder"


<p>Faire tourner un miroir revient au même que le site soit <a
href="official">officiel</a> ou non.

<p>Une fois qu'un miroir est mis en place il doit être 
<a href="submit">enregistré par Debian</a>
de façon à être inclus dans la 
<a href="../misc/README.mirrors">liste des miroirs</a>.
Les soumissions peuvent être faites en utilisant notre 
<A href="submit">simple formulaire web</a>.

<p>Les problèmes ou questions peuvent être envoyés à 
<A href="mailto:mirrors@debian.org">mirrors@debian.org</A>.
</p>

<toc-display/>

<toc-add-entry name="wherefrom">De quoi faire un miroir ?</toc-add-entry>

<p>Beaucoup de gens pensent que <code>ftp.debian.org</code> est
l'emplacement canonique des paquets Debian et que faire un miroir de
ce site est ce qu'il y a de mieux. <strong>Ce n'est pas vrai</strong>.
<code>ftp.debian.org</code> est au mieux l'un des serveur qui est mis
à jour à partir d'un serveur Debian interne.</p>

<p>Tout serveur parmi ceux qui se trouvent dans la <a
href="mirrors_full">liste complète des miroirs</a> portant la marque 
« <kbd>Type: Push-Primary</kbd> » devrait être un bon candidat pour
la source d'un miroir.</p>

<p>Pour vous, il n'y a pratiquement aucune différence entre un miroir
fait à partir de <code>ftp.debian.org</code> et un miroir fait à
partir d'un autre miroir <em>Push-Primary</em>. De plus, si beaucoup
de gens utilisent <code>ftp.debian.org</code> (et malheureusement
c'est le cas), cela gaspille la bande passante qui nous a été
donnée.</p>

<toc-add-entry name="methods">Méthodes pour faire un miroir</toc-add-entry>

<p>La méthode recommandée pour faire tourner un miroir est d'utiliser rsync.

<p>Note : bien que <kbd>wget</kbd> fonctionne correctement pour faire
des miroirs de petits sites, il n'est pas aussi configurable que rsync
ou mirror donc il n'est pas recommandé pour ce travail.

<h3>rsync anonyme</h3>

<p>Vous pouvez utiliser <a href="anonftpsync">ce script</a> pour faire un 
miroir de l'archive. Suivez les indications du script pour mettre en place 
le miroir.

<h3>rsync avec authentification, à partir d'un miroir « Push »</h3>

<p>Les miroirs « Push » sont une forme de miroir, utilisant rsync, que nous 
avons développée afin de minimiser le temps que mettent les changements de 
l'archive pour atteindre les miroirs. Les miroirs « Push » utilisent un 
script déclencheur ssh pour indiquer au miroir client qu'il doit se mettre 
à jour. 

<p>Les miroirs « Push » sont nécessaires pour garder synchrones un
ensemble de serveurs (comme les serveurs dans des alias DNS en
<i>round-robin</i>, par exemple <tt>ftp.us.debian.org</tt>), et nous
les utilisons couramment pour nos miroirs premier et deuxième
tier. Pour les miroirs « normaux », cette méthode demande beaucoup
d'effort de mise en place ce qui n'est en fait pas très rentable
comparé à une tâche cron bien préparée.</p>

<p>La méthode est assez sûre car ssh est configuré pour lancer une unique 
commande. Ainsi le miroir se fait toujours par « Pull », il n'est donc 
<strong>pas</strong> possible de corrompre le contenu de l'archive 
<i>via</i> un miroir push infiltré.
Quelques administrateurs de miroirs ont montré une certaine hésitation à 
utiliser cette méthode de miroirs par crainte qu'elle n'ouvre leur machine à 
une invasion. Ce n'est absolument <strong>pas</strong> le cas.

<p>Pour une description plus détaillée de la manière dont cette méthode 
fonctionne, des raisons pour lesquelles elle est sûre et de la façon de
la mettre en place, voyez <a href="push_mirroring">les explications
complètes</a>.

<h3>FTP anonyme en utilisant « mirror »</h3>

<p>FTP anonyme a été la méthode standard de création de miroir depuis
longtemps. Pour cela, le programme « mirror » fonctionne correctement sur 
l'archive Debian.
Comme vous vous en doutez probablement, « mirror » est disponible en
paquet Debian.
Si vous avez installé le paquet Debian, il y a un script d'exemple pour
faire un miroir de l'archive ftp dans /etc/mirror/packages/ftp.debian.org.

<toc-add-entry name="partial">Miroir partiel</toc-add-entry>

<p>Considérant la <a href="size">taille déjà importante de l'archive
Debian</a>, certaines personnes préfèrent ne faire un miroir que des
quelques parties de celle-ci dont ils ont besoin. Si vous voulez en
exclure une partie, vous devriez exclure les architectures.</p>

<p>Avec <a href="anonftpsync">anonftpsync</a>, cela peut se faire en
modifiant la variable EXCLUDE. Vous pouvez aussi utiliser les scripts
écrits spécialement pour cela, comme <a
href="http://packages.debian.org/unstable/net/debmirror.html">debmirror</a>
(par Joey Hess et Joerg Wendland) ou <a
href="http://people.debian.org/~absurd/absurd_debmirror/">absurd_debmirror</a>
(par Stephan Suerken). Si vous sentez que quelque chose devrait être
ajouté à ceux-ci, merci de contacter les auteurs (les informations
permettant de les contacter devraient être incluses dans les scripts
eux-mêmes).

<p>Nous conseillons fortement de ne pas exclure <tt>project/</tt>,
<tt>doc/</tt> et les autres sous-répertoires. En général ceux-ci sont
insignifiants en terme de taille mais utiles aux utilisateurs.</p>

<toc-add-entry name="when">Quand rafraîchir les miroirs ?</toc-add-entry>

<p>L'archive principale est mise à jour toutes les 24 heures.

<p>Si votre site est un miroir « Push », alors vous n'avez pas à vous
soucier de ce problème. Sinon, et si le site dont vous faites un miroir
utilise rsync, alors vous devriez aller voir dans <kbd>project/trace/</kbd>
dans l'archive Debian du site pour y trouver un fichier ayant le nom du site.
Ce fichier devrait contenir la date à laquelle le processus de miroir s'est
terminé la dernière fois.
Ajoutez-y un moment, par exemple une heure, et vous obtiendrez le moment 
auquel lancer votre processus.

<p>La meilleure façon de faire tourner le miroir automatiquement tous les 
jours est d'utiliser cron. Voyez <kbd>man crontab</kbd> pour plus de détails.
 
<toc-add-entry name="settings">Configuration supplémentaire recommandée</toc-add-entry>

<p>Si vous voulez rendre le miroir Debian disponible par HTTP, merci de
rajouter les options suivantes à votre configuration d'Apache (en
supposant bien sûr que vous utilisez Apache) concernant l'indexation
des répertoires :

<pre>
&lt;directory /org/ftp.debian.org/ftp&gt;
   IndexOptions NameWidth=* +SuppressDescription
   DirectoryIndex .
&lt;/directory&gt;
</pre>

<p>(remplacez <code>/org/ftp.debian.org/ftp</code> par le nom du répertoire
dans lequel vous gardez le miroir.)

