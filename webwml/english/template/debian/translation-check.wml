#use wml::std::tags
#use wml::debian::languages

# This file is used to track when translations go out-of-date, and it is
# used by including this in the head of the translated file:
#
# #use wml::debian::translation-check translation="X.xx"
#
# where X.xx is the current CVS revision number of the file you have
# translated.
#
# There are also some additional parameters that you can use on the #use
# line:
#
#    original="language"
# where  language  is the name of the language you are translating from, if
# not english. The name must correspond to the top-level subdirectory, and
# to the name in languages.wml
#
#    mindelta="number"
# which defines the maximum difference in CVS revisions before the
# translation is considered aged. The default value is 2. For important
# pages, set it to 1, which means that every change is considered making the
# translation aged. The value for the <aged> tag is displayed.
#
#    maxdelta="number"
# which defines the maximum difference in CVS revisions before the
# translation is considered to be outdated (and the value of the <outdated>
# tag is displayed). The default value is 5. For very important pages, set
# it to be less. A value of 1 means that every change is considered making
# the translation outdated.

# This is the message that is displayed if the translation is aged.
# (min_delta <= difference < max_delta)
<define-tag translationaged whitespace=delete>
  [EN:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [SV:<P><EM>Observera:</EM> Originalet är nyare än denna översättning.</P>:]
  [NO:<P><EM>NB:</EM> Originalen er nyere enn denne oversettelsen.</P>:]
  [DE:<P><EM>NB:</EM> Das Original ist neuer als diese Übersetzung.</P>:]
  [AR:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [DA:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [EO:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [ES:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [FI:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [FR:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [HR:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [HU:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [IT:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [JA:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [KO:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [NL:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [PL:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [PT:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [RO:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [RU:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [TR:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
  [ZH:<P><EM>Note:</EM> The original is newer than this translation.</P>:]
</define-tag>

# This is the message that is displayed if the translation is too old.
# (difference >= max_delta)
<define-tag translationoutofdate whitespace=delete>
  [EN:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [SV:<P><STRONG>Varning! Den här översättningen är för gammal, \
      vänligen se <A HREF="$link">originalet</A>.</STRONG></P>:]
  [NO:<P><STRONG>Varning! Denne oversettelsen er for gammel, \
      vennligst se <A HREF="$link">originalen</A>.</STRONG></P>:]
  [DE:<P><STRONG>Achtung! Diese Übersetzüng ist zu alt, \
      sehen Sie bitte das <A HREF="$link">Original</A>.</STRONG></P>:]
  [AR:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [DA:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [EO:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [ES:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [FI:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [FR:<P><STRONG>Attention : cette traduction n'est plus à jour, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [HR:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [HU:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [IT:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [JA:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [KO:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [NL:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [PL:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [PT:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [RO:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [RU:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [TR:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
  [ZH:<P><STRONG>Warning! This translation is too out of date, \
      please see the <A HREF="$link">original</A>.</STRONG></P>:]
</define-tag>

# DO NOT translate anything below here. --------------------------------------

<perl>

sub check_translation {
# Checks the current document (translated) with its original
# version, receives as input the name of the document and
# the CVS version it was translated from.

my ($translation, $file, $original, $mindelta, $maxdelta) = @_;

# This is the maximum difference between a translated
# document and the original before considering it outdated
$max_versions = $maxdelta || 5;

# This is the maximum difference between a translated
# document and the original before considering it aged
$min_versions = $mindelta || 2;

# Turn this to '1' to set debugging ouput
# ¡Only do this if you know what you are doing!
# If you checkin to CVS this should be set to 0
$debug = 0;

# This is the language code of the original (to make a link)
$original_lang = $original ? $langs{$original} : "en";
$link = $file;
$link =~ s/\.wml$//;
$link .= ".$original_lang.html";

# This is the directory where the original source is kept
$original_dir = "../$original" || "../english";

# Open the original Makefile
open (MAKE,"<Makefile")
	or return;

# We could also do this same grepping ?faster?
# Or we could use also $WML_SRC_DIRNAME and then cut out to the root
while ($line = <MAKE>) 
{
        chomp $line;
        if ( $line =~ /^WMLBASE\s*=\s*(.*)/ )
        {
                $wmlbase = $1; 
        }
        if ( $line =~ /^CUR_DIR\s*=\s*(.*)/ )
        {
                $current_dir = $1; 
        }
        last if $wmlbase and $current_dir;
}
close MAKE;

# Now read the original CVS file in by opening $wmlbase/$original_dir/$current_dir/CVS/Entries
# It has to go "back" to the root dir and the "forward" to the same dir we are in
# but in the language dir.
 
open (CVS_ENTRY,"<$wmlbase/$original_dir/$current_dir/CVS/Entries")
	or return;

while ( $line =<CVS_ENTRY> )
{
        chomp $line;
        print "Reading $line \n" if $debug;
        if ( $line =~ /\/\Q$file\E\/([\d\.]*)/ ) {
                $version = $1;
        }
        last if $version;
}
# TODO: Should check if version not found (maybe yell?)

# Here we compare the original version with the translated one
# and if their last numbers are too further apart report
# to the user

# TODO: Also check major number
if ( $version =~ /\.(\d*)$/ )
{
	$last_number = $1;
}
else
{
	print STDERR "CVS Entry $file version number not as expected: $version not in expected format\n";
	return 1;
}

if ( $translation =~ /\.(\d*)$/ )
{
	$last_translated_number = $1
}
else
{
	print STDERR "Call to the subroutine has not been made as expected: '$translation' not in expected format\n";
	return 1;
}

print "Comparing original $version to translation version $translation\n" if $debug;
# TODO: check also major numbers
print "Comparing minor $last_number to minor $last_translated_number\n" if $debug;

if ( $last_number - $last_translated_number >= $max_versions ) 
{
	print qq(<translationoutofdate>)
}
elsif ( $last_number - $last_translated_number >= $min_versions ) 
{
	print qq(<translationaged>)
}

close CVS_ENTRY;
}
</perl>

#The call to the subroutine is done here
<: check_translation ("$(translation)","$WML_SRC_FILENAME","$(original)","$(mindelta)","$(maxdelta)") :>
