#use wml::debian::ctime

<perl>

# grabs the date and title of the last $number news items from directory $year.
# If $number is zero then all the news items are shown.

<protect pass=2>
sub get_recent_news {
  my ($year, $number, $eng_dir) = @_;

  opendir(DIR, "$eng_dir/$year");
  @files = grep { /^\d+\w?.wml$/ && -f "$eng_dir/$year/$_" } readdir(DIR);
  @files = sort {$b cmp $a} @files;
  closedir DIR;

  $count = 0;
  foreach (@files) {
     $count++;
     open(FILE, "< $year/$_") || open(FILE, "< $eng_dir/$year/$_");
     if (/(\d+\w?).wml/) {
        $base = $1;
     }
     $date = ''; $title = '';
     foreach $line (<FILE>) {
        if ($line =~ /^<define-tag pagetitle>(.*)<\/define-tag>$/) {
           $title = $1;
        }
        elsif ($line =~ /^<define-tag release_date>(.*)<\/define-tag>$/) {
           $date = $1;
        }
        elsif ($line =~ /^<define-tag report_date>(.*)<\/define-tag>$/) {
           $date = $1;
        }
        elsif ($line =~ /^<define-tag description>(.*)<\/define-tag>$/) {
           $desc = $1;
        }
        if ($title && $date) {
           $date = newsdate($date);
           $str .= "<tt>[$date]</tt> <strong><a href=\"$year/$base\">$title</a></strong> - $desc<br>\n";
           last;
        }
     }
     close FILE;
     if ($count eq $number) { last; }
  }
close DIR;
return $str;
}
</protect>
</perl>
