<perl>

# Very similar to get_recent_list except it looks for the .wml files
# inside subdirectories of the given directory, and if it finds less than
# 10, falls back to last year's news for the rest.
sub get_weeklynews_list {
	my ($year, $eng_dir, $match, $noyear, $count, $stopat, $reccount) = @_;
	
	my $str="";

	open(CURRENT, "CURRENT-ISSUE-IS") or open(CURRENT, "$eng_dir/CURRENT-ISSUE-IS") or return '';
	my $currentissue=<CURRENT>;
	chomp $currentissue;
	my ($currentyear)=$currentissue=~m:^(\d+)/:;
	$currentissue=~s:^\d+/::;
	close CURRENT;

	opendir(DIR, "$eng_dir/$year") or return '';
	@files = grep { /^$match$/ && -f "$eng_dir/$year/$_/index.wml" } readdir(DIR);
	closedir DIR;
	
	foreach (sort {$b <=> $a} @files) {
		next if $year == $currentyear && $_ > $currentissue; # skip issues in preparation.
		my $num=$_;
		$_="$_/index.wml";
		$trans_title = $_;
		$trans_title =~ s/wml/title/;
		($base)=m:(.*/):;
		open(FILE,"<$year/$_") || open(FILE, "<$year/$trans_title") || open(FILE, "<$eng_dir/$year/$_");
		$title = '';
		$summary = '';
		$line=<FILE>;
		if ($line =~ /PAGENAME="(.*?)"/) {
			$title=$1;
		}
		if ($line =~ /SUMMARY="(.*?)"/) {
			$summary=$1;
		}
		if ($title) {
			if (length $num == 1) {
				$num="&nbsp;$num";
			}
			$str.="$num.\t<a href=\"". ($noyear ? "" : "$year/" )."$base\">$title</a> $summary<br>\n";
		}
		close FILE;
		$count++;
		last if ($stopat ne '' && $count >= $stopat);
	}
	close DIR;

	# Get more if necessary.
	if ($count < 10 && $reccount < 3 ) {
		$str.=get_weeklynews_list($year - 1, $eng_dir, $match, $noyear, $count, 10, $reccount++);
	}
	
	return $str;
}

</perl>
