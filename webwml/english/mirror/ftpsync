#! /bin/sh
set -e

. $HOME/ftpsync.conf

export RSYNC_PASSWORD

HOSTNAME=`hostname -f`

LOCK="${TO}/Archive-Update-in-Progress-${HOSTNAME}"

# Get in the right directory and set the umask to be group writable
# 
cd $HOME
umask 002

# Check to see if another sync is in progress
if lockfile -! -l 43200 -r 0 "$LOCK"; then
  echo ${HOSTNAME} unable to start rsync, lock file exists
  exit 1
fi
trap "rm -f $LOCK > /dev/null 2>&1" exit  

set +e
rsync --recursive --links --hard-links --times --verbose --delete --delete-after \
     --exclude "Archive-Update-in-Progress-${HOSTNAME}" \
     --exclude "project/trace/${HOSTNAME}" \
     $EXCLUDE \
     $RSYNC_USER@$RSYNC_HOST::ftp $TO > rsync.log 2>&1
date -u > "${TO}/project/trace/${HOSTNAME}"
savelog rsync.log > /dev/null 2>&1
