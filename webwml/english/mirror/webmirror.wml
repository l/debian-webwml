#use wml::debian::template title="Setting up a mirror of the Debian web site"

<p>Mirroring is the same for both official and unofficial sites.

<p>Once a mirror is set up the mirror should be <a href="submit">registered
with Debian</a> in order to get included in the
<a href="../misc/README.mirrors">mirror list</a>. If you have any questions,
send mail to <a href="mailto:mirrors@debian.org">mirrors@debian.org</a>.

<H2>Methods of Mirroring</H2>

<h3>Anonymous rsync</h3>

<p>The recommended method of mirroring is with rsync.

<p>You can use <a href="anonwebsync">this script</a> to mirror the archive.
Follow the directions in the script to set up mirroring.
Sites in the <a href="mirrors_full">full list of mirrors</a> that use
'<kbd>Type: Push-*</kbd>' should be good to mirror from.

<p>The main site gets rebuilt every eight hours (see the dates on timestamp
files in <code>/mirror/timestamps/</code> directory of the web site for
exact times), you should calculate the mirroring time for your site.

<h3>Push Mirror</h3>

<p>Push mirroring is a form of mirroring using rsync that we have developed to minimize the
time it takes for changes to the archive to reach mirrors. Push mirroring uses
an ssh trigger to tell the client mirror when to update itself. This method is
quite secure as ssh is configured to run only a single command. Also, mirroring is still
'pull' so it is not possible to corrupt the contents of the archive via a forged push mirror.

<p>Some mirror administrators have shown some reluctance to using this method of
mirroring due to fears that the method may open their machine to invasion.
This is simply not true. For a more detailed description of how this works
and why it is secure see <a href="explain">this page</a>.

<p>Push mirroring takes a little more effort to set up since the maintainers of the
upstream and downstream mirror must exchange information. The benefit is that
the upstream mirror initiates the mirror process immediately after its archive has
been updated. This allows changes to the archive to propagate extremely quickly.

<p>It is best to set this up using the account of an ordinary user, not root.
The contents of the public ssh key given to you by the upstream mirror should be
placed in <kbd>~&lt;user&gt;/.ssh/authorized_keys</kbd>.

<p>The files <a href="websync">websync</a> and <a href="websync.conf">websync.conf</a>
will be needed. Edit websync.conf and follow the directions in there using the information
provided to you by the upstream mirror.

<p>If you are becoming a Push-Primary, you will need the
<a href="identity.pub.master.web">public ssh key for the web</a>.

<h3>Anonymous FTP Using 'mirror'</h3>

<p>It is not suggested that you use 'mirror' on the Debian web pages. For large
directories memory usage becomes ridiculous. One mirror maintainer said it worked
for him with 96MB of RAM. Others, with less RAM, found the machine swapping excessively.

<h3>wget</h3>

<p>While wget works well for mirroring small sites, it is not as
configurable as mirror or rsync so is not recommended for this job.

<H2>Advertising the sponsor of the mirror</H2>

<p>The files <code>sponsor.html</code> and <code>sponsor_img.jpg</code> can
and should be replaced by you. They are for you to advertise your site so
people know who the sponsor is. The originals are under
<code>sponsor.deb.html</code> and <code>sponsor.deb.jpg</code> as the site
you are mirroring may have replaced the ones Debian provided as examples.
The suggested maximum size for your logo is 120x60.

<p>Since <a href="#cn">content negotiation</a> is being used on the web pages
to select the preferred language, you may even provide
<code>sponsor.html</code> in different languages. To do this you simply create
sponsor.&lt;lang&gt;.html for each &lt;lang&gt; you would like.

<p>Make sure you add any files you don't want overwritten to the exclude list
for mirroring.

<H2>Configuring the web server</H2>

<h3>Other Web Server Changes</h3>

<p>If your machine is running Debian, it was decided to break Debian policy
and use <code>/doc</code> in the web pages.  This means you should comment
out the `<code>Alias /doc/ /usr/doc/</code>' line from your
<code>/etc/apache/srm.conf</code> file.

<h3><a name="cn">Content Negotiation</a></h3>

<p>Content Negotiation is a method which lets a browser negotiate with a
server the type of document that should be served. While there are a number
of uses for this, the most common is to negotiate what language a document
should be served in. Using this will allow Debian to serve its pages in
multiple languages in a (technically) very elegant fashion.

<P>For those who are using Apache, the change is almost trivial. Simply
add a section similar to the following to <kbd>/etc/apache/access.conf</kbd>
(substitute the directory containing the web pages for <kbd>/debian/web</kbd>) and
restart the server (this example works with the apache 1.3 beta releases and
later):

<pre>
&lt;Directory /debian/web&gt;
Options +Multiviews   
&lt;/Directory&gt;
</pre>

<p>Additionally, you need to make sure that the server can handle all the
languages that will be on the web site. This is done using the
<kbd>AddLanguage</kbd> tag. The following is a list of those languages
already used - expect to add more later:

<pre>
AddLanguage en .en
AddLanguage fr .fr
AddLanguage de .de
AddLanguage da .da
AddLanguage it .it
AddLanguage es .es
AddLanguage ja .ja
AddLanguage pl .pl
AddLanguage ko .ko
AddLanguage hr .hr
AddLanguage pt .pt
AddLanguage fi .fi
AddLanguage zh-CN .zh-cn
AddLanguage zh-TW .zh-tw
AddLanguage cs .cs
AddLanguage sv .sv
AddLanguage no .no
AddLanguage ru .ru
AddLanguage tr .tr
AddLanguage eo .eo
AddLanguage ar .ar
AddLanguage nl .nl
AddLanguage hu .hu
AddLanguage ro .ro
</pre>

<p>Due to a bug in apache the wrong language can be served in some
circumstances, so it is a good idea to add every language served to
the LanguagePriority option, like this:

<pre>
LanguagePriority en fr de it es ja pl hr da pt fi zh-cn zh-tw cs sv ko no ru tr eo ar nl hu ro
</pre>

<p>In order to avoid serving content-negotiated files with wrong charset,
make sure that the <code>AddDefaultCharSet</code> setting is either
commented out or set to `<code>Off</code>'.

<p>In order to serve directory index files correctly, you will probably need
to modify the <code>DirectoryIndex</code> entry in
<code>/etc/apache/srm.conf</code>. The following should be sufficient:

<pre>
DirectoryIndex index index.html
</pre>

<h3>Redirections</h3>

<p>Because some parts of the web site were beginning to be too large to be
mirrored by most sites, we have separated them from the main site. Although
most links should be converted to use the new locations, you're welcome to
add a redirect to another site so no links are broken. This can be done in
<kbd>/etc/apache/srm.conf</kbd>. For example:

<pre>
Redirect /Lists-Archives http://lists.debian.org/
Redirect /search http://search.debian.org
Redirect /Packages http://packages.debian.org
Redirect /lintian http://lintian.debian.org
</pre>
