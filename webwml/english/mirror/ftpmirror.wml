#use wml::debian::template title="Setting up a Debian archive mirror"
#use wml::debian::toc
#include "$(ENGLISHDIR)/releases/woody/release.data"

<toc-display/>

<p>Once a mirror is set up, it should be <a href="submit">registered with Debian</a>
in order to get included in the <a href="list">mirror list</a>.
Submissions can be done using our <A href="submit">simple web form</a>.

<p>Any problems or enquiries can be sent to <email mirrors@debian.org>.</p>

<toc-add-entry name="wherefrom">Where to mirror from</toc-add-entry>

<p>Many people seem to think that <code>ftp.debian.org</code> is the
canonical location of Debian packages and that it will be best for them
to mirror from that site. This is <strong>not true</strong>.
<code>ftp.debian.org</code> is merely one of several servers that get
updated from an internal Debian server.</p>

<p>Any of the servers in the <a href="list-full">full list of mirrors</a>
that have the '<kbd>Type: Push-Primary</kbd>' tag should be good to mirror
from.</p>

<p>There is no real difference between different <em>Push-Primary</em>
mirror servers as far as mirroring is concerned. On the other
hand, if many people use ftp.debian.org (and unfortunately, they do), this
needlessly wastes the donated bandwidth.</p>

<toc-add-entry name="how">How to mirror</toc-add-entry>

<p>The recommended method of mirroring is with
<a href="http://packages.debian.org/stable/net/rsync.html">rsync</a>.</p>

<p>Note: while <kbd>wget</kbd> works well for mirroring small sites, it is
not as configurable as rsync so is not recommended for this job.</p>

<h3>Anonymous rsync</h3>

<p>You can use <a href="anonftpsync">this script</a> to mirror the archive.
Follow the directions in the script to set up mirroring.

<p>Here are some advices for those who prefer different methods:

<ul>
  <li>Run rsync with at least these options: <kbd>--recursive --times
      --links --hard-links --delete</kbd>.

  <li>If you have extra disk space, also use the <kbd>--delete-after</kbd>
      option to avoid some of the temporary update problems.

  <li>If you don't have enough disk space to mirror everything, use the
      <kbd>--exclude</kbd> option to exclude portions of the archive from
      mirroring. Commonly this includes various architectures you might not
      want; for example, this would exclude <em>all</em> architectures:
      <br>
<: 
print "<code>--exclude binary-$_/ --exclude *_$_.deb</code><br>\n"
  foreach (sort keys %arches);
:>
      Check the <a href="#partial">section on partial mirroring</a> as well.

  <li>After rsync is done mirroring, add a time stamp file to the
      <code>project/trace/</code> subdirectory of the Debian mirror
      named after your server. This means running
      <kbd>date -u &gt; .../debian/project/trace/<var>your.server</var></kbd>
      after your daily rsync is finished; and
      <kbd>date -u &gt; .../debian-non-US/project/trace/<var>your.server</var></kbd>
      after the non-US daily rsync is finished, if you mirror debian-non-US.
</ul>

<h3>Rsync with authentication, from a push mirror</h3>

<p>Push mirroring is a form of mirroring using rsync that we have developed
to minimize the time it takes for changes to the archive to reach mirrors.
The server mirror uses an ssh trigger to tell the client mirror to update
itself.

<p>Push mirroring is necessary to keep multiple servers in synchronization
(such as servers in DNS round-robin aliases like <tt>ftp.us.debian.org</tt>),
and we commonly use it for our first and second tier mirrors. For "normal"
mirrors, this method requires a lot of effort to set up which doesn't
actually pay off compared to a well tuned cron job.</p>

<p>The method is quite secure as ssh is configured to run only a single
command. Also, mirroring is still `pull' so it is <strong>not</strong>
possible to corrupt the contents of the archive via a forged push mirror.
Some mirror administrators have shown some reluctance to using this method of
mirroring due to fears that the method may open their machine to invasion.
This is simply <strong>not</strong> true.

<p>For a more detailed description of how this works, why it is secure, and
how to set a push mirror, please see <a href="push_mirroring">the complete
explanation</a>.

<h3>Anonymous FTP</h3>

<p>Anonymous FTP was the standard method of mirroring for a long time,
but it has been deprecated in favour of rsync.</p>

<p>If for some compelling reason you cannot use rsync, the program
"<a href="http://packages.debian.org/mirror">mirror</a>" might be
useful. Bear in mind that it relies on ls-lR files which prevents
it from maintaining a proper mirror trace in the <kbd>project/trace/</kbd>
subdirectory of Debian mirrors.</p>

<toc-add-entry name="partial">Partial mirroring</toc-add-entry>

<p>Considering the already <a href="size">large size of Debian archive</a>,
some people prefer to mirror only parts of it they need. If you want to
exclude something, you should exclude architectures.</p>

<p>With <a href="anonftpsync">anonftpsync</a>, this can be done by
editing the EXCLUDE variable. You can also use specially written
scripts, like <a href="http://packages.debian.org/unstable/net/debmirror.html">\
debmirror</a> (by Joey Hess and Joerg Wendland).  If you feel that
something should be added to these, please contact the authors (contact
information should be enclosed in the scripts themselves). </p>

<p>We strongly advise against excluding the <tt>project/</tt>, <tt>doc/</tt>
and other subdirectories. Usually these are minor in size and yet useful to
users.</p>

<toc-add-entry name="when">When to mirror</toc-add-entry>

<p>The main archive gets updated every 24 hours.

<p>The mirrors commonly start updating around 00:00 UTC, but this is is not
a fixed time. We recommend mirroring every day, several hours after that; in
fact, you should check if the site you're mirroring from leaves a time stamp
file in their <kbd>project/trace/</kbd> subdirectory. The time stamp file
will be named like that site, and it will contain the completion time of
their last mirror update. Add a couple of hours to that time (to be safe)
and mirror then.</p>

<p>The easiest way to automatically have the mirror run every day is to use
cron. See <kbd>man crontab</kbd> for details.

<p>Note that if your site is being triggered with a push mechanism, then you
don't need to worry about any of this.</p>

<toc-add-entry name="settings">Recommended additional settings</toc-add-entry>

<p>If you are going to make the Debian mirror available through HTTP, please
add the following settings to your Apache configuration (presuming, of
course, you will use Apache), within the
<code>&lt;Directory <var>/path/to/your/debian/mirror</var>&gt;</code>
block, where <var>/path/to/your/debian/mirror</var> should be the actual
name of the directory where you keep the mirror:</p>

<pre>
   Options +Indexes +SymlinksIfOwnerMatch
   IndexOptions NameWidth=* +SuppressDescription
   DirectoryIndex .
</pre>

<p>This enables the directory indices and makes sure and that following
symlinks will work. The file names in the directory indices won't be truncated,
and (mostly nonexistent) descriptions won't be shown.</p>
