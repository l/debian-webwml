#use wml::debian::template title="Sätta upp en &quot;push&quot;-server"
#use wml::debian::translation-check translation="1.17"
#use wml::debian::toc

<p>Att sätta upp en <q>push</q>server består av två grundläggande steg:
Ställa in rsync-åtkomst (för normal <q>pull</q>-spegling) och ställa in en
ssh-utlösarmekanism (för att trycka (<q>push</q>) i <q>pull</q>-speglingen).
</p>

<p><small>(För mer information om vad en <q>push</q>-server är, läs
<a href="push_mirroring"><q>push</q>-speglingsförklaringen</a>.)</small>
</p>

<toc-display />

<toc-add-entry name="rsync">Ställa in rsync</toc-add-entry>

<p>Installera <code>rsync</code> version 2.1.1 eller senare.
Om din server kör Debian installerar du bara det senaste
<a href="http://packages.debian.org/stable/net/rsync">rsync</a>-paketet.
</p>

<p>Skapa <code>rsyncd.conf</code> och lägg in något i stil med detta:
</p>

<pre>
uid = nobody
gid = nogroup
max connections = 25
socket options = SO_KEEPALIVE

[debian]
  path = /srv/debian/mirror
  comment = Debians arkiv (~250 Gbyte)
  auth users = auktoriserat_konto1,auktoriserat_konto2,auktoriserat_kontoN
  read only = true
  secrets file = /etc/rsyncd/debian.secrets
</pre>

<p>Lägg en post för varje server som hämtar från dig med <q>push</q> i filen
<code>/etc/rsyncd/debian.secrets</code>:
</p>

<pre>
auktoriserat_konto1:ett_lösenord
auktoriserat_konto2:annat_lösenord
auktoriserat_kontoN:lösenord
</pre>

<p>Du har nu gett nedströmsspeglarna tillgång till arkivet på din maskin.
</p>

<p>Du vill antagligen starta rsyncprocessen från inetd.
För att göra detta måste du lägga in rsync-servicen i filen
<code>/etc/services</code> (om det inte redan står där), så här:
</p>

<pre>
rsync           873/tcp
</pre>

<p>För att aktivera servern från inetd, lägger du till följande i din
<code>/etc/inetd.conf</code>:
</p>

<pre>
rsync      stream      tcp         nowait      root /usr/bin/rsync rsyncd --daemon
</pre>

<p>
   (Kom ihåg att sända en HUP-signal till inetd för att tala om för det
    att läsa om sin inställningsfil efter att du ändrat den.)
</p>

<toc-add-entry name="sshtrigger">Ställa in ssh-utlösarmekanism</toc-add-entry>

<p>Skapa en ny ssh-nyckel för kontot som du använder för att spegla Debian.
Se till att du inte skriver över din riktiga ssh-nyckel genom att
använda flaggan -f, till exempel:
</p>

<pre>
ssh-keygen -f ~/.ssh/identity.minserver
</pre>

<p>Se till att den nya öppna nyckeln (~/.ssh/identity.minserver.pub)
innehåller följande i början:
</p>

<pre>
no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty,command="~/sync &amp;"
</pre>

<p>Du måste ställa in skriptet så att det kontaktar speglar nedströms.
Skapa en fil med namnet <code>signal</code> med följande innehåll:
</p>

<protect>
<pre>
#!/bin/sh

# Detta skript anropas för att signalera fjärrvärden att det är dags
# att spegla arkivet.

echo Signalerar $1
ssh -o"BatchMode yes" -o"user $2" "$1" -i $HOME/.ssh/identity.mysite sleep 1
</pre>
</protect>

<p>Detta skript kommer att logga in på fjärrvärden genom att använda den
speciella ssh-nyckel du skapade ovan, förutsatt att varje nedströmsspegelsoperatör
lägger till denna nyckel till deras egen ~/.ssh/authorized_keys (och ersätter
"sync" med "anonftpsync" eller vad deras kommando för att starta speglingen kallas).
Skriptet själv gör inget användbart på den andra sidan, 
kommandot kommer att köras som specificerat i nyckelinställningarna.
</p>

<p>För att faktiskt signalera speglarna måste du köra
<code>./signal &lt;plats&gt; &lt;användar-id&gt;</code> efter att din egen
rsyncning utförts.
Därmed kommer du, så snart som din plats har speglat klart från din uppströmsplats,
att börja föra speglingen vidare (<q>push</q>) till de nedströms från dig.
</p>

<p>Du kan placera dessa kommandon antingen i slutet av ditt
<code>anonftpsync</code>-skript eller, om det är enklare för dig, i ett nytt
skript och sedan köra detta skript från <code>anonftpsync</code>, exempelvis:
</p>

<protect>
<pre>
#!/bin/sh

# Detta skript anropas av websync för att signalera nedströmsspeglarna.

cd $HOME

./signal någon.annan.plats archvsync
./signal och.ytterligare.en kontopåandrasidan
</pre>
</protect>

<p>Om du har problem med detta,
<a href="mailto:mirrors@debian.org">kontakta oss</a>.
</p>
