#use wml::debian::template title="Sätta upp en &quot;push&quot;-server"
#use wml::debian::translation-check translation="1.10"

<p>Att sätta upp en "push"-server består av två grundläggande steg:
Ställa in rsync-åtkomst (för normal "pull"-spegling) och ställa in en
ssh-utlösarmekanism (för att trycka ("push") i "push"-speglingen).

<p><small>(För mer information om vad en "push"-server är, läs
<a href="push_mirroring">"push"-speglings-förklaringen</a>.)</small>

<h2>Ställa in rsync</h2>

<p>Installera <code>rsync</code> version 2.1.1 eller senare.
Om din server kör Debian installerar du bara det senaste
<a href="http://packages.debian.org/stable/net/rsync.html">rsync</a>-paketet.

<p>Skapa <code>rsyncd.conf</code> och lägg in något i stil med detta:

<pre>
uid = nobody
gid = nogroup
max connections = 25
syslog facility = daemon
socket options = SO_KEEPALIVE

[debian]
  path = /org/ftp.debian.org/ftp
  comment = Debians ftp-arkiv (~24 Gbyte)
  auth users = auktoriserat_konto1,auktoriserat_konto2,auktoriserat_kontoN
  read only = true
  secrets file = /etc/rsyncd/debian.secrets
[debian-web]
  path = /org/www.debian.org/debian.org
  comment = Debians webbplats (~400 Mbyte)
  auth users = auktoriserat_konto1,auktoriserat_konto2,auktoriserat_kontoN
  read only = true
  secrets file = /etc/rsyncd/debian.secrets
</pre>

<p>Lägg en post för varje server som hämtar från dig med "push" i filen
<code>/etc/rsyncd/debian.secrets</code>:

<pre>
auktoriserat_konto1:ett_lösenord
auktoriserat_konto2:annat_lösenord
auktoriserat_kontoN:lösenord
</pre>

<p>Du har nu gett nedströmsspeglingarna tillgång till arkivet på din maskin.

<p>Du vill antagligen starta rsyncprocessen från inetd.
För att göra detta måste du lägga in rsync-servicen i filen
<code>/etc/services</code> (om det inte redan står där), så här:

<pre>
rsync           873/tcp
</pre>

<p>För att aktivera servern från inetd, lägger du till följande i din
<code>/etc/inetd.conf</code>:

<pre>
rsync      stream      tcp         nowait      root /usr/bin/rsync rsyncd --daemon
</pre>

<p>
   (Kom ihåg att sända en HUP-signal till inetd för att tala om för det
    att läsa om sin inställningsfil efter att du ändrat den.)

<h2>Ställa in ssh-utlösarmekanism</h2>

<p>Skapa en ny ssh-nyckel för kontot som du använder för att spegla Debian.
Se till att du inte skriver över din riktiga ssh-nyckel genom att
använda flaggan -f, till exempel:

<pre>
ssh-keygen -f ~/.ssh/identity.minserver
</pre>

<p>Se till att den nya öppna nyckeln (~/.ssh/identity.minserver.pub)
innehåller följande i början:

<pre>
no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty,command="~/websync &amp;"
</pre>

<p>(ersätt "websync" med "ftpsync" eller "ftpsync-non-US" eller vad du nu
använder för kommando för att starta speglingen)

<p>Du måste ställa in skriptet så att det kontaktar speglingar nedströms.
Skapa en fil med namnet <code>signal</code> med följande innehåll:

filerna <kbd>runmirrors</kbd>, med innehållet:

<protect>
<pre>
#!/bin/sh

# Detta skript anropas för att signalera fjärrvärden att det är dags
# att spegla arkivet.

echo Signalerar $1
ssh -o"BatchMode yes" -o"user $2" "$1" -i $HOME/.ssh/identity.mysite sleep 1
</pre>
</protect>

<p>Detta skript kommer att logga in på fjärrvärden genom att använda den
speciella ssh-nyckel du skapade ovan.
Skriptet själv gör inget användbart på den andra sidan, ~/websync
(eller ~/ftpsync eller ~/ftpsync-non-US) kommer att köras från nyckeln.

<p>För att faktiskt signalera speglarna måste du lägga in rader på formen
<code>./signal &lt;plats&gt; &lt;användar-id&gt;</code> i slutet av
antingen <code>websync</code>-skriptet, eller, om det är enklare för dig,
i ett nytt skript som du anropar från <code>websync</code>.

<p>Detta nya skript, <code>runmirrors</code>, skulle då innehålla något sånt
här:

<protect>
<pre>
#!/bin/sh

# Detta skript anropas av websync för att signalera nedströmsspeglarna.

cd $HOME

./signal någon.annan.plats archvsync
./signal och.ytterligare.en kontopåandrasidan
</pre>
</protect>

<p>Därmed kommer du börja trycka data till dina nedströmsspeglar så fort
du är klar med att spegla från uppströmsservern.

<p>Om du har problem med detta,
<a href="mailto:mirrors@debian.org">kontakta oss</a>.
