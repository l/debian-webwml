#use wml::debian::cdimage title="Debian CD イメージのミラーサイトになるには" BARETITLE=true
#use wml::debian::toc
#use wml::debian::translation-check translation="1.8"

<p>Debian CD イメージのミラーサイトになるには、インターネットへの確実
な常時接続ができる Linux か Unix 系のマシンが必要です。</p>

<p>CD イメージミラーには、通常、jigdo テンプレートが置いてありますが、
あらかじめ作成されたフルイメージが置いてあるところもあります。テンプレー
トは、普通、<a href="../jigdo-cd/#which">公式の場所のうち 1 つ</a>から 
rsync で更新され、フルイメージは <kbd>jigdo-mirror</kbd> で更新されま
す。</p>

<toc-display/>

<hr>

<toc-add-entry name"httpftp">FTP や HTTP が適切で<strong>ない</strong>理由</toc-add-entry>

<p>FTP や HTTP でイメージを入手するようにすべきでは <em>ありません
</em>。これらの転送方法は、巨大なイメージファイルサイズのため失敗しや
すいからです。</p>

<p>
さらに、イメージがわずかに変化した場合 (サブリリースなどの場合にこうなります)
にも、全体を再ダウンロードしなければなりません。
この結果、コンピュータにもネットワークにも大きな負荷がかかります。
</p>

<toc-add-entry name="download">rsync でダウンロードする</toc-add-entry>

<p>上記の理由から、私たちは <a href="http://rsync.samba.org/"> <tt>rsync</tt></a>
プログラムを使っています。これは本質的にはバイナリパッチを行うプログラムです。
<tt>rsync</tt> により、サブリリースのイメージを大変効率的に更新できます。
これは、変更部分だけをネットワークで転送すればよく、変更されなかった部分は以前のイメージからコピーすれば済むからです。
</p>

<p>Debian CD イメージのみを組み入れたい(そして他の Debian ミラーは組み
入れたくない)サイトや、近くの/速い Debian (<kbd>debian/</kbd>)ミラーが
ないサイトには <kbd>rsync</kbd> を毎日の cron ジョブとして使用すること
を提案します。</p>

<p><a href="rsync-mirrors">このミラーの一覧</a>のサイトのどこからでも
ミラーを行なうことができます。</p>

<p>最低限、オプション <strong><kbd>--times --links --hard-links
--block-size=8192</kbd></strong> を使用してください。これにより、変更
時間、シンボリックリンクおよびハードリンクが保持され、ブロックサイズに 
8192 バイトが使用されます(CD イメージに最適です)。変更時間とサイズが同
じなら、<kbd>rsync</kbd> はファイルをそのままにするため、
<tt>--times</tt> は事実上必須です。</p>

<toc-add-entry name="jigdomirror">jigdo-mirror でイメージを生成する</toc-add-entry>

<p>多くの人が「通常の」 Debian ミラー(<kbd>debian/</kbd>)を保守してい
ます。あるいは、近くにそのようなミラーがあります。これはすなわち、CD 
イメージに含まれる .deb をすでに持っているということです。すると、なぜ
同じファイルを CD イメージに使えないのか? という明らかな疑問がわきます。
</p>

<p><kbd>jigdo-mirror</kbd> は「普通の」ミラーのファイルといくつか追加
の jigdo テンプレートファイルを使用して Debian CD イメージを生成するこ
とを可能にするプログラムです。</p>

<p><kbd>jigdo-mirror</kbd> は jigdo 0.6.8 に含まれますが、このバージョ
ンは Debian 3.0 ("woody") には入っていないことに注意してください。これ
は、別途入手する必要があるということですが、新しいバージョンを "woody" 
で使用することに実際上の問題はありません。</p>

<p>まず最初に、jigdo テンプレートファイルが必要です。これはほとんどの
公式サイトで入手できますが、2 つの一次配布場所は以下のとおりです。</p>

<ul compact>
  <li><kbd>rsync us.cdimage.debian.org::jigdo-area/</kbd> (USA mirror)
  <li><kbd>rsync non-us.cdimage.debian.org::debian-jigdo/</kbd> (European mirror)
</ul>

<p>イメージを作成したいアーキテクチャの各々について、ファイルを
&lt;<var>version</var>&gt;/jigdo/&lt;<var>architecture</var>&gt;
サブディレクトリから取得します。</p>

<p>プログラムを設定するため、<kbd>~/.jigdo-mirror</kbd> ファイルを作成
します。これは一例です。</p>

<pre>
jigdoDir="/where/you/keep/mirrors/debian-cd/current/jigdo"
imageDir="/where/you/keep/mirrors/debian-cd/current/images"
tmpDir="/where/you/keep/mirrors/debian-cd/current/images"
debianMirror="file:/where/you/keep/mirrors/debian"
nonusMirror="file:/where/you/keep/mirrors/debian-non-US"
include='i386/|sparc/|powerpc/|source/'; exclude='-1\.'
</pre>

<p>変数 <i>include</i> と <i>exclude</i> はイメージを作成したいアーキ
テクチャの一覧を含んでいます(正規表現)。さらに詳しい情報については、
<kbd>jigdo-mirror</kbd> のマニュアルページかソース自体を見てください
(多くのコメントがついたシェルスクリプトです)。</p>

<p>設定が終わったら、<kbd>jigdo-mirror</kbd> を実行するだけですべてを
勝手にやってくれます。大量の出力を行ない、おそらくしばらく時間がかかり
ますので、それを扱うための手順を踏むことを提案します(screen の中で実行
する、出力をファイルにリダイレクトする、など)。

<toc-add-entry name="pik">pseudo-image kit と debcdmirror でイメージを生成する</toc-add-entry>

<p><tt>rsync</tt> 単体で使った場合、全く新しいリリースの際には全イメージのダウンロードが行われます。
これは、イメージ中に変更されない部分がほとんどないためです。
しかしながら、疑似イメージキットを用いれば、近くの Debian FTP ミラー
(場合によってはローカルのミラー) にすでにあるデータを用いて擬似的な CD
イメージを作成できますし、<tt>rsync</tt>
でその疑似イメージにバイナリパッチを当てて公式版に更新することが出来ます。
さらにサブリリースの際にはたいていの場合、旧イメージにパッチを当てた方が効率がよいことも分かっています。
</p>

<p><strong>この節の情報は古いかもしれません! 通常の rsync を使用するか 
jigdo-mirror を試すことをおすすめします。</strong></p>

<p>疑似イメージキットは、普通の人の要求に合わせて、主に一つないしは数個のイメージのみをダウンロードする目的で設計されています。
この発展形として、疑似イメージキットと <tt>rsync</tt>
を自動的に使ってミラーを更新し、更にはダウンロードした各イメージの MD5
チェックサムの計算までを自動的に行ってくれる、ミラー作成を
<em>実に</em> 簡単にする <tt>debcdmirror</tt> スクリプトがあります。
<tt>debcdmirror</tt> では、なにをミラーするのか正確に指定することも出来ます。
</p>

<p>疑似イメージキットの手動での使用(おそらくはサブリリースの更新のため
に <tt>rsync</tt> も使用する)は大変で問題も多いため、おすすめしません。</p>

<p>代わりに、<tt>debcdmirror</tt> スクリプト(「内部的に」疑似イメージ
キットと <tt>rsync</tt> を使用)を使用したほうがよいでしょう。</p>

<p>最新の疑似イメージキットは
<a href="http://cdimage.debian.org/~costar/pseudo-image-kit/">疑似イメージキット</a> で、最新の <tt>debmirror</tt> は
<a href="http://cdimage.debian.org/~costar/debcdmirror/"><tt>debcdmirror</tt></a>
の、各々作者のページに置かれています。両方のパッケージの README
に作業手順の詳細な情報が記載されています。</p>

<p><strong>注記:</strong><p>

<p><tt>debcdmirror</tt> スクリプトでは、"<tt>ls-lR</tt>" ファイルを提供する
<tt>rsync</tt> ミラーサイトを選択する必要があります。
このようなミラーサイトのアドレスは
<a href="rsync-mirrors">rsync ミラーリスト</a> にあります。

<p>もしローカルの <a href="$(HOME)/mirror/">"通常の" Debian FTP ミラー</a>
が無い場合、<a href="$(HOME)/mirror/list" >ミラーサイトのリスト</a>
を見てください。</p>

<p><tt>debcdmirror</tt> では <tt>bash</tt> バージョン 2 以上が必要です。
これは最近の Debian システムでは問題ではありません。
必要な場合は <tt>bash</tt> を標準以外の場所にインストールすることも出来ますが、
その場合スクリプトの最初の行で <tt>bash</tt>
へのパスを指定するようにしてください。</p>

<toc-add-entry name="test">テストイメージ</toc-add-entry>

<p>"<tt><i>codename</i>_test</tt>" ディレクトリには、バージョン付きのディレクトリ以下のイメージにハードリンクされたイメージが置かれています。
バージョン付きのディレクトリ名は (サブ) リリースごとに変わりますが、
"<tt>test</tt>" ディレクトリ以下の名前は変化しません。</p>

<p>従って <tt>rsync</tt>
だけを使う環境では、バージョン付きのイメージと適切な "<tt>test</tt>"
ディレクトリの両方をミラーして、<em>同時に</em> <tt>--hard-links</tt>
オプションを指定するのがサブリリースを適切に更新するために必須です。
<tt>debcdmirror</tt> を使う場合には "<tt>test</tt>" ディレクトリは
<em>含めない</em> で下さい。これは <tt>debcdmirror</tt> は <tt>rsync</tt>
とは異なった、かつもっと効率のよいやり方を用いているからです。
</p>

<toc-add-entry name="ls-lR">ls-lR ファイル</toc-add-entry>

<p><tt>ls-lR</tt> はミラーが置かれているサイトのディレクトリ構造を記載したものです。この <tt>ls-lR</tt> ファイルをミラー <strong>しないで下さい</strong>。
自分で作成するか (提供されている "<tt>Makels-lR</tt>" を使って <tt>cron</tt>
で毎時作成する)、<tt>ls-lR</tt> を全く置かないかのどちらかとしてください。
<tt>debcdmirror</tt> の場合は、ミラー作成後にローカルの <tt>ls-lR</tt>
が自動的に作成されます。
</p>

<toc-add-entry name="serve">ファイルを提供する</toc-add-entry>

<p>ミラーしたい CD イメージ (i386 とソース CD が人気があります) を取得した後、
<tt>rsync</tt> サーバプログラムを走らせる必要があります。
これはマシンに大きな負荷はかけませんし、FTP/HTTP
サービスに比べてネットワーク負荷も比較的軽いものです。</p>

<p>サーバの設定方法は、疑似イメージキットの README に記載されています。
簡単にいえば、<kbd>rsync --daemon</kbd> を <i>inetd</i> の設定に追加し
て <kbd>rsyncd.conf</kbd> を好みに応じて設定します。IP アドレスごとに
大量接続へのアクセス制限をかけて、トータルで多くても 2 桁の数字にして
おくことをおすすめします。</p>

# TODO: include more stuff here rather than depending on pik, with examples

<toc-add-entry name="register">私たちの一覧にミラーを登録する</toc-add-entry>

<p>あなたの CD イメージミラーをより多くの人にとって役に立つものとする
ために、<a href="../http-ftp/">こちら</a>か<a href="rsync-mirrors">こ
ちら</a>のようなミラー一覧に登録できます。しかし、フルイメージは非常に
大きなファイルなので、1 日あたり何ギガバイトものネットワークトラフィッ
クが流れる原因となるかもしれません。</p>

<p><a href="$(HOME)/mirror/submit">ミラー申請フォーム</a>(CDImage-* フィー
ルドが重要であることに注意してください)か、e-mail を <a
href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;debian-cd&#64;lists.debian.org">\
debian-cd&#64;lists.debian.org</a> に送ることで自分のミラーを登録でき
ます。</p>

<p>新しい CD イメージミラーをお待ちしています。ぜひご協力を!</p>
