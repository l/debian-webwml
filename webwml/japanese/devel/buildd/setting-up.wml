#use wml::debian::template title="buildd の設定" BARETITLE="true"
#use wml::debian::translation-check translation="1.9"

<p>ここには、Debian の buildd 設定方法の種明かしがあります。
この文書は Andreas Barth によって experimental 及び backports.org の
buildds を設定する際に書かれたものなので、開発者が自分のマシンで autobuilder
を使って Debian の設定をするときとは完全には一致しないかもしれません。</p>

<p>buildd は db.debian.org にある buildd あるいは <a
 href="http://svn.cyberhqz.com/svn/wanna-build/">wanna-build</a>
のソースから抽出して使用することができます。db.debian.org
にあるものを使いたい場合は、sources.list に
<tt>deb http://db.debian.org debian-admin/</tt> を追加して buildd
をインストールしてください。</p>

<p>さらに、testing 用や unstable 用の chroot をセットアップするのに debootstrap
が必要になります。したがって、このために backport
が必要になるかもしれません。backports リポジトリから取得するか、
あるいは自分でソースからビルドすることもできます。</p>

<p>(<tt>/org/buildd/</tt> 以下に)
次に挙げるディレクトリを作成する必要があります:</p>
<pre>
install -d build mqueue -o buildd -g buildd
install -d chroots -m 755
install -d logs stats -o buildd -g buildd
install -d secret -o buildd -g adm -m 2770
install -d /var/debbuild/srcdep-lock -o buildd
install -d /var/lib/sbuild/srcdep-lock -o buildd
install -d chroots/sid/var/debbuild/srcdep-lock -o buildd
install -d chroots/sid/build/buildd -m 777
install -d chroots/woody-backports/var/debbuild/srcdep-lock -o buildd
install -d chroots/woody-backports/build/buildd -m 777
install -d bin -o buildd -g adm -m 775
cp /etc/passwd chroots/sid/etc/
cp /etc/passwd chroots/woody-backports/etc/
ln -s source-dependencies-unstable /etc/source-dependencies-sid-nonfree
sudo ln -s source-dependencies-stable /etc/source-dependencies-woody-backports.org
</pre>

<p>chroot してから:</p>
<pre>
sudo debootstrap --variant=buildd sid chroots/sid http://ftp.debian.org/debian
sudo ln -s /org/buildd/chroots/sid/ build/chroot-unstable
</pre>

<p>それから、必要となるパッケージを更新、インストールしてください:</p>
<pre>
sudo chroot chroots/sid apt-get update
sudo chroot chroots/sid apt-get install fakeroot build-essential sudo debfoster
sudo chroot chroots/sid debfoster
</pre>

<p>woody-backports についても:</p>
<pre>
sudo debootstrap --variant=buildd woody chroots/woody-backports http://ftp.debian.org/debian
sudo ln -s /org/buildd/chroots/woody-backports/ build/chroot-woody-backports.org
</pre>

<p><tt>chroots/woody-backports/etc/apt/sources.list</tt>
を編集しましょう</p>
<pre>
deb http://ftp.debian.org/debian woody main non-free contrib
deb-src http://ftp.debian.org/debian woody main non-free contrib
deb-src ftp://linux.mathematik.tu-darmstadt.de/pub/linux/distributions/debian-backports/debian woody all
</pre>

<p>アップグレード及びインストールをしましょう:</p>
<pre>
sudo chroot chroots/woody-backports apt-get update
sudo chroot chroots/woody-backports apt-get install fakeroot build-essential sudo debfoster
sudo chroot chroots/woody-backports debfoster
</pre>

<p>次は .sbuildrc を作成しましょう:</p>
<pre>
# ログを送信する宛先のメールアドレス (必須、デフォルト値はありません!)
$mailto = '好きなように';

# .changes ファイルで使用される管理者の名前 (必須、デフォルト値はありません!)
$maintainer_name='changes で使いたい名前';

#$fakeroot='/usr/bin/sudo';
$fakeroot='/usr/bin/fakeroot';

%dist_order = ( 'oldstable-security' => 0, stable => 1, 'stable-security' => 1, testing => 2, 'testing-security' => 2, unstable => 3, 'woody-backports.org' => 5, 'sarge-backports.org' => 6, experimental => 7 );
</pre>

<p>buildd ユーザを sudo 設定ファイルに追加して、
制限なしでツールを実行できるようにするのを忘れないでください。</p>

<p>はい、それではテストしましょう:
~buildd/build に移動してパッケージをビルドしてみましょう:</p>
<pre>
sbuild -d unstable -v netpbm-nonfree_2:9.20-2
sbuild -d woody-backports.org -v arj_3.10.19-1.backports.org.1
</pre>

<p>~buildd/.forward に <tt>|/usr/bin/buildd-mail-wrapper</tt>
を追加して buildds のメールに返信できるようにしましょう。</p>

<p>~buildd/buildd.conf も調整する必要があります - しかし、残念ながらこれは
wanna-build によって変わるのでその種明かしはできません。</p>

<p>buildd の状態についてのさらなる詳細は、<a
 href="wanna-build-states">ここ</a>から得ることができます。buildd
のメールには、署名済み changes ファイルか、"give-back", "retry",
"dep-wait", "failed", "dep-wait &lt;依存関係&gt;",
"failed\n&lt;失敗の原因&gt;" のどれかを返信すべきです。</p>

<p>cronjob のタスクとして以下を使うことができます:</p>
<pre>
@reboot        touch ~buildd/NO-DAEMON-PLEASE
17 * * * * /usr/bin/buildd-watcher
47 * * * * /usr/bin/buildd-uploader
</pre>
