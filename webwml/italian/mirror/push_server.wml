#use wml::debian::template title="Configurare un server push"
#use wml::debian::toc
#use wml::debian::translation-check translation="1.19" maintainer="Luca Monducci"

<p>La configurazione di un server push consiste in due compiti di base: la
configurazione dell'accesso rsync (per un normale mirroring di tipo
<q>pull</q>) e la configurazionre del un meccanismo di attivazione
via ssh (per avviare il mirroring push).</p>

<p><small>(Per maggiori informazioni su cosa è un server push si veda
<a href="push_mirroring">la spiegazione sul push mirroring</a>.)</small></p>

<toc-display />

<toc-add-entry name="rsync">Configurazione di rsync</toc-add-entry>

<p>Installare <code>rsync</code> 2.1.1 o superiore. Se sul proprio
sito si utilizza Debian, è sufficiente installare il pacchetto
<a href="http://packages.debian.org/stable/net/rsync">rsync</a>
più recente.</p>

<p>Creare il file <code>rsyncd.conf</code> e inserirvi qualcosa di
simile a questo:</p>

<pre>
uid = nobody
gid = nogroup
max connections = 25
socket options = SO_KEEPALIVE

[debian]
  path = /srv/debian/mirror
  comment = The Debian Archive (~250 GB)
  auth users = authorized_account1,authorized_account2,authorized_accountN
  read only = true
  secrets file = /etc/rsyncd/debian.secrets
</pre>

<p>Aggiungere nel file <code>/etc/rsyncd/debian.secrets</code> una voce per
ogni sito verso cui si vuole effettuare il pushing:</p>

<pre>
authorized_account1:a_password
authorized_account2:another_password
authorized_accountN:password
</pre>

<p>Con questo si è dato accesso ai mirror destinazione all'archivio
sulla propria macchina.</p>

<p>Per far avviare il demone rsync da inetd si deve aggiungere il servizio
rsync nel file <code>/etc/services</code> (se non fosse già presente), in
questo modo:</p>

<pre>
rsync           873/tcp
</pre>

<p>Per abilitare il demone da inetd, aggiungere quanto segue al proprio file
<code>/etc/inetd.conf</code>:</p>

<pre>
rsync      stream      tcp         nowait      root /usr/bin/rsync rsyncd --daemon
</pre>

<p>(Ricordasi di inviare a inetd un segnale HUP per fargli rileggere il file
di configurazione dopo la modifica).</p>

<toc-add-entry name="sshtrigger">Configurazione del meccanismo di attivazione con ssh</toc-add-entry>

<p>Creare una nuova chiave ssh per l'account che usa per il mirror di
Debian. Assicurarsi di non sovrascrivere la chiave ssh originale usando
l'opzione -f, per esempio:</p>

<pre>
ssh-keygen -f ~/.ssh/identity.mysite
</pre>

<p>Assicurarsi che la nuova chiave pubblica (~/.ssh/identity.mysite.pub)
contenga all'inizio questo, dove IPADDRESS è l'indirizzo IP del proprio
mirror di origine:</p>

<pre>
no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty,command="~/bin/ftpsync,from="IPADDRESS" &amp;"
</pre>

<p>Occorre configurare uno script che contatterà i mirror destinazione.
Creare un file chiamato <code>signal</code>, con il seguente contenuto:</p>

<protect>
<pre>
#!/bin/sh

# This script is called to signal the remote host that it is time to
# mirror the archive.

echo Signalling $1
ssh -o"BatchMode yes" -o"user $2" "$1" -i $HOME/.ssh/identity.mysite sleep 1
</pre>
</protect>

<p>Questo script si allocherà sulla macchina remota usando la speciale
chiave ssh creata prima, fornita a ciascun mirror destinatario e aggiunta
nei rispettivi ~/.ssh/authorized_keys (sostituendo <q>ftpsync</q> con
con un qualsiasi altro comando per avviare il
mirroring). Lo script stesso non farà nulla di utile in remoto, l'unico
comando sarà lanciato in base alle impostazioni dalla chiave.</p>

<p>Per inviare un segnale ai mirror effettivamente, è necessario aggiungere
le righe <code>./signal &lt;site&gt; &lt;username&gt;</code> al termine di
del proprio rsync. Quindi, appena completato il proprio mirroring con il
sito di origine, inizia il push verso i propri destinatari.</p>

<p>È possibile mettere questi comandi sia all'inizio che al termine del
proprio script <code>ftpsync.conf</code> oppure, se più conveniente, in
un nuovo script che viene avviato da <code>anonftpsync</code>, per
esempio:</p>

<protect>
<pre>
#!/bin/sh

# This script is called by websync to signal the downstream mirrors.

./signal some.other.site archvsync
./signal and.another.site othersiteaccount
</pre>
</protect>

<p>In caso di problemi, <a href="mailto:mirrors@debian.org">\
contatteci</a>.</p>
