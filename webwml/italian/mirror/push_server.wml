#use wml::debian::template title="Configurare un server push"
#use wml::debian::translation-check translation="1.10"

<p>Configurare un server push consiste in due compiti di base:
configurare l'accesso rsync (per un normale mirroring di tipo "pull")
e configurare un meccanismo di attivazione via ssh
(per "lanciare" il mirroring pull).

<p><small>(Per maggiori informazioni su cosa è un server push, leggi
<a href="push_mirroring">la spiegazione sul push mirroring</a>.)</small>

<h2>Configurare rsync</h2>

<p>Installa <code>rsync</code> 2.1.1 o superiore. Se il tuo sito
gira su Debian, installa semplicemente il più recente pacchetto
<a href="http://packages.debian.org/stable/net/rsync.html">rsync</a>.

<p>Crea un <code>rsyncd.conf</code> e scrivici dentro qualcosa di
simile a questo:

<pre>
uid = nobody
gid = nogroup
max connections = 25
syslog facility = daemon
socket options = SO_KEEPALIVE

[debian]
  path = /org/ftp.debian.org/ftp
  comment = Debian FTP Archive (~24 GB)
  auth users = authorized_account1,authorized_account2,authorized_accountN
  read only = true
  secrets file = /etc/rsyncd/debian.secrets
[debian-web]
  path = /org/www.debian.org/debian.org
  comment = Debian Web Site (~400 MB)
  auth users = authorized_account1,authorized_account2,authorized_accountN
  read only = true
  secrets file = /etc/rsyncd/debian.secrets
</pre>

<p>Aggiungi una voce per ogni sito per il quale fai pushing nel file
<code>/etc/rsyncd/debian.secrets</code>: 

<pre>
authorized_account1:a_password
authorized_account2:another_password
authorized_accountN:password
</pre>

<p>A questo punto hai dato accesso ai mirror destinazione all'archivio
della tua macchina.

<p>Probabilmente vorrai avviare il demone rsync da inetd. Per farlo,
devi aggiungere il servizio rsync nel file <code>/etc/services</code> 
(se non fosse già lì), in questo modo:

<pre>
rsync           873/tcp
</pre>

Per abilitare il demone da inetd, aggiungi quanto segue al tuo file
<code>/etc/inetd.conf</code>:

<pre>
rsync      stream      tcp         nowait      root /usr/bin/rsync rsyncd --daemon
</pre>

(Ricorda di inviare a inetd un segnale HUP per dirgli di rileggere
il proprio file di configurazione dopo la modifica).

<h2>Configurare un meccanismo di attivazione con ssh</h2>

<p>Crea una nuova chiave ssh per l'account che usi per il mirror di
Debian. Assicurati di non sovrascrivere la chiave ssh originale usando
l'opzione -f, per esempio:

<pre>
ssh-keygen -f ~/.ssh/identity.mysite
</pre>

<p>Assicurati che la nuova chiave pubblica (~/.ssh/identity.mysite.pub)
contenga all'inizio questo:

<pre>
no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty,command="~/websync &amp;"
</pre>

<p>(sostituisci "websync" con "ftpsync", o "ftpsync-non-US", o il nome
del comando che fa partire il mirroring)

<p>Occorre che configuri uno script che contatterà i mirror
destinazione.
Crea un file chiamato <code>signal</code>, contenga questo:

<protect>
<pre>
#!/bin/sh

# This script is called to signal the remote host that it is time to
# mirror the archive.

echo Signalling $1
ssh -o"BatchMode yes" -o"user $2" "$1" -i $HOME/.ssh/identity.mysite sleep 1
</pre>
</protect>

<p>Questo script si allocherà sulla macchina remota usando la speciale
chiave ssh creata prima. Lo script stesso non farà nulla di utile
in remoto, il comando
~/websync (o ~/ftpsync, o ~/ftpsync-non-US) sarà lanciato dalla chiave.

<p>Per inviare un segnale ai mirror effettivamente, hai bisogno di 
aggiungere le righe
<code>./signal &lt;site&gt; &lt;username&gt;</code> 
alla fine dello script
<code>websync</code>, o
se lo ritieni più conveniente per te, in un nuovo script,
e lanciare quindi quello script da
<code>websync</code>.

<p>Il nuovo script, 
<code>runmirrors</code>, contiene qualcosa come questo:

<protect>
<pre>
#!/bin/sh

# This script is called by websync to signal the downstream mirrors.

./signal some.other.site archvsync
./signal and.another.site othersiteaccount
</pre>
</protect>

<p>
Perciò, non appena il tuo sito ha finito il mirroring dalla propria
sorgente, farai partire il pushing mirror di queste destinazioni da te.

<p>Se hai problemi con queste cose, <a href="mailto:mirrors@debian.org">
contattaci</a>.
