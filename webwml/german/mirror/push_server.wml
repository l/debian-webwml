#use wml::debian::template title="Einrichten eines Push-Spiegels"
#use wml::debian::toc
#use wml::debian::translation-check translation="1.12"
# $Id$

<p>Einen Push-Spiegel aufzusetzen, besteht aus zwei Aufgaben:
Einrichten des rsync-Zugangs (für normales, <q>Pull</q>-Spiegeln) und
Einrichtung des Auslöse-Mechanismus (für den <q>pushing</q>-Teil des
<q>Pull</q>-Spiegelns).</p>

<p><small>(Wenn Sie genauere Informationen darüber erhalten möchten,
was ein Push-Spiegel ist, lesen Sie bitte <a href="push_mirroring">die
Beschreibung des Push-Spiegelns</a>.)</small></p>

<toc-display />

<toc-add-entry name="rsync">rsync einrichten</toc-add-entry>

<p>Installieren Sie <code>rsync</code> 2.1.1 oder neuer. Wenn Ihr
Rechner unter Debian läuft, installieren Sie einfach das neueste
<a href="http://packages.debian.org/stable/net/rsync">rsync</a>-Paket.</p>

<p>Erzeugen Sie die Datei <code>rsyncd.conf</code> und schreiben Sie
etwas Ähnliches wie das Folgende hinein:</p>

<pre>
uid = nobody
gid = nogroup
max connections = 25
socket options = SO_KEEPALIVE

[debian]
  path = /srv/debian/mirror
  comment = The Debian Archive (~250 GB)
  auth users = autorisierter_Zugang1,...,autorisierter_ZugangN
  read only = true
  secrets file = /etc/rsyncd/debian.secrets
</pre>

<p>Fügen Sie einen Eintrag für jeden Rechner zur Datei
<code>/etc/rsyncd/debian.secrets</code> hinzu, bei dem Sie das
Spiegeln einleiten:</p>

<pre>
autorisierter_Zugang1:ein_Passwort
autorisierter_ZugangN:ein_weiteres_Passwort
</pre>

<p>Sie haben jetzt den in der Hierarchie tiefergelegenen Spiegeln
Zugriff zu Ihrem Rechner gewährt.</p>

<p>Sie möchten wahrscheinlich den rsync-Daemon von inetd aufrufen
lassen. Um dies zu erledigen, müssen Sie den rsync-Dienst in die
Datei <code>/etc/services</code> eintragen (falls er dort noch nicht
steht), ungefähr wie folgt:</p>

<pre>
rsync           873/tcp
</pre>

<p>Um den Daemon per inetd zu starten, fügen Sie das Folgende zu
Ihrer Datei <code>/etc/inetd.conf</code> hinzu:</p>

<pre>
rsync      stream      tcp         nowait      root /usr/bin/rsync rsyncd --daemon
</pre>

<p>
(Sie müssen dem inetd anschließend ein HUP-Signal schicken, um
ihm mitzuteilen, dass die Konfiguration neu eingelesen werden soll.)
</p>

<toc-add-entry name="sshtrigger">Einrichten des SSH-Auslöser-Mechanismus</toc-add-entry>

<p>Erzeugen Sie einen neuen SSH-Schlüssel für den Zugang, den Sie
verwenden, um Debian zu spiegeln. Stellen Sie sicher, dass Sie den
eigentlichen SSH-Schlüssel nicht überschreiben, indem Sie die Option
-f verwenden, beispielsweise:</p>

<pre>
ssh-keygen -f ~/.ssh/identity.meinRechner
</pre>

<p>Stellen Sie sicher, dass der neue öffentliche Schlüssel
(~/.ssh/identity.meinRechner.pub) Folgendes am Dateianfang enthält:</p>

<pre>
no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty,command="~/sync &amp;"
</pre>

<p>Sie müssen ein Skript einrichten, das die tiefergelegenen Spiegel
kontaktiert. Erzeugen Sie eine Datei mit dem Namen
<code>signal</code>, die Folgendes enthält:</p>

<protect>
<pre>
#!/bin/sh

# Dieses Skript wird gestartet, um dem entfernten Rechner zu signalisieren,
# dass es Zeit zum Spiegeln des Archivs ist.

echo Signalisiere $1
ssh -o"BatchMode yes" -o"user $2" "$1" -i $HOME/.ssh/identity.meinRechner sleep 1
</pre>
</protect>

<p>Dieses Skript wird sich mit dem speziellen SSH-Schlüssel, den Sie
oben erstellt haben, auf einem entfernten Rechner einloggen, vorausgesetzt,
jeder Spiegel unterhalb von Ihnen fügt diesen Schlüssel zu seiner eigenen 
~/.ssh/authorized_keys hinzu (ebenfalls mit der Ersetzung von <q>sync</q> durch
<q>anonftpsync</q> oder wie auch immer sein Befehl zum Starten des Spiegelns
genannt ist). Das
Skript selbst wird nichts sinnvolles auf dem entfernten Rechner
machen, der einzelne Befehl wie er in der Schlüsseleinstellung angegeben ist
wird ausgeführt.</p>

<p>Um den Spiegeln tatsächlich ein Signal zu senden, müssen Sie <code>./signal
   &lt;Site&gt; &lt;Benutzername&gt;</code> ausführen, sobald Ihr eigener 
   Rsync-Lauf beendet ist. Daher werden Sie an alle tieferliegenden von Ihnen 
   die Daten weiterschieben, sobald Sie mit dem Spiegeln von Ihrer 
   Ursprungs-Site fertig sind.
</p>

<p>Sie könen diese Befehle entweder an das Ende Ihres Skriptes 
   <code>anonftpsync</code> anfügen, oder, falls dies bequemer für Sie ist,
   in ein neues Skripte einfügen, und dann das Skript von 
   <code>anonftpsync</code> ausführen lassen, beispielsweise:
</p>

<protect>
<pre>
#!/bin/sh

# Dieses Skript wird von websync gestartet, um Signale an die
# tiefergelegenen Spiegel zu senden.

./signal ein.anderer.Rechner archvsync
./signal ein.weiterer.Rechner Benutzername2
</pre>
</protect>

<p>Falls Sie irgendwelche Probleme damit haben,
<a href="mailto:mirrors@debian.org">kontaktieren</a>
Sie uns (auf Englisch).</p>
