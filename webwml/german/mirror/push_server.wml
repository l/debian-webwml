#use wml::debian::template title="Einrichten eines Push-Spiegel"
#use wml::debian::translation-check translation="1.10"
# $Id$

<p>Einen Push-Spiegel aufzusetzen besteht aus zwei Aufgaben:
Einrichten von rsync-Zugang (für normales, "Pull"-Spiegeln) und
Einrichtung des Trigger-Mechanismusses (für den "pushing"-Teil des
"pull"-Spiegelns).

<p><small>(Wenn Sie genauere Informationen darüber erhalten möchten,
was ein Push-Spiegel ist, lesen Sie bitte <a href="push_mirroring">die
Beschreibung des Push-Spiegelns</a>.)</small>

<h2>rsync einrichten</h2>

<p>Installieren Sie <code>rsync</code> 2.1.1 oder neuer.  Wenn Ihr
Rechner unter Debian läuft, installiesieren Sie einfach das neueste
<a href="http://packages.debian.org/stable/net/rsync.html">rsync</a>-Paket.

<p>Erzeugen Sie die Datei <code>rsyncd.conf</code> und schreiben Sie
etwas ähnliches wie das folgende hinein:

<pre>
uid = nobody
gid = nogroup
max connections = 25
syslog facility = daemon
socket options = SO_KEEPALIVE

[debian]
  path = /org/ftp.debian.org/ftp
  comment = Debian FTP Archive (~24 GB)
  auth users = authorized_account1,authorized_account2,authorized_accountN
  read only = true
  secrets file = /etc/rsyncd/debian.secrets
[debian-web]
  path = /org/www.debian.org/debian.org
  comment = Debian Web Site (~400 MB)
  auth users = authorized_account1,authorized_account2,authorized_accountN
  read only = true
  secrets file = /etc/rsyncd/debian.secrets
</pre>

<p>Fügen Sie einen Eintrag für jeden Rechner zur Datei
<code>/etc/rsyncd/debian.secrets</code> hinzu, bei dem Sie das
Spiegeln einleiten:

<pre>
authorized_account1:ein_paßwort
authorized_account2:noch_ein_paßwort
authorized_accountN:paßwort
</pre>

<p>Sie haben jetzt den in der Hierarchie tiefergelegenen Spiegeln
Zugriff zu Ihrem Rechner erlaubt.

<p>Sie möchten wahrscheinlich den rsync Daemon von inetd aufrufen
lassen.  Um dieses zu erledigen, müssen Sie den rsync-Dienst in die
Datei <code>/etc/services</code> eintragen (falls er dort noch nicht
steht), ungefähr wie folgt:

<pre>
rsync           873/tcp
</pre>

<p>Um den Daemon per inetd anzusprechen, fügen Sie das folgende zu
Ihrer Datei <code>/etc/inetd.conf</code> hinzu:

<pre>
rsync      stream      tcp         nowait      root /usr/bin/rsync rsyncd --daemon
</pre>

(Sie m&uuml;ssen dem inetd anschlie&szlig;end ein HUP-Signal schicken, um
ihm mitzuteilen, da&szlig; die Konfiguration neu eingelesen werden soll).

<h2>Einrichten des SSH-Trigger-Mechanismusses</h2>

<p>Erzeugen Sie einen neuen SSH-Schlüssel für den Account, den Sie
verwenden, um Debian zu spiegeln.  Stellen Sie sicher, daß sie den
eigentlichen SSH-Schlüssel nicht überschreiben, indem Sie die Option
-f verwenden, beispielsweise:

<pre>
ssh-keygen -f ~/.ssh/identity.mysite
</pre>

<p>Stellen Sie sicher, daß der neue öffentliche Schlüssel
(~/.ssh/identity.mysite.pub) folgendes am Dateianfang enthält:

<pre>
no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty,command="~/websync &amp;"
</pre>

<p>(Ersetzen Sie "websync" durch "ftpsync", oder "ftpsync-non-US",
oder wie auch immer der Befehl genannt ist, der das Spiegeln beginnt.)

<p>Sie müssen ein Skript einrichten, das die tiefergelegenen Spiegel
kontaktiert.  Erzeugen Sie eine Datei mit dem Namen
<code>signal</code>, die folgendes enthält:

<protect>
<pre>
#!/bin/sh

# This script is called to signal the remote host that it is time to
# mirror the archive.

echo Signalling $1
ssh -o"BatchMode yes" -o"user $2" "$1" -i $HOME/.ssh/identity.mysite sleep 1
</pre>
</protect>

<p>Dieses Skript wird sich mit dem speziellen SSH-Schlüssel, den Sie
oben erstellt haben, auf einem entfernten Rechner einloggen.  Das
Skript selbst wird nichts sinnvolles auf dem entfernten Rechner
machen, das Programm ~/websync (oder ~/ftpsync, oder ~/ftpsync-non-US)
wird von diesem Schlüssel aus aufgerufen.

<p>Um einen Spiegel tatsächlich zu triggern, müssen Sie Zeilen mit
<code>./signal &lt;site&gt; &lt;username&gt;</code> ans Ende des
eigenen Skripts <code>websync</code> anfügen, oder falls es bequemer
für Sie ist, in ein neues Skript und dieses von <code>websync</code>
aufrufen lassen.

<p>Das neue Skript, <code>runmirrors</code>, würde so etwas wie das
folgende enthalten:

<protect>
<pre>
#!/bin/sh

# This script is called by websync to signal the downstream mirrors.

./signal some.other.site archvsync
./signal and.another.site othersiteaccount
</pre>
</protect>

<p>Sobald Ihr Rechner das Spiegeln vom höhergelegenen Rechner beendet
hat, wird der Rechner die tiefergelegenen Spiegel kontaktieren.

<p>Wenn sie irgendwelche Probleme damit haben, <a href="mailto:mirrors@debian.org">kontaktieren</a>
Sie uns (auf Englisch).
